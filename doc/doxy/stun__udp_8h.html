<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OverSim: stun_udp.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_668dee661430860db5868c2621a9c372.html">src</a>      </li>
      <li><a class="el" href="dir_12590045ec6dcd64f3c4ad499444ef83.html">underlay</a>      </li>
      <li><a class="el" href="dir_e7abd501ef2699b72177966ee598d65b.html">singlehostunderlay</a>      </li>
      <li><a class="el" href="dir_e172c4d23ca9cdab66e1c382ceb2ddaa.html">stun</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<h1>stun_udp.h File Reference</h1>  </div>
</div>
<div class="contents">
<code>#include &lt;errno.h&gt;</code><br/>

<p><a href="stun__udp_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun__udp_8h.html#a25b517a4390903e6fa0f945e80a3394c">WSANOTINITIALISED</a>&nbsp;&nbsp;&nbsp;EPROTONOSUPPORT</td></tr>
<tr><td colspan="2"><h2><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun__udp_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a></td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a> (<a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> fd)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun__udp_8h.html#a604d53fe9d66ce3a47ab2354b20f8e62">getErrno</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000">openPort</a> (unsigned short port, unsigned int interfaceIp, bool verbose)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then use ONLY the interface specified instead of all of them.  <a href="#a44f511e14438aa519a0f367a84de4000"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun__udp_8h.html#a6eef3fdbadd5e5a9de73b7be46ce5aa2">getMessage</a> (<a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> fd, char *buf, int *len, unsigned int *srcIp, unsigned short *srcPort, bool verbose)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">recive a UDP message  <a href="#a6eef3fdbadd5e5a9de73b7be46ce5aa2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun__udp_8h.html#a784917c5dceb731fee666978078b8bc5">sendMessage</a> (<a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> fd, char *msg, int len, unsigned int dstIp, unsigned short dstPort, bool verbose)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">send a UDP message  <a href="#a784917c5dceb731fee666978078b8bc5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun__udp_8h.html#ae0bdce6be1c696c636d5f90f3a295a8f">initNetwork</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">set up network - does nothing in unix but needed for windows  <a href="#ae0bdce6be1c696c636d5f90f3a295a8f"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const <a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> = -1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun__udp_8h.html#a5196d10051a93efa5a7e25054b48c236">STUN_SOCKET_ERROR</a> = -1</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a25b517a4390903e6fa0f945e80a3394c"></a><!-- doxytag: member="stun_udp.h::WSANOTINITIALISED" ref="a25b517a4390903e6fa0f945e80a3394c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define WSANOTINITIALISED&nbsp;&nbsp;&nbsp;EPROTONOSUPPORT</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun__udp_8h_source.html#l00071">71</a> of file <a class="el" href="stun__udp_8h_source.html">stun_udp.h</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00863">stunParseHostName()</a>.</p>

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="af9381320a2640ea84038579d8f143c01"></a><!-- doxytag: member="stun_udp.h::Socket" ref="af9381320a2640ea84038579d8f143c01" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef int <a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun__udp_8h_source.html#l00063">63</a> of file <a class="el" href="stun__udp_8h_source.html">stun_udp.h</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a604d53fe9d66ce3a47ab2354b20f8e62"></a><!-- doxytag: member="stun_udp.h::getErrno" ref="a604d53fe9d66ce3a47ab2354b20f8e62" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int getErrno </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun__udp_8h_source.html#l00069">69</a> of file <a class="el" href="stun__udp_8h_source.html">stun_udp.h</a>.</p>

<p>Referenced by <a class="el" href="udp_8cc_source.html#l00114">getMessage()</a>, <a class="el" href="udp_8cc_source.html#l00038">openPort()</a>, <a class="el" href="udp_8cc_source.html#l00183">sendMessage()</a>, <a class="el" href="stun_8cc_source.html#l01876">stunNatType()</a>, <a class="el" href="stun_8cc_source.html#l00863">stunParseHostName()</a>, and <a class="el" href="stun_8cc_source.html#l01351">stunServerProcess()</a>.</p>

<p><div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> errno; }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6eef3fdbadd5e5a9de73b7be46ce5aa2"></a><!-- doxytag: member="stun_udp.h::getMessage" ref="a6eef3fdbadd5e5a9de73b7be46ce5aa2" args="(Socket fd, char *buf, int *len, unsigned int *srcIp, unsigned short *srcPort, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool getMessage </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a>&nbsp;</td>
          <td class="paramname"> <em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int *&nbsp;</td>
          <td class="paramname"> <em>srcIp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned short *&nbsp;</td>
          <td class="paramname"> <em>srcPort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>recive a UDP message </p>

<p>Definition at line <a class="el" href="udp_8cc_source.html#l00114">114</a> of file <a class="el" href="udp_8cc_source.html">udp.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01876">stunNatType()</a>, <a class="el" href="stun_8cc_source.html#l02247">stunOpenSocket()</a>, <a class="el" href="stun_8cc_source.html#l02314">stunOpenSocketPair()</a>, <a class="el" href="stun_8cc_source.html#l01351">stunServerProcess()</a>, and <a class="el" href="stun_8cc_source.html#l01813">stunTest()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert( fd != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> );

   <span class="keywordtype">int</span> originalSize = *len;
   assert( originalSize &gt; 0 );

   <span class="keyword">struct </span>sockaddr_in from;
   <span class="keywordtype">int</span> fromLen = <span class="keyword">sizeof</span>(from);

   *len = recvfrom(fd,
                   buf,
                   originalSize,
                   0,
                   (<span class="keyword">struct</span> sockaddr *)&amp;from,
                   (socklen_t*)&amp;fromLen);

   <span class="keywordflow">if</span> ( *len == <a class="code" href="stun__udp_8h.html#a5196d10051a93efa5a7e25054b48c236">STUN_SOCKET_ERROR</a> )
   {
      <span class="keywordtype">int</span> err = <a class="code" href="stun__udp_8h.html#a604d53fe9d66ce3a47ab2354b20f8e62">getErrno</a>();

      <span class="keywordflow">switch</span> (err)
      {
         <span class="keywordflow">case</span> ENOTSOCK:
            cerr &lt;&lt; <span class="stringliteral">&quot;Error fd not a socket&quot;</span> &lt;&lt;   endl;
            <span class="keywordflow">break</span>;
         <span class="keywordflow">case</span> ECONNRESET:
            cerr &lt;&lt; <span class="stringliteral">&quot;Error connection reset - host not reachable&quot;</span> &lt;&lt;   endl;
            <span class="keywordflow">break</span>;

         <span class="keywordflow">default</span>:
            cerr &lt;&lt; <span class="stringliteral">&quot;Socket Error=&quot;</span> &lt;&lt; err &lt;&lt; endl;
      }

      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }

   <span class="keywordflow">if</span> ( *len &lt; 0 )
   {
      clog &lt;&lt; <span class="stringliteral">&quot;socket closed? negative len&quot;</span> &lt;&lt; endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }

   <span class="keywordflow">if</span> ( *len == 0 )
   {
      clog &lt;&lt; <span class="stringliteral">&quot;socket closed? zero len&quot;</span> &lt;&lt; endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }

   *srcPort = ntohs(from.sin_port);
   *srcIp = ntohl(from.sin_addr.s_addr);

   <span class="keywordflow">if</span> ( (*len)+1 &gt;= originalSize )
   {
      <span class="keywordflow">if</span> (verbose)
      {
         clog &lt;&lt; <span class="stringliteral">&quot;Received a message that was too large&quot;</span> &lt;&lt; endl;
      }
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   buf[*len]=0;

   <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae0bdce6be1c696c636d5f90f3a295a8f"></a><!-- doxytag: member="stun_udp.h::initNetwork" ref="ae0bdce6be1c696c636d5f90f3a295a8f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void initNetwork </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>set up network - does nothing in unix but needed for windows </p>

<p>Definition at line <a class="el" href="udp_8cc_source.html#l00258">258</a> of file <a class="el" href="udp_8cc_source.html">udp.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>   WORD wVersionRequested = MAKEWORD( 2, 2 );
   WSADATA wsaData;
   <span class="keywordtype">int</span> err;

   err = WSAStartup( wVersionRequested, &amp;wsaData );
   <span class="keywordflow">if</span> ( err != 0 )
   {
      <span class="comment">// could not find a usable WinSock DLL</span>
      cerr &lt;&lt; <span class="stringliteral">&quot;Could not load winsock&quot;</span> &lt;&lt; endl;
      assert(0); <span class="comment">// is this is failing, try a different version that 2.2, 1.0 or later will likely work</span>
      exit(1);
   }

   <span class="comment">/* Confirm that the WinSock DLL supports 2.2.*/</span>
   <span class="comment">/* Note that if the DLL supports versions greater    */</span>
   <span class="comment">/* than 2.2 in addition to 2.2, it will still return */</span>
   <span class="comment">/* 2.2 in wVersion since that is the version we      */</span>
   <span class="comment">/* requested.                                        */</span>

   <span class="keywordflow">if</span> ( LOBYTE( wsaData.wVersion ) != 2 ||
        HIBYTE( wsaData.wVersion ) != 2 )
   {
      <span class="comment">/* Tell the user that we could not find a usable */</span>
      <span class="comment">/* WinSock DLL.                                  */</span>
      WSACleanup( );
      cerr &lt;&lt; <span class="stringliteral">&quot;Bad winsock verion&quot;</span> &lt;&lt; endl;
      assert(0); <span class="comment">// is this is failing, try a different version that 2.2, 1.0 or later will likely work</span>
      exit(1);
   }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a44f511e14438aa519a0f367a84de4000"></a><!-- doxytag: member="stun_udp.h::openPort" ref="a44f511e14438aa519a0f367a84de4000" args="(unsigned short port, unsigned int interfaceIp, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> openPort </td>
          <td>(</td>
          <td class="paramtype">unsigned short&nbsp;</td>
          <td class="paramname"> <em>port</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>interfaceIp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then use ONLY the interface specified instead of all of them. </p>

<p>Definition at line <a class="el" href="udp_8cc_source.html#l00038">38</a> of file <a class="el" href="udp_8cc_source.html">udp.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01249">stunInitServer()</a>, <a class="el" href="stun_8cc_source.html#l01876">stunNatType()</a>, <a class="el" href="stun_8cc_source.html#l02247">stunOpenSocket()</a>, <a class="el" href="stun_8cc_source.html#l02314">stunOpenSocketPair()</a>, <a class="el" href="stun_8cc_source.html#l01351">stunServerProcess()</a>, and <a class="el" href="stun_8cc_source.html#l01813">stunTest()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <a class="code" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> fd;

   fd = socket(PF_INET, SOCK_DGRAM, IPPROTO_UDP);
   <span class="keywordflow">if</span> ( fd == <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> )
   {
      <span class="keywordtype">int</span> err = <a class="code" href="stun__udp_8h.html#a604d53fe9d66ce3a47ab2354b20f8e62">getErrno</a>();
      cerr &lt;&lt; <span class="stringliteral">&quot;Could not create a UDP socket:&quot;</span> &lt;&lt; err &lt;&lt; endl;
      <span class="keywordflow">return</span> <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;
   }

   <span class="keyword">struct </span>sockaddr_in addr;
   memset((<span class="keywordtype">char</span>*) &amp;(addr),0, <span class="keyword">sizeof</span>((addr)));
   addr.sin_family = AF_INET;
   addr.sin_addr.s_addr = htonl(INADDR_ANY);
   addr.sin_port = htons(port);

   <span class="keywordflow">if</span> ( (interfaceIp != 0) &amp;&amp;
        ( interfaceIp != 0x100007f ) )
   {
      addr.sin_addr.s_addr = htonl(interfaceIp);
      <span class="keywordflow">if</span> (verbose )
      {
         clog &lt;&lt; <span class="stringliteral">&quot;Binding to interface &quot;</span>
              &lt;&lt; hex &lt;&lt; <span class="stringliteral">&quot;0x&quot;</span> &lt;&lt; htonl(interfaceIp) &lt;&lt; dec &lt;&lt; endl;
      }
   }

   <span class="keywordflow">if</span> ( bind( fd,(<span class="keyword">struct</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr)) != 0 )
   {
      <span class="keywordtype">int</span> e = <a class="code" href="stun__udp_8h.html#a604d53fe9d66ce3a47ab2354b20f8e62">getErrno</a>();

      <span class="keywordflow">switch</span> (e)
      {
         <span class="keywordflow">case</span> 0:
         {
            cerr &lt;&lt; <span class="stringliteral">&quot;Could not bind socket&quot;</span> &lt;&lt; endl;
            <span class="keywordflow">return</span> <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;
         }
         <span class="keywordflow">case</span> EADDRINUSE:
         {
            cerr &lt;&lt; <span class="stringliteral">&quot;Port &quot;</span> &lt;&lt; port &lt;&lt; <span class="stringliteral">&quot; for receiving UDP is in use&quot;</span> &lt;&lt; endl;
            <span class="keywordflow">return</span> <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;
         }
         <span class="keywordflow">break</span>;
         <span class="keywordflow">case</span> EADDRNOTAVAIL:
         {
            <span class="keywordflow">if</span> ( verbose )
            {
               cerr &lt;&lt; <span class="stringliteral">&quot;Cannot assign requested address&quot;</span> &lt;&lt; endl;
            }
            <span class="keywordflow">return</span> <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;
         }
         <span class="keywordflow">break</span>;
         <span class="keywordflow">default</span>:
         {
            cerr &lt;&lt; <span class="stringliteral">&quot;Could not bind UDP receive port&quot;</span>
                 &lt;&lt; <span class="stringliteral">&quot;Error=&quot;</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; strerror(e) &lt;&lt; endl;
            <span class="keywordflow">return</span> <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;
         }
         <span class="keywordflow">break</span>;
      }
   }
   <span class="keywordflow">if</span> ( verbose )
   {
      clog &lt;&lt; <span class="stringliteral">&quot;Opened port &quot;</span> &lt;&lt; port &lt;&lt; <span class="stringliteral">&quot; with fd &quot;</span> &lt;&lt; fd &lt;&lt; endl;
   }

   assert( fd != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>  );

   <span class="keywordflow">return</span> fd;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a784917c5dceb731fee666978078b8bc5"></a><!-- doxytag: member="stun_udp.h::sendMessage" ref="a784917c5dceb731fee666978078b8bc5" args="(Socket fd, char *msg, int len, unsigned int dstIp, unsigned short dstPort, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sendMessage </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a>&nbsp;</td>
          <td class="paramname"> <em>fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>dstIp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned short&nbsp;</td>
          <td class="paramname"> <em>dstPort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>send a UDP message </p>

<p>Definition at line <a class="el" href="udp_8cc_source.html#l00183">183</a> of file <a class="el" href="udp_8cc_source.html">udp.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01734">stunSendTest()</a>, and <a class="el" href="stun_8cc_source.html#l01351">stunServerProcess()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert( fd != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> );

   <span class="keywordtype">int</span> s;
   <span class="keywordflow">if</span> ( dstPort == 0 )
   {
      <span class="comment">// sending on a connected port</span>
      assert( dstIp == 0 );

      s = send(fd,buf,l,0);
   }
   <span class="keywordflow">else</span>
   {
      assert( dstIp != 0 );
      assert( dstPort != 0 );

      <span class="keyword">struct </span>sockaddr_in to;
      <span class="keywordtype">int</span> toLen = <span class="keyword">sizeof</span>(to);
      memset(&amp;to,0,toLen);

      to.sin_family = AF_INET;
      to.sin_port = htons(dstPort);
      to.sin_addr.s_addr = htonl(dstIp);

      s = sendto(fd, buf, l, 0,(sockaddr*)&amp;to, toLen);
   }

   <span class="keywordflow">if</span> ( s == <a class="code" href="stun__udp_8h.html#a5196d10051a93efa5a7e25054b48c236">STUN_SOCKET_ERROR</a> )
   {
      <span class="keywordtype">int</span> e = <a class="code" href="stun__udp_8h.html#a604d53fe9d66ce3a47ab2354b20f8e62">getErrno</a>();
      <span class="keywordflow">switch</span> (e)
      {
         <span class="keywordflow">case</span> ECONNREFUSED:
         <span class="keywordflow">case</span> EHOSTDOWN:
         <span class="keywordflow">case</span> EHOSTUNREACH:
         {
            <span class="comment">// quietly ignore this</span>
         }
         <span class="keywordflow">break</span>;
         <span class="keywordflow">case</span> EAFNOSUPPORT:
         {
            cerr &lt;&lt; <span class="stringliteral">&quot;err EAFNOSUPPORT in send&quot;</span> &lt;&lt; endl;
         }
         <span class="keywordflow">break</span>;
         <span class="keywordflow">default</span>:
         {
            cerr &lt;&lt; <span class="stringliteral">&quot;err &quot;</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">&quot; &quot;</span>  &lt;&lt; strerror(e) &lt;&lt; <span class="stringliteral">&quot; in send&quot;</span> &lt;&lt; endl;
         }
      }
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }

   <span class="keywordflow">if</span> ( s == 0 )
   {
      cerr &lt;&lt; <span class="stringliteral">&quot;no data sent in send&quot;</span> &lt;&lt; endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }

   <span class="keywordflow">if</span> ( s != l )
   {
      <span class="keywordflow">if</span> (verbose)
      {
         cerr &lt;&lt; <span class="stringliteral">&quot;only &quot;</span> &lt;&lt; s &lt;&lt; <span class="stringliteral">&quot; out of &quot;</span> &lt;&lt; l &lt;&lt; <span class="stringliteral">&quot; bytes sent&quot;</span> &lt;&lt; endl;
      }
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }

   <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a79746e37503e1405951088e144510b79"></a><!-- doxytag: member="stun_udp.h::stunclosesocket" ref="a79746e37503e1405951088e144510b79" args="(Socket fd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int stunclosesocket </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a>&nbsp;</td>
          <td class="paramname"> <em>fd</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun__udp_8h_source.html#l00067">67</a> of file <a class="el" href="stun__udp_8h_source.html">stun_udp.h</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01630">stunFindLocalInterfaces()</a>, <a class="el" href="stun_8cc_source.html#l01876">stunNatType()</a>, <a class="el" href="stun_8cc_source.html#l02314">stunOpenSocketPair()</a>, <a class="el" href="stun_8cc_source.html#l00651">stunRand()</a>, <a class="el" href="stun_8cc_source.html#l01351">stunServerProcess()</a>, and <a class="el" href="stun_8cc_source.html#l01328">stunStopServer()</a>.</p>

<p><div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> close(fd); };
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ab095a168e3ee3fb25930ad2f03d4242b"></a><!-- doxytag: member="stun_udp.h::STUN_INVALID_SOCKET" ref="ab095a168e3ee3fb25930ad2f03d4242b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> <a class="el" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> = -1<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun__udp_8h_source.html#l00064">64</a> of file <a class="el" href="stun__udp_8h_source.html">stun_udp.h</a>.</p>

<p>Referenced by <a class="el" href="udp_8cc_source.html#l00114">getMessage()</a>, <a class="el" href="udp_8cc_source.html#l00038">openPort()</a>, <a class="el" href="udp_8cc_source.html#l00183">sendMessage()</a>, <a class="el" href="stun_8cc_source.html#l01249">stunInitServer()</a>, <a class="el" href="stun_8cc_source.html#l01876">stunNatType()</a>, <a class="el" href="stun_8cc_source.html#l02247">stunOpenSocket()</a>, and <a class="el" href="stun_8cc_source.html#l01351">stunServerProcess()</a>.</p>

</div>
</div>
<a class="anchor" id="a5196d10051a93efa5a7e25054b48c236"></a><!-- doxytag: member="stun_udp.h::STUN_SOCKET_ERROR" ref="a5196d10051a93efa5a7e25054b48c236" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const int <a class="el" href="stun__udp_8h.html#a5196d10051a93efa5a7e25054b48c236">STUN_SOCKET_ERROR</a> = -1<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun__udp_8h_source.html#l00065">65</a> of file <a class="el" href="stun__udp_8h_source.html">stun_udp.h</a>.</p>

<p>Referenced by <a class="el" href="udp_8cc_source.html#l00114">getMessage()</a>, <a class="el" href="udp_8cc_source.html#l00183">sendMessage()</a>, and <a class="el" href="stun_8cc_source.html#l01876">stunNatType()</a>.</p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 3 2010 14:40:46 for OverSim by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
