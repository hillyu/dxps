<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OverSim: Vast.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_668dee661430860db5868c2621a9c372.html">src</a>      </li>
      <li><a class="el" href="dir_6302e9405fe106175d386473fd676d2e.html">overlay</a>      </li>
      <li><a class="el" href="dir_47e78cdcf474fa8d90933e092c1b964b.html">vast</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Vast.cc</h1>  </div>
</div>
<div class="contents">
<a href="Vast_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright (C) 2006 Institut fuer Telematik, Universitaet Karlsruhe (TH)</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment">// modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment">// as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment">// of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment">// This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment">// GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment">//</span>
<a name="l00014"></a>00014 <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment">// along with this program; if not, write to the Free Software</span>
<a name="l00016"></a>00016 <span class="comment">// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00018"></a>00018 
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="Vast_8h.html">Vast.h</a>&quot;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <a class="code" href="ALMTest_8cc.html#a3b5014f410c7989e8bad4b467ecc94cd">Define_Module</a>(<a class="code" href="classVast.html" title="Voronoi class.">Vast</a>);
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;NotifierConsts.h&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="code" href="GlobalNodeList_8h.html">GlobalNodeList.h</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="GlobalStatistics_8h.html">GlobalStatistics.h</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="BootstrapList_8h.html">BootstrapList.h</a>&gt;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="classVast.html#a9146368d63151277c8442a17afe8d1d6">00034</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a9146368d63151277c8442a17afe8d1d6" title="Initializes derived-class-attributes.">Vast::initializeOverlay</a>(<span class="keywordtype">int</span> stage)
<a name="l00035"></a>00035 {
<a name="l00036"></a>00036     <span class="comment">// because of IPAddressResolver, we need to wait until interfaces are registered,</span>
<a name="l00037"></a>00037     <span class="comment">// address auto-assignment takes place etc.</span>
<a name="l00038"></a>00038     <span class="keywordflow">if</span>(stage != <a class="code" href="InitStages_8h.html#a42fde1aa1e14a1c45d29061d6e87e532a58e83c497c7c8495e9c592ff3148b6b9" title="first stage for overlay modules (Tier 0 / KBR)">MIN_STAGE_OVERLAY</a>) <span class="keywordflow">return</span>;
<a name="l00039"></a>00039 
<a name="l00040"></a>00040     <span class="comment">// fetch parameters</span>
<a name="l00041"></a>00041     <a class="code" href="classVast.html#a9a5f4a33b22c8d78fef399b1041cb333">debugVoronoiOutput</a> = par(<span class="stringliteral">&quot;debugVastOutput&quot;</span>);
<a name="l00042"></a>00042     <a class="code" href="classVast.html#afdc6b6327442ee54b2a92c930966aae6">areaDimension</a> = par(<span class="stringliteral">&quot;areaDimension&quot;</span>);
<a name="l00043"></a>00043     <a class="code" href="classVast.html#a4720ff97b3ca3a6f53b9533f57a4fb56">AOI_size</a> = par(<span class="stringliteral">&quot;AOIWidth&quot;</span>);
<a name="l00044"></a>00044     <a class="code" href="classVast.html#a2218f4c5c055326aeb59640acaf3b91c">joinTimeout</a> = par(<span class="stringliteral">&quot;joinTimeout&quot;</span>);
<a name="l00045"></a>00045     <a class="code" href="classVast.html#ad79f8a786033cb62653286f8cc5015e5">pingTimeout</a> = par(<span class="stringliteral">&quot;pingTimeout&quot;</span>);
<a name="l00046"></a>00046     <a class="code" href="classVast.html#a9b5faa39bdba0cbc3da3a588173e3c1f">discoveryIntervall</a> = par(<span class="stringliteral">&quot;discoveryIntervall&quot;</span>);
<a name="l00047"></a>00047     <a class="code" href="classVast.html#a7cf9fae4a48173e8e28a117f568027fb">checkCriticalIntervall</a> = par(<span class="stringliteral">&quot;criticalCheckIntervall&quot;</span>);
<a name="l00048"></a>00048     <a class="code" href="classVast.html#ab68ac286673ed0ae4e2e05215481d667">criticalThreshold</a> = par(<span class="stringliteral">&quot;criticalThreshold&quot;</span>);
<a name="l00049"></a>00049     <a class="code" href="classVast.html#a4d00a0a50dd92e3d223b4f4599bc82c3">stockListSize</a> = par(<span class="stringliteral">&quot;stockListSize&quot;</span>);
<a name="l00050"></a>00050 
<a name="l00051"></a>00051     <span class="comment">// set node key</span>
<a name="l00052"></a>00052     <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#af3992f1fda9ea42dc10bf4739e47700a" title="saves given key to NodeHandle::key">setKey</a>(<a class="code" href="classOverlayKey.html#a1983e1b47e32783f8ccd5e59fe725290" title="Returns a random key.">OverlayKey::random</a>());
<a name="l00053"></a>00053     <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a8285244e3eb082cd382c6971b56066a9">type</a> = THIS;
<a name="l00054"></a>00054     <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a> = <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>;
<a name="l00055"></a>00055 
<a name="l00056"></a>00056     <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#aaac2706d430cac4882368a42993f42c9">setDebug</a>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>);
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     <span class="comment">// self-messages</span>
<a name="l00059"></a>00059     <a class="code" href="classVast.html#a5679f28e0a58927ef5e707f8eafd9473">join_timer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;join_timer&quot;</span>);
<a name="l00060"></a>00060     <a class="code" href="classVast.html#a34548c8fe764d86196e99f3bd8d5b793">ping_timer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;ping_timer&quot;</span>);
<a name="l00061"></a>00061     <a class="code" href="classVast.html#aff47bd08fb10c41ec16862934b098a4b">sec_timer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;sec_timer&quot;</span>);
<a name="l00062"></a>00062     <a class="code" href="classVast.html#a12f4439d33e9d3f8928c5cc81f36a141">discovery_timer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;discovery_timer&quot;</span>);
<a name="l00063"></a>00063     <a class="code" href="classVast.html#a6da2c953a461445f77d16764f3545e6e">checkcritical_timer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;checkcritical_timer&quot;</span>);
<a name="l00064"></a>00064 
<a name="l00065"></a>00065     <span class="comment">// statistics</span>
<a name="l00066"></a>00066     <a class="code" href="classVast.html#a8cae35144fc3d3615ca900f4a5d016f5">joinRequestBytesSent</a> = 0;
<a name="l00067"></a>00067     <a class="code" href="classVast.html#af1b66db4acda86bc53121f530ad3305f">joinAcknowledgeBytesSent</a> = 0;
<a name="l00068"></a>00068     <a class="code" href="classVast.html#ae7e6d853f952734f8e1c41d5c3f82dd3">nodeMoveBytesSent</a> = 0;
<a name="l00069"></a>00069     <a class="code" href="classVast.html#a0bb1c36ab41d09526a7b54433b2a1f54">newNeighborsBytesSent</a> = 0;
<a name="l00070"></a>00070     <a class="code" href="classVast.html#aec8877ef5725ece7aa4f1e7dc6ec47c6">nodeLeaveBytesSent</a> = 0;
<a name="l00071"></a>00071     <a class="code" href="classVast.html#a42fa22094150446e8b0d2e2e2c58ef02">enclosingNeighborsRequestBytesSent</a> = 0;
<a name="l00072"></a>00072     <a class="code" href="classVast.html#afea7ca8faed771a898b0daa3cffafeeb">pingBytesSent</a> = 0;
<a name="l00073"></a>00073     <a class="code" href="classVast.html#af8a09f477664314710211ec69de5944f">pongBytesSent</a> = 0;
<a name="l00074"></a>00074     <a class="code" href="classVast.html#a53543eccb1be540b3d7875cf0cdd0b52">discardNodeBytesSent</a> = 0;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     <a class="code" href="classVast.html#aea94419d8d7589930d1b2e1b4de0468d">maxBytesPerSecondSent</a> = 0;
<a name="l00077"></a>00077     <a class="code" href="classVast.html#a90f9ed7d27fee143970e838e2a7bea15">averageBytesPerSecondSent</a> = 0;
<a name="l00078"></a>00078     <a class="code" href="classVast.html#af30ae27611d3b281fb3a7f16b329f539">bytesPerSecond</a> = 0;
<a name="l00079"></a>00079     <a class="code" href="classVast.html#a120c3c82cafcab0a237fe080e71a4862">secTimerCount</a> = 0;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     <span class="comment">// watch some variables</span>
<a name="l00082"></a>00082     WATCH(<a class="code" href="classVast.html#a4720ff97b3ca3a6f53b9533f57a4fb56">AOI_size</a>);
<a name="l00083"></a>00083     WATCH(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>);
<a name="l00084"></a>00084     WATCH_MAP(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>);
<a name="l00085"></a>00085     WATCH_SET(<a class="code" href="classVast.html#a72ef8a625cc4c37c0513fc842bd09470">Positions</a>);
<a name="l00086"></a>00086 
<a name="l00087"></a>00087     WATCH(<a class="code" href="classVast.html#a8cae35144fc3d3615ca900f4a5d016f5">joinRequestBytesSent</a>);
<a name="l00088"></a>00088     WATCH(<a class="code" href="classVast.html#af1b66db4acda86bc53121f530ad3305f">joinAcknowledgeBytesSent</a>);
<a name="l00089"></a>00089     WATCH(<a class="code" href="classVast.html#ae7e6d853f952734f8e1c41d5c3f82dd3">nodeMoveBytesSent</a>);
<a name="l00090"></a>00090     WATCH(<a class="code" href="classVast.html#a0bb1c36ab41d09526a7b54433b2a1f54">newNeighborsBytesSent</a>);
<a name="l00091"></a>00091     WATCH(<a class="code" href="classVast.html#aec8877ef5725ece7aa4f1e7dc6ec47c6">nodeLeaveBytesSent</a>);
<a name="l00092"></a>00092     WATCH(<a class="code" href="classVast.html#a42fa22094150446e8b0d2e2e2c58ef02">enclosingNeighborsRequestBytesSent</a>);
<a name="l00093"></a>00093     WATCH(<a class="code" href="classVast.html#afea7ca8faed771a898b0daa3cffafeeb">pingBytesSent</a>);
<a name="l00094"></a>00094     WATCH(<a class="code" href="classVast.html#af8a09f477664314710211ec69de5944f">pongBytesSent</a>);
<a name="l00095"></a>00095     WATCH(<a class="code" href="classVast.html#a53543eccb1be540b3d7875cf0cdd0b52">discardNodeBytesSent</a>);
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     WATCH(<a class="code" href="classVast.html#aea94419d8d7589930d1b2e1b4de0468d">maxBytesPerSecondSent</a>);
<a name="l00098"></a>00098     WATCH(<a class="code" href="classVast.html#af30ae27611d3b281fb3a7f16b329f539">bytesPerSecond</a>);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="comment">// set initial state</span>
<a name="l00101"></a>00101     <a class="code" href="classVast.html#a9f49980680ed52219a6ef0a1bcff412b">changeState</a>(<a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa4c1b397f6c4682baf7db280e7f15520a">INIT</a>);
<a name="l00102"></a>00102     <a class="code" href="classVast.html#a9f49980680ed52219a6ef0a1bcff412b">changeState</a>(<a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fabe22ce6e9471e472a566ba6cc27fbb5a">JOINING</a>);
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="classVast.html#a9f49980680ed52219a6ef0a1bcff412b">00105</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a9f49980680ed52219a6ef0a1bcff412b">Vast::changeState</a>(<span class="keywordtype">int</span> state)
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107     <span class="keywordflow">switch</span>(state) {
<a name="l00108"></a>00108         <span class="keywordflow">case</span> <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa4c1b397f6c4682baf7db280e7f15520a">INIT</a>: {
<a name="l00109"></a>00109             this-&gt;state = INIT;
<a name="l00110"></a>00110             <a class="code" href="classBaseOverlay.html#a933e505ea77cae4ab0c8edcb77ade2c7" title="pointer to GlobalNodeList in this node">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#a95a2d64d3d19185ae4e2f24ec13ee5d4" title="Debootstraps peers in the peer set.">removePeer</a>(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>);
<a name="l00111"></a>00111             cancelEvent(<a class="code" href="classVast.html#a5679f28e0a58927ef5e707f8eafd9473">join_timer</a>);
<a name="l00112"></a>00112             cancelEvent(<a class="code" href="classVast.html#a34548c8fe764d86196e99f3bd8d5b793">ping_timer</a>);
<a name="l00113"></a>00113             cancelEvent(<a class="code" href="classVast.html#aff47bd08fb10c41ec16862934b098a4b">sec_timer</a>);
<a name="l00114"></a>00114             cancelEvent(<a class="code" href="classVast.html#a12f4439d33e9d3f8928c5cc81f36a141">discovery_timer</a>);
<a name="l00115"></a>00115             cancelEvent(<a class="code" href="classVast.html#a6da2c953a461445f77d16764f3545e6e">checkcritical_timer</a>);
<a name="l00116"></a>00116         } <span class="keywordflow">break</span>;
<a name="l00117"></a>00117         <span class="keywordflow">case</span> <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fabe22ce6e9471e472a566ba6cc27fbb5a">JOINING</a>: {
<a name="l00118"></a>00118             this-&gt;state = JOINING;
<a name="l00119"></a>00119             scheduleAt(simTime(), <a class="code" href="classVast.html#a5679f28e0a58927ef5e707f8eafd9473">join_timer</a>);
<a name="l00120"></a>00120             scheduleAt(simTime() + 1.0, <a class="code" href="classVast.html#aff47bd08fb10c41ec16862934b098a4b">sec_timer</a>);
<a name="l00121"></a>00121         } <span class="keywordflow">break</span>;
<a name="l00122"></a>00122         <span class="keywordflow">case</span> <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>: {
<a name="l00123"></a>00123             this-&gt;state = READY;
<a name="l00124"></a>00124             cancelEvent(<a class="code" href="classVast.html#a5679f28e0a58927ef5e707f8eafd9473">join_timer</a>);
<a name="l00125"></a>00125             <a class="code" href="classBaseOverlay.html#a933e505ea77cae4ab0c8edcb77ade2c7" title="pointer to GlobalNodeList in this node">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#add76d38932795a481196e5504c5ee98e" title="Bootstraps peers in the peer set.">registerPeer</a>(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>);
<a name="l00126"></a>00126             scheduleAt(simTime() + <a class="code" href="classVast.html#ad79f8a786033cb62653286f8cc5015e5">pingTimeout</a>, <a class="code" href="classVast.html#a34548c8fe764d86196e99f3bd8d5b793">ping_timer</a>);
<a name="l00127"></a>00127             <span class="keywordflow">if</span>(<a class="code" href="classVast.html#a7cf9fae4a48173e8e28a117f568027fb">checkCriticalIntervall</a> &gt; 0.0 &amp;&amp; <a class="code" href="classVast.html#a9b5faa39bdba0cbc3da3a588173e3c1f">discoveryIntervall</a> &gt; 0.0) {
<a name="l00128"></a>00128                 scheduleAt(simTime() + <a class="code" href="classVast.html#a7cf9fae4a48173e8e28a117f568027fb">checkCriticalIntervall</a>, <a class="code" href="classVast.html#a6da2c953a461445f77d16764f3545e6e">checkcritical_timer</a>);
<a name="l00129"></a>00129                 scheduleAt(simTime() + <a class="code" href="classVast.html#a9b5faa39bdba0cbc3da3a588173e3c1f">discoveryIntervall</a>, <a class="code" href="classVast.html#a12f4439d33e9d3f8928c5cc81f36a141">discovery_timer</a>);
<a name="l00130"></a>00130             }
<a name="l00131"></a>00131             <span class="comment">// tell the application we are ready</span>
<a name="l00132"></a>00132             <a class="code" href="classCompReadyMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">CompReadyMessage</a>* readyMsg = <span class="keyword">new</span> <a class="code" href="classCompReadyMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">CompReadyMessage</a>(<span class="stringliteral">&quot;OVERLAY_READY&quot;</span>);
<a name="l00133"></a>00133             readyMsg-&gt;<a class="code" href="classCompReadyMessage.html#ac5158504d6b97a32974f14c9b1a7a662">setReady</a>(<span class="keyword">true</span>);
<a name="l00134"></a>00134             readyMsg-&gt;<a class="code" href="classCompReadyMessage.html#ad9a52c5f788e0c11a75bbb5df3855ac0">setComp</a>(<a class="code" href="classBaseOverlay.html#a92e0d3f96a5716245465e05da60ef487">getThisCompType</a>());
<a name="l00135"></a>00135             <a class="code" href="classVast.html#ad3da9d482e3f5e50e0555cb561805320">sendToApp</a>(readyMsg);
<a name="l00136"></a>00136             <a class="code" href="classGameAPIResizeAOIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIResizeAOIMessage</a>* gameMsg = <span class="keyword">new</span> <a class="code" href="classGameAPIResizeAOIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIResizeAOIMessage</a>(<span class="stringliteral">&quot;RESIZE_AOI&quot;</span>);
<a name="l00137"></a>00137             gameMsg-&gt;<a class="code" href="classGameAPIMessage.html#a3c12a88e720037a70248b0db6a46fc99">setCommand</a>(<a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba04223e5523bbf330b2553e5ba3e320d1">RESIZE_AOI</a>);
<a name="l00138"></a>00138             gameMsg-&gt;<a class="code" href="classGameAPIResizeAOIMessage.html#a8fc4ba8f739fae9c8f24eae1482271c3">setAOIsize</a>(<a class="code" href="classVast.html#a4720ff97b3ca3a6f53b9533f57a4fb56">AOI_size</a>);
<a name="l00139"></a>00139             <a class="code" href="classVast.html#ad3da9d482e3f5e50e0555cb561805320">sendToApp</a>(gameMsg);
<a name="l00140"></a>00140         } <span class="keywordflow">break</span>;
<a name="l00141"></a>00141     }
<a name="l00142"></a>00142     <a class="code" href="classVast.html#a1bfee43b8a5cde362b7ff137f3597c78">setBootstrapedIcon</a>();
<a name="l00143"></a>00143     <span class="comment">// debug output</span>
<a name="l00144"></a>00144     <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l00145"></a>00145         EV &lt;&lt; <span class="stringliteral">&quot;[Vast::changeState() @ &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00146"></a>00146            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00147"></a>00147            &lt;&lt; <span class="stringliteral">&quot;VAST: Node &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; entered &quot;</span>;
<a name="l00148"></a>00148         <span class="keywordflow">switch</span>(state) {
<a name="l00149"></a>00149             <span class="keywordflow">case</span> <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa4c1b397f6c4682baf7db280e7f15520a">INIT</a>: ev &lt;&lt; <span class="stringliteral">&quot;INIT&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00150"></a>00150             <span class="keywordflow">case</span> <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fabe22ce6e9471e472a566ba6cc27fbb5a">JOINING</a>: ev &lt;&lt; <span class="stringliteral">&quot;JOINING&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00151"></a>00151             <span class="keywordflow">case</span> <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>: ev &lt;&lt; <span class="stringliteral">&quot;READY&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00152"></a>00152         }
<a name="l00153"></a>00153         ev &lt;&lt; <span class="stringliteral">&quot; state.&quot;</span> &lt;&lt; endl;
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 
<a name="l00157"></a><a class="code" href="classVast.html#a8b0fcea2fc373e49bb5b496fe8049f10">00157</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a8b0fcea2fc373e49bb5b496fe8049f10">Vast::handleTimerEvent</a>(cMessage* msg)
<a name="l00158"></a>00158 {
<a name="l00159"></a>00159     <span class="keywordflow">if</span>(msg-&gt;isName(<span class="stringliteral">&quot;join_timer&quot;</span>)) {
<a name="l00160"></a>00160         <span class="comment">//reset timer</span>
<a name="l00161"></a>00161         cancelEvent(<a class="code" href="classVast.html#a5679f28e0a58927ef5e707f8eafd9473">join_timer</a>);
<a name="l00162"></a>00162         scheduleAt(simTime() + <a class="code" href="classVast.html#a2218f4c5c055326aeb59640acaf3b91c">joinTimeout</a>, msg);
<a name="l00163"></a>00163         <span class="comment">// handle event</span>
<a name="l00164"></a>00164         <a class="code" href="classVast.html#aa54887a2c280267a9a401e50c240f6d5">processJoinTimer</a>();
<a name="l00165"></a>00165     }
<a name="l00166"></a>00166     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(msg-&gt;isName(<span class="stringliteral">&quot;ping_timer&quot;</span>)) {
<a name="l00167"></a>00167         <span class="comment">//reset timer</span>
<a name="l00168"></a>00168         cancelEvent(<a class="code" href="classVast.html#a34548c8fe764d86196e99f3bd8d5b793">ping_timer</a>);
<a name="l00169"></a>00169         scheduleAt(simTime() + <a class="code" href="classVast.html#ad79f8a786033cb62653286f8cc5015e5">pingTimeout</a>, msg);
<a name="l00170"></a>00170         <span class="comment">// handle event</span>
<a name="l00171"></a>00171         <a class="code" href="classVast.html#af30893315b517cde6403ebf5a0aca8af">processPingTimer</a>();
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(msg-&gt;isName(<span class="stringliteral">&quot;sec_timer&quot;</span>)) {
<a name="l00174"></a>00174         <span class="comment">//reset timer</span>
<a name="l00175"></a>00175         cancelEvent(<a class="code" href="classVast.html#aff47bd08fb10c41ec16862934b098a4b">sec_timer</a>);
<a name="l00176"></a>00176         scheduleAt(simTime() + 1, msg);
<a name="l00177"></a>00177         <span class="comment">// handle event</span>
<a name="l00178"></a>00178         <a class="code" href="classVast.html#a0eadb10fa255a3a2b89b1296d87be07d">processSecTimer</a>();
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(msg-&gt;isName(<span class="stringliteral">&quot;checkcritical_timer&quot;</span>)) {
<a name="l00181"></a>00181         <span class="comment">//reset timer</span>
<a name="l00182"></a>00182         cancelEvent(<a class="code" href="classVast.html#a6da2c953a461445f77d16764f3545e6e">checkcritical_timer</a>);
<a name="l00183"></a>00183         scheduleAt(simTime() + <a class="code" href="classVast.html#a7cf9fae4a48173e8e28a117f568027fb">checkCriticalIntervall</a>, msg);
<a name="l00184"></a>00184         <span class="comment">// handle event</span>
<a name="l00185"></a>00185         <a class="code" href="classVast.html#a1297368d6e59e3d9528b082f5ec043f4">processCheckCriticalTimer</a>();
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(msg-&gt;isName(<span class="stringliteral">&quot;discovery_timer&quot;</span>)) {
<a name="l00188"></a>00188         <span class="comment">//reset timer</span>
<a name="l00189"></a>00189         cancelEvent(<a class="code" href="classVast.html#a12f4439d33e9d3f8928c5cc81f36a141">discovery_timer</a>);
<a name="l00190"></a>00190         scheduleAt(simTime() + <a class="code" href="classVast.html#a9b5faa39bdba0cbc3da3a588173e3c1f">discoveryIntervall</a>, msg);
<a name="l00191"></a>00191         <span class="comment">// handle event</span>
<a name="l00192"></a>00192         <a class="code" href="classVast.html#a3e41736afd958b63b754c0bcc425cbfe">processDiscoveryTimer</a>();
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="classVast.html#a9bfca7e546baa11222621b528659efa7">00196</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a9bfca7e546baa11222621b528659efa7" title="Processes &amp;quot;timer&amp;quot; self-messages.">Vast::handleAppMessage</a>(cMessage* msg)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     <span class="keywordflow">if</span>(dynamic_cast&lt;GameAPIMessage*&gt;(msg)) {
<a name="l00199"></a>00199         <a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a>* gameAPIMsg = check_and_cast&lt;<a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a>*&gt;(msg);
<a name="l00200"></a>00200         <span class="comment">// debug output</span>
<a name="l00201"></a>00201         <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) EV &lt;&lt; <span class="stringliteral">&quot;[Vast::handleAppMessage() @ &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00202"></a>00202                            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00203"></a>00203                            &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; received &quot;</span> &lt;&lt; gameAPIMsg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; from application.&quot;</span>
<a name="l00204"></a>00204                            &lt;&lt; endl;
<a name="l00205"></a>00205         <span class="keywordflow">switch</span>(gameAPIMsg-&gt;<a class="code" href="classGameAPIMessage.html#a310b7731f5d78aa25d103594d88d0edd">getCommand</a>()) {
<a name="l00206"></a>00206             <span class="keywordflow">case</span> <a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba7a7dbf862295be01b326c1d51e73d875">MOVEMENT_INDICATION</a>: {
<a name="l00207"></a>00207                 <a class="code" href="classGameAPIPositionMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIPositionMessage</a>* gameAPIPosMsg = check_and_cast&lt;<a class="code" href="classGameAPIPositionMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIPositionMessage</a>*&gt;(msg);
<a name="l00208"></a>00208                 <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fabe22ce6e9471e472a566ba6cc27fbb5a">JOINING</a>) {
<a name="l00209"></a>00209                     <a class="code" href="classVast.html#a25469658017340ae776e74d966ba5f54">handleJoin</a>(gameAPIPosMsg);
<a name="l00210"></a>00210                     <span class="keyword">delete</span> msg;
<a name="l00211"></a>00211                 }
<a name="l00212"></a>00212                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>) {
<a name="l00213"></a>00213                     <a class="code" href="classVast.html#a092f27883a3661a5b1ffe905e68df738">handleMove</a>(gameAPIPosMsg);
<a name="l00214"></a>00214                     <span class="keyword">delete</span> msg;
<a name="l00215"></a>00215                 }
<a name="l00216"></a>00216             } <span class="keywordflow">break</span>;
<a name="l00217"></a>00217             <span class="keywordflow">case</span> <a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba2d637d8d63fd5cc1921d781389e7482c">GAMEEVENT_CHAT</a>:
<a name="l00218"></a>00218             <span class="keywordflow">case</span> <a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba94d7bea1985e12fde4c9b7ba389a59c7">GAMEEVENT_SNOW</a>:
<a name="l00219"></a>00219             <span class="keywordflow">case</span> <a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba42bc017550219c838438200a3155c506">GAMEEVENT_FROZEN</a>:
<a name="l00220"></a>00220                 <a class="code" href="classVast.html#a645e007e0427c40f13eadf6f914f9881">handleEvent</a>( gameAPIMsg );
<a name="l00221"></a>00221                 <span class="keyword">delete</span> msg;
<a name="l00222"></a>00222                 <span class="keywordflow">break</span>;
<a name="l00223"></a>00223             <span class="keywordflow">default</span>: {
<a name="l00224"></a>00224                 <span class="keyword">delete</span> msg;
<a name="l00225"></a>00225             }
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227     }
<a name="l00228"></a>00228     <span class="keywordflow">else</span> <span class="keyword">delete</span> msg;
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00231"></a><a class="code" href="classVast.html#a5a12a3e1f34fbad6a2f6bb3231fce048">00231</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a5a12a3e1f34fbad6a2f6bb3231fce048" title="Processes messages from underlay.">Vast::handleUDPMessage</a>(<a class="code" href="classBaseOverlayMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseOverlayMessage</a>* msg)
<a name="l00232"></a>00232 {
<a name="l00233"></a>00233     <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa4c1b397f6c4682baf7db280e7f15520a">INIT</a>) {
<a name="l00234"></a>00234         <span class="keyword">delete</span> msg;
<a name="l00235"></a>00235         <span class="keywordflow">return</span>;
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237     <span class="keywordflow">if</span>(dynamic_cast&lt;VastMessage*&gt;(msg)) {
<a name="l00238"></a>00238         <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a>* vastMsg = check_and_cast&lt;<a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a>*&gt;(msg);
<a name="l00239"></a>00239         <span class="keywordflow">if</span>(vastMsg-&gt;<a class="code" href="classVastMessage.html#a9c9cdb5c0fbbdc0835ec81958c149a42">getDestKey</a>().<a class="code" href="classOverlayKey.html#abe357a4d1babcf7d30598a61cbc0f5c2" title="Returns true, if the key is unspecified.">isUnspecified</a>() || 
<a name="l00240"></a>00240            <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#abe357a4d1babcf7d30598a61cbc0f5c2" title="Returns true, if the key is unspecified.">isUnspecified</a>() ||
<a name="l00241"></a>00241            vastMsg-&gt;<a class="code" href="classVastMessage.html#a9c9cdb5c0fbbdc0835ec81958c149a42">getDestKey</a>() == <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>()) {
<a name="l00242"></a>00242             <span class="comment">// debug output</span>
<a name="l00243"></a>00243             <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) EV &lt;&lt; <span class="stringliteral">&quot;[Vast::handleUDPMessage() @ &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00244"></a>00244                                &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00245"></a>00245                                &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; received &quot;</span> &lt;&lt; vastMsg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; from &quot;</span> &lt;&lt; vastMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>().<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00246"></a>00246                                &lt;&lt; endl;
<a name="l00247"></a>00247             <span class="keywordtype">bool</span> doUpdate = <span class="keyword">true</span>;
<a name="l00248"></a>00248             <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>) {
<a name="l00249"></a>00249                 <span class="keywordflow">switch</span>(vastMsg-&gt;<a class="code" href="classVastMessage.html#a4faf79e8d3e56ae8b1007468d64f415e">getCommand</a>()) {
<a name="l00250"></a>00250                     <span class="keywordflow">case</span> <a class="code" href="GiaMessage__m_8h.html#ac712f468e66678ffb5df03be6d6a8157a71fec090ff88ece51771bbbf434064ec">JOIN_REQUEST</a>: {
<a name="l00251"></a>00251                         <a class="code" href="classVast.html#a3b1ec50a85c2e2e6c7c3e081acd1dcd2">handleJoinRequest</a>(vastMsg);
<a name="l00252"></a>00252                         doUpdate = <span class="keyword">false</span>;
<a name="l00253"></a>00253                     } <span class="keywordflow">break</span>;
<a name="l00254"></a>00254                     <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad9745223990da14f545a02e12e727b63">NODE_MOVE</a>: {
<a name="l00255"></a>00255                         <a class="code" href="classVastMoveMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMoveMessage</a>* vastMoveMsg = check_and_cast&lt;<a class="code" href="classVastMoveMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMoveMessage</a>*&gt;(msg);
<a name="l00256"></a>00256                         <a class="code" href="classVast.html#a9a1ea2b26ce93b38b226fd0eeb494998">handleNodeMove</a>(vastMoveMsg);
<a name="l00257"></a>00257                     } <span class="keywordflow">break</span>;
<a name="l00258"></a>00258                     <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fa3aafac4a63883acb0402e9a5dcae8110">NEW_NEIGHBORS</a>: {
<a name="l00259"></a>00259                         <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>* vastListMsg = check_and_cast&lt;<a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>*&gt;(msg);
<a name="l00260"></a>00260                         <a class="code" href="classVast.html#a50d7f96259000a44b65ee3951cb75ef5">handleNewNeighbors</a>(vastListMsg);
<a name="l00261"></a>00261                     } <span class="keywordflow">break</span>;
<a name="l00262"></a>00262                     <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fac2f6b0a84b96ac134911c0d532a4a91c">NODE_LEAVE</a>: {
<a name="l00263"></a>00263                         <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>* vastListMsg = check_and_cast&lt;<a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>*&gt;(msg);
<a name="l00264"></a>00264                         <a class="code" href="classVast.html#aa5b06ce84e80dfe3f274327a8cebf3d9">handleNodeLeave</a>(vastListMsg);
<a name="l00265"></a>00265                     } <span class="keywordflow">break</span>;
<a name="l00266"></a>00266                     <span class="keywordflow">case</span> <a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a328174aefc34e2aa1577e73ca6e0eb70">ENCLOSING_NEIGHBORS_REQUEST</a>: {
<a name="l00267"></a>00267                         <a class="code" href="classVast.html#adde7e0c8aab03277a63461d134fc6daa">handleEnclosingNeighborsRequest</a>(vastMsg);
<a name="l00268"></a>00268                     } <span class="keywordflow">break</span>;
<a name="l00269"></a>00269                     <span class="keywordflow">case</span> <a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a7157cf88037067097b25279589eec51c">BACKUP_NEIGHBORS</a>: {
<a name="l00270"></a>00270                         <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>* vastListMsg = check_and_cast&lt;<a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>*&gt;(msg);
<a name="l00271"></a>00271                         <a class="code" href="classVast.html#a7183562b322a046e2f23f8f8f668fdca">handleBackupNeighbors</a>(vastListMsg);
<a name="l00272"></a>00272                     } <span class="keywordflow">break</span>;
<a name="l00273"></a>00273                     <span class="keywordflow">case</span> <a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a3a95ef902bc659901cceef98e0bc8041">PING</a>: {
<a name="l00274"></a>00274                         <a class="code" href="classVast.html#a1361682de85c7ecc63476b0a9db712f0">handlePing</a>(vastMsg);
<a name="l00275"></a>00275                     } <span class="keywordflow">break</span>;
<a name="l00276"></a>00276                     <span class="keywordflow">case</span> <a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607ae911a27de4bca30604be3515f31b2057">PONG</a>: {
<a name="l00277"></a>00277                         <a class="code" href="classVast.html#a183cca07bd6ddceb33eebfba75bf1b80">handlePong</a>(vastMsg);
<a name="l00278"></a>00278                     } <span class="keywordflow">break</span>;
<a name="l00279"></a>00279                     <span class="keywordflow">case</span> <a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607ad62d6ba53c9c3efbda433545708a79b5">DISCARD_NODE</a>: {
<a name="l00280"></a>00280                         <a class="code" href="classVastDiscardMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastDiscardMessage</a>* vastDiscardMsg = check_and_cast&lt;<a class="code" href="classVastDiscardMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastDiscardMessage</a>*&gt;(msg);
<a name="l00281"></a>00281                         <a class="code" href="classVast.html#ac8599f81539fdaee6cd4cfd5cca2b8f4">handleDiscardNode</a>(vastDiscardMsg);
<a name="l00282"></a>00282                     } <span class="keywordflow">break</span>;
<a name="l00283"></a>00283                     <span class="keywordflow">case</span> <a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a0e3f3deef32a4742dc7a553c15c71f51">VAST_EVENT</a>: {
<a name="l00284"></a>00284                         <a class="code" href="classVast.html#ad3da9d482e3f5e50e0555cb561805320">sendToApp</a>(vastMsg-&gt;decapsulate());
<a name="l00285"></a>00285                         doUpdate = <span class="keyword">false</span>;
<a name="l00286"></a>00286                         <span class="keyword">delete</span> vastMsg;
<a name="l00287"></a>00287                     } <span class="keywordflow">break</span>;
<a name="l00288"></a>00288                 }
<a name="l00289"></a>00289                 <span class="comment">// update timestamp</span>
<a name="l00290"></a>00290                 <span class="keywordflow">if</span>(doUpdate) {
<a name="l00291"></a>00291                     SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(vastMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>());
<a name="l00292"></a>00292                     <span class="keywordflow">if</span>(itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end()) {
<a name="l00293"></a>00293                         itSites-&gt;second-&gt;tstamp = simTime();
<a name="l00294"></a>00294                     }
<a name="l00295"></a>00295                     <span class="keyword">delete</span> msg;
<a name="l00296"></a>00296                 }
<a name="l00297"></a>00297             }
<a name="l00298"></a>00298             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fabe22ce6e9471e472a566ba6cc27fbb5a">JOINING</a> &amp;&amp; vastMsg-&gt;<a class="code" href="classVastMessage.html#a4faf79e8d3e56ae8b1007468d64f415e">getCommand</a>() == JOIN_ACKNOWLEDGE) {
<a name="l00299"></a>00299                 <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>* vastListMsg = check_and_cast&lt;<a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>*&gt;(msg);
<a name="l00300"></a>00300                 <a class="code" href="classVast.html#ae3f2d9c26130a6986478513bc281e080">handleJoinAcknowledge</a>(vastListMsg);
<a name="l00301"></a>00301                 <span class="keyword">delete</span> msg;
<a name="l00302"></a>00302             }
<a name="l00303"></a>00303             <span class="keywordflow">else</span> <span class="keyword">delete</span> msg;
<a name="l00304"></a>00304         }
<a name="l00305"></a>00305         <span class="keywordflow">else</span> {
<a name="l00306"></a>00306             <a class="code" href="classVast.html#a23e724cfc93976442b57ed98c60b585d">sendDiscardNode</a>(vastMsg);
<a name="l00307"></a>00307             <span class="keyword">delete</span> msg;
<a name="l00308"></a>00308         }
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310     <span class="keywordflow">else</span> <span class="keyword">delete</span> msg;
<a name="l00311"></a>00311 }
<a name="l00312"></a>00312 
<a name="l00313"></a><a class="code" href="classVast.html#a27eff8db1664e9cd1e081c6dd3a64f42">00313</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a27eff8db1664e9cd1e081c6dd3a64f42">Vast::addNode</a>(<a class="code" href="classVector2D.html">Vector2D</a> p, <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> node, <span class="keywordtype">int</span> NeighborCount)
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315     <span class="keywordflow">if</span>(node != <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>) {
<a name="l00316"></a>00316         <span class="keywordflow">if</span>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(node) == <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end()) {
<a name="l00317"></a>00317             <a class="code" href="classSite.html">Site</a>* temp_site = <span class="keyword">new</span> <a class="code" href="classSite.html">Site</a>();
<a name="l00318"></a>00318             temp_site-&gt;<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a> = p;
<a name="l00319"></a>00319             temp_site-&gt;<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a> = node;
<a name="l00320"></a>00320             temp_site-&gt;<a class="code" href="classSite.html#ad049b81de6bddc5f2b5c198ca391dff6">neighborCount</a> = NeighborCount;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322             <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.insert(std::make_pair(temp_site-&gt;<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>, temp_site));
<a name="l00323"></a>00323             <a class="code" href="classVast.html#a72ef8a625cc4c37c0513fc842bd09470">Positions</a>.insert(temp_site-&gt;<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>);
<a name="l00324"></a>00324         }
<a name="l00325"></a>00325         <span class="keywordflow">else</span> {
<a name="l00326"></a>00326             SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(node);
<a name="l00327"></a>00327             <a class="code" href="classVast.html#a72ef8a625cc4c37c0513fc842bd09470">Positions</a>.erase(itSites-&gt;second-&gt;coord);
<a name="l00328"></a>00328             itSites-&gt;second-&gt;coord = p;
<a name="l00329"></a>00329             <a class="code" href="classVast.html#a72ef8a625cc4c37c0513fc842bd09470">Positions</a>.insert(itSites-&gt;second-&gt;coord);
<a name="l00330"></a>00330             <span class="keywordflow">if</span>(NeighborCount != 0) {
<a name="l00331"></a>00331                 itSites-&gt;second-&gt;neighborCount = NeighborCount;
<a name="l00332"></a>00332             }
<a name="l00333"></a>00333         }
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335 }
<a name="l00336"></a>00336 
<a name="l00337"></a><a class="code" href="classVast.html#a35d59294c560dd21f9ac30729eddfdb2">00337</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a35d59294c560dd21f9ac30729eddfdb2">Vast::addNodeToStock</a>(<a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> node)
<a name="l00338"></a>00338 {
<a name="l00339"></a>00339     <span class="keywordflow">if</span>(node != <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>) {
<a name="l00340"></a>00340         <span class="keywordflow">for</span>(StockList::iterator itTemp = <a class="code" href="classVast.html#a1b80c395388f7cc10a7a084bac6157e7">Stock</a>.begin(); itTemp != <a class="code" href="classVast.html#a1b80c395388f7cc10a7a084bac6157e7">Stock</a>.end(); ++itTemp) {
<a name="l00341"></a>00341             <span class="keywordflow">if</span>(*itTemp == node) {
<a name="l00342"></a>00342                 <span class="keywordflow">return</span>;
<a name="l00343"></a>00343             }
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345         <a class="code" href="classVast.html#a1b80c395388f7cc10a7a084bac6157e7">Stock</a>.push_front(node);
<a name="l00346"></a>00346         <span class="keywordflow">if</span>(<a class="code" href="classVast.html#a1b80c395388f7cc10a7a084bac6157e7">Stock</a>.size() &gt; <a class="code" href="classVast.html#a4d00a0a50dd92e3d223b4f4599bc82c3">stockListSize</a>) {
<a name="l00347"></a>00347             <a class="code" href="classVast.html#a1b80c395388f7cc10a7a084bac6157e7">Stock</a>.pop_back();
<a name="l00348"></a>00348         }
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a><a class="code" href="classVast.html#a3e7c0afd3098cc61ede525a6a59fb71f">00352</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a3e7c0afd3098cc61ede525a6a59fb71f">Vast::removeNode</a>(<a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> node)
<a name="l00353"></a>00353 {
<a name="l00354"></a>00354     SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(node);
<a name="l00355"></a>00355     <span class="keywordflow">if</span>(itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end()) {
<a name="l00356"></a>00356         <a class="code" href="classVast.html#a72ef8a625cc4c37c0513fc842bd09470">Positions</a>.erase(itSites-&gt;second-&gt;coord);
<a name="l00357"></a>00357         <span class="keyword">delete</span> itSites-&gt;second;
<a name="l00358"></a>00358         <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.erase(itSites);
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a><a class="code" href="classVast.html#a191518eda5a0f2d8639521c9102d43b1">00362</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#aac593b11c556c63cbdb49984bc6e9b34">Vast::buildVoronoi</a>(<a class="code" href="classVector2D.html">Vector2D</a> old_pos, <a class="code" href="classVector2D.html">Vector2D</a> new_pos, <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> enclosingCheck)
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364     <span class="keywordtype">int</span> sqrt_nsites = 1;
<a name="l00365"></a>00365     <span class="keywordtype">double</span> xmin, xmax, ymin, ymax;
<a name="l00366"></a>00366     <span class="keywordtype">double</span> deltax, deltay;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     <span class="comment">// check wether there are any neighbors</span>
<a name="l00369"></a>00369     <span class="keywordflow">if</span>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size() == 0) <span class="keywordflow">return</span>;
<a name="l00370"></a>00370 
<a name="l00371"></a>00371     xmin = xmax = <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>.<a class="code" href="classVector2D.html#ac5c4e553815737aa24bec8281270178f">x</a>;
<a name="l00372"></a>00372     ymin = ymax = <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>.<a class="code" href="classVector2D.html#ac38d0179cfe74c30fee290a703ab209a">y</a>;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     std::map&lt;Vector2D, Site*&gt; sortedSites;
<a name="l00375"></a>00375     sortedSites.insert(std::make_pair(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>, &amp;<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>));
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <span class="keywordflow">for</span>(SiteMap::iterator itTemp = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itTemp != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itTemp) {
<a name="l00378"></a>00378         <span class="comment">// determine min/max site coordinates</span>
<a name="l00379"></a>00379         <span class="keywordflow">if</span>(itTemp-&gt;second-&gt;coord.x &lt; xmin) xmin = itTemp-&gt;second-&gt;coord.x;
<a name="l00380"></a>00380         <span class="keywordflow">if</span>(itTemp-&gt;second-&gt;coord.x &gt; xmax) xmax = itTemp-&gt;second-&gt;coord.x;
<a name="l00381"></a>00381         <span class="keywordflow">if</span>(itTemp-&gt;second-&gt;coord.y &lt; ymin) ymin = itTemp-&gt;second-&gt;coord.y;
<a name="l00382"></a>00382         <span class="keywordflow">if</span>(itTemp-&gt;second-&gt;coord.y &gt; ymax) ymax = itTemp-&gt;second-&gt;coord.y;
<a name="l00383"></a>00383         <span class="comment">// reset all sites to UNDEF</span>
<a name="l00384"></a>00384         itTemp-&gt;second-&gt;type = UNDEF;
<a name="l00385"></a>00385         <span class="comment">// reset enclosing neighbors set</span>
<a name="l00386"></a>00386         itTemp-&gt;second-&gt;enclosingSet.clear();
<a name="l00387"></a>00387         <span class="comment">// fill sorted List</span>
<a name="l00388"></a>00388         sortedSites.insert(std::make_pair(itTemp-&gt;second-&gt;coord, itTemp-&gt;second));
<a name="l00389"></a>00389         sqrt_nsites++;
<a name="l00390"></a>00390     }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392     <span class="comment">// needed to determine appropriate hashtable size</span>
<a name="l00393"></a>00393     deltax = xmax - xmin;
<a name="l00394"></a>00394     deltay = ymax - ymin;
<a name="l00395"></a>00395     sqrt_nsites = (int)sqrt((<span class="keywordtype">double</span>)(sqrt_nsites+4));
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="comment">// start to calculate the voronoi</span>
<a name="l00398"></a>00398     <a class="code" href="classSite.html">Site</a> *newsite, *bot, *top, *temp, *p, *v, *bottomsite;
<a name="l00399"></a>00399     <a class="code" href="classVector2D.html">Vector2D</a> newintstar;
<a name="l00400"></a>00400     <span class="keywordtype">int</span> pm;
<a name="l00401"></a>00401     <a class="code" href="classHalfedge.html">Halfedge</a> *lbnd, *rbnd, *llbnd, *rrbnd, *bisector;
<a name="l00402"></a>00402     <a class="code" href="classEdge.html">Edge</a> *e;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     newintstar.<a class="code" href="classVector2D.html#ac5c4e553815737aa24bec8281270178f">x</a> = newintstar.<a class="code" href="classVector2D.html#ac38d0179cfe74c30fee290a703ab209a">y</a> = 0.0;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     std::map&lt;Vector2D, Site*&gt;::iterator itSortedSites = sortedSites.begin();
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#ac5eed947206dc7997ae6d90b65f33aeb">initialize</a>(deltax, deltay, <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>, old_pos, new_pos, <a class="code" href="classVast.html#a4720ff97b3ca3a6f53b9533f57a4fb56">AOI_size</a>);
<a name="l00409"></a>00409     <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a9ec3f6bf08226399f077bc3e7af1e28e">PQinitialize</a>(sqrt_nsites, ymin, deltay);
<a name="l00410"></a>00410     bottomsite = itSortedSites-&gt;second;
<a name="l00411"></a>00411     ++itSortedSites;
<a name="l00412"></a>00412     <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a4c5ec2361b648020d14b262d53f31415" title="Initializes the list before building the diagram.">initialize</a>(sqrt_nsites, xmin, deltax, bottomsite);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     newsite = itSortedSites-&gt;second;
<a name="l00415"></a>00415     ++itSortedSites;
<a name="l00416"></a>00416     <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
<a name="l00417"></a>00417         <span class="keywordflow">if</span>(!<a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a56f8454b1a800e74372df26289dc55f4">PQempty</a>()) newintstar = <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a32192681af8227de61ef123ab54e93cb">PQ_min</a>();
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         <span class="keywordflow">if</span>(newsite != NULL &amp;&amp; (<a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a56f8454b1a800e74372df26289dc55f4">PQempty</a>() ||
<a name="l00420"></a>00420            newsite-&gt;<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>.<a class="code" href="classVector2D.html#ac38d0179cfe74c30fee290a703ab209a">y</a> &lt; newintstar.<a class="code" href="classVector2D.html#ac38d0179cfe74c30fee290a703ab209a">y</a> ||
<a name="l00421"></a>00421            (newsite-&gt;<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>.<a class="code" href="classVector2D.html#ac38d0179cfe74c30fee290a703ab209a">y</a> == newintstar.<a class="code" href="classVector2D.html#ac38d0179cfe74c30fee290a703ab209a">y</a> &amp;&amp; newsite-&gt;<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>.<a class="code" href="classVector2D.html#ac5c4e553815737aa24bec8281270178f">x</a> &lt; newintstar.<a class="code" href="classVector2D.html#ac5c4e553815737aa24bec8281270178f">x</a>))) {
<a name="l00422"></a>00422             lbnd = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a95f79b33a2be55987e3803560b6bcbe4" title="Get an entry from the list by point.">ELleftbnd</a>(&amp;(newsite-&gt;<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>));
<a name="l00423"></a>00423             rbnd = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a15477c20a6aa35a11a7adf1d66e2ce56" title="Get right neighbor of an edge.">ELright</a>(lbnd);
<a name="l00424"></a>00424             bot = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#af6f9a1ad8f024c77a18327e88e848b2a" title="Get site right of an edge.">rightreg</a>(lbnd);
<a name="l00425"></a>00425             e = <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a28161e9d30083f92b98751b413f5afef">bisect</a>(bot, newsite);
<a name="l00426"></a>00426             bisector = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#aec23b6e42d883591e9a661566fdbfda5" title="Creates a halfedge from a given edge.">HEcreate</a>(e, <a class="code" href="VastDefs_8h.html#a3548ca9d636286bea86afc96a7a947d9">le</a>);
<a name="l00427"></a>00427             <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a0634267aac794c64b40a70c93d2b2e92" title="Inserts a new halfedge to the list.">ELinsert</a>(lbnd, bisector);
<a name="l00428"></a>00428             <span class="keywordflow">if</span> ((p = <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a50867d578fef5c4f88b643a1b9fd8a3f">intersect</a>(lbnd, bisector)) != NULL) {
<a name="l00429"></a>00429                 <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a361bdd8dffc528d6860d177b107cb3a0">PQdelete</a>(lbnd);
<a name="l00430"></a>00430                 <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a09b36d86656e377d262b1098bd03e17d">PQinsert</a>(lbnd, p, <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a90cb3b24a70e2183ca3e8b2051cad6af">dist</a>(p, newsite));
<a name="l00431"></a>00431             }
<a name="l00432"></a>00432             lbnd = bisector;
<a name="l00433"></a>00433             bisector = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#aec23b6e42d883591e9a661566fdbfda5" title="Creates a halfedge from a given edge.">HEcreate</a>(e, <a class="code" href="VastDefs_8h.html#a51f63d24f02be00251e895721eae51b0">re</a>);
<a name="l00434"></a>00434             <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a0634267aac794c64b40a70c93d2b2e92" title="Inserts a new halfedge to the list.">ELinsert</a>(lbnd, bisector);
<a name="l00435"></a>00435             <span class="keywordflow">if</span> ((p = <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a50867d578fef5c4f88b643a1b9fd8a3f">intersect</a>(bisector, rbnd)) != NULL) <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a09b36d86656e377d262b1098bd03e17d">PQinsert</a>(bisector, p, <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a90cb3b24a70e2183ca3e8b2051cad6af">dist</a>(p, newsite));
<a name="l00436"></a>00436             <span class="keywordflow">if</span>(itSortedSites != sortedSites.end()) {
<a name="l00437"></a>00437                 newsite = itSortedSites-&gt;second;
<a name="l00438"></a>00438                 ++itSortedSites;
<a name="l00439"></a>00439             }
<a name="l00440"></a>00440             <span class="keywordflow">else</span> newsite = NULL;
<a name="l00441"></a>00441         }
<a name="l00442"></a>00442         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a56f8454b1a800e74372df26289dc55f4">PQempty</a>()) {
<a name="l00443"></a>00443             lbnd = <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#ab2490259136b824faf5704885637cd24">PQextractmin</a>();
<a name="l00444"></a>00444             llbnd = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a70afa1e1c28ac28245dde25b2efac6ee" title="Get left neighbor of an edge.">ELleft</a>(lbnd);
<a name="l00445"></a>00445             rbnd = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a15477c20a6aa35a11a7adf1d66e2ce56" title="Get right neighbor of an edge.">ELright</a>(lbnd);
<a name="l00446"></a>00446             rrbnd = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a15477c20a6aa35a11a7adf1d66e2ce56" title="Get right neighbor of an edge.">ELright</a>(rbnd);
<a name="l00447"></a>00447             bot = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a153e9bac9b57716ff96206a19cf18543" title="Get site left of an edge.">leftreg</a>(lbnd);
<a name="l00448"></a>00448             top = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#af6f9a1ad8f024c77a18327e88e848b2a" title="Get site right of an edge.">rightreg</a>(rbnd);
<a name="l00449"></a>00449             v = lbnd-&gt;<a class="code" href="classHalfedge.html#a6ff7818fbec8e1adad2e970a5960aa6b">vertex</a>;
<a name="l00450"></a>00450             <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#afa58eef6fdb8bc89290ba5a7f873d8a1">endpoint</a>(lbnd-&gt;<a class="code" href="classHalfedge.html#a0e7edfac3055d2a9faf8d8e9fa74c3d8">ELedge</a>, lbnd-&gt;<a class="code" href="classHalfedge.html#a36e688c7989974e7af28c3861e60085d">ELpm</a>, v);
<a name="l00451"></a>00451             <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#afa58eef6fdb8bc89290ba5a7f873d8a1">endpoint</a>(rbnd-&gt;<a class="code" href="classHalfedge.html#a0e7edfac3055d2a9faf8d8e9fa74c3d8">ELedge</a>, rbnd-&gt;<a class="code" href="classHalfedge.html#a36e688c7989974e7af28c3861e60085d">ELpm</a>, v);
<a name="l00452"></a>00452             <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#ad912ba344238f0c9e0f9c6f7a2fbc26b" title="Delete an entry from the list.">ELdelete</a>(lbnd);
<a name="l00453"></a>00453             <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a361bdd8dffc528d6860d177b107cb3a0">PQdelete</a>(rbnd);
<a name="l00454"></a>00454             <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#ad912ba344238f0c9e0f9c6f7a2fbc26b" title="Delete an entry from the list.">ELdelete</a>(rbnd);
<a name="l00455"></a>00455             pm = le;
<a name="l00456"></a>00456             <span class="keywordflow">if</span> (bot-&gt;<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>.<a class="code" href="classVector2D.html#ac38d0179cfe74c30fee290a703ab209a">y</a> &gt; top-&gt;<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>.<a class="code" href="classVector2D.html#ac38d0179cfe74c30fee290a703ab209a">y</a>) {
<a name="l00457"></a>00457                 temp = bot;
<a name="l00458"></a>00458                 bot = top;
<a name="l00459"></a>00459                 top = temp;
<a name="l00460"></a>00460                 pm = re;
<a name="l00461"></a>00461             }
<a name="l00462"></a>00462             e = <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a28161e9d30083f92b98751b413f5afef">bisect</a>(bot, top);
<a name="l00463"></a>00463             bisector = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#aec23b6e42d883591e9a661566fdbfda5" title="Creates a halfedge from a given edge.">HEcreate</a>(e, pm);
<a name="l00464"></a>00464             <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a0634267aac794c64b40a70c93d2b2e92" title="Inserts a new halfedge to the list.">ELinsert</a>(llbnd, bisector);
<a name="l00465"></a>00465             <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#afa58eef6fdb8bc89290ba5a7f873d8a1">endpoint</a>(e, <a class="code" href="VastDefs_8h.html#a51f63d24f02be00251e895721eae51b0">re</a>-pm, v);
<a name="l00466"></a>00466             <span class="keywordflow">if</span>((p = <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a50867d578fef5c4f88b643a1b9fd8a3f">intersect</a>(llbnd, bisector)) != NULL) {
<a name="l00467"></a>00467                 <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a361bdd8dffc528d6860d177b107cb3a0">PQdelete</a>(llbnd);
<a name="l00468"></a>00468                 <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a09b36d86656e377d262b1098bd03e17d">PQinsert</a>(llbnd, p, <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a90cb3b24a70e2183ca3e8b2051cad6af">dist</a>(p, bot));
<a name="l00469"></a>00469             }
<a name="l00470"></a>00470             <span class="keywordflow">if</span> ((p = <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a50867d578fef5c4f88b643a1b9fd8a3f">intersect</a>(bisector, rrbnd)) != NULL) <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a09b36d86656e377d262b1098bd03e17d">PQinsert</a>(bisector, p, <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a90cb3b24a70e2183ca3e8b2051cad6af">dist</a>(p, bot));
<a name="l00471"></a>00471         }
<a name="l00472"></a>00472         <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
<a name="l00473"></a>00473     }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475     <span class="comment">// process the generated edgelist</span>
<a name="l00476"></a>00476     <span class="keywordflow">for</span>(lbnd = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a15477c20a6aa35a11a7adf1d66e2ce56" title="Get right neighbor of an edge.">ELright</a>(<a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a95dd0de214e6c8b72f1aeadcbd9d5690">ELleftend</a>); lbnd != <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a9fb7f067c7a3baa17026e8bbc95d60de">ELrightend</a>; lbnd = <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#a15477c20a6aa35a11a7adf1d66e2ce56" title="Get right neighbor of an edge.">ELright</a>(lbnd)) {
<a name="l00477"></a>00477         e = lbnd -&gt; ELedge;
<a name="l00478"></a>00478         <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#a927ad687454613c583aa1864989ca436">processEdge</a>(e);
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480     <span class="comment">// process sites in order to determine our neighbors</span>
<a name="l00481"></a>00481     <span class="keywordflow">for</span>(SiteMap::iterator itTemp = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itTemp != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itTemp) {
<a name="l00482"></a>00482         <span class="keywordflow">if</span>(itTemp-&gt;second-&gt;innerEdge[0]) {
<a name="l00483"></a>00483             <span class="keywordflow">if</span>(itTemp-&gt;second-&gt;outerEdge) {
<a name="l00484"></a>00484                 itTemp-&gt;second-&gt;type |= BOUNDARY;
<a name="l00485"></a>00485                 <span class="comment">// Debug output</span>
<a name="l00486"></a>00486                 <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>)
<a name="l00487"></a>00487                     EV &lt;&lt; <span class="stringliteral">&quot;[NeighborsList::buildVoronoi()]\n&quot;</span>
<a name="l00488"></a>00488                        &lt;&lt; <span class="stringliteral">&quot;    Site at [&quot;</span> &lt;&lt; itTemp-&gt;second-&gt;coord.x &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00489"></a>00489                        &lt;&lt; itTemp-&gt;second-&gt;coord.y &lt;&lt; <span class="stringliteral">&quot;] is a boundary neighbor.&quot;</span>
<a name="l00490"></a>00490                        &lt;&lt; endl;
<a name="l00491"></a>00491             }
<a name="l00492"></a>00492             <span class="keywordflow">else</span> {
<a name="l00493"></a>00493                 itTemp-&gt;second-&gt;type |= NEIGHBOR;
<a name="l00494"></a>00494                 <span class="comment">// Debug output</span>
<a name="l00495"></a>00495                 <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>)
<a name="l00496"></a>00496                     EV &lt;&lt; <span class="stringliteral">&quot;[NeighborsList::buildVoronoi()]\n&quot;</span>
<a name="l00497"></a>00497                        &lt;&lt; <span class="stringliteral">&quot;    Site at [&quot;</span> &lt;&lt; itTemp-&gt;second-&gt;coord.x &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00498"></a>00498                        &lt;&lt; itTemp-&gt;second-&gt;coord.y &lt;&lt; <span class="stringliteral">&quot;] is a neighbor.&quot;</span>
<a name="l00499"></a>00499                        &lt;&lt; endl;
<a name="l00500"></a>00500             }
<a name="l00501"></a>00501         }
<a name="l00502"></a>00502         <span class="comment">// Treat enclosing neighbors whose voronoi region is outside our AOI as boundary neighbors</span>
<a name="l00503"></a>00503         <span class="keywordflow">if</span>((!itTemp-&gt;second-&gt;type &amp; <a class="code" href="VastDefs_8h.html#ac37458b05fa7ffc23c7d126c12990a7c">NEIGHBOR</a>) &amp;&amp; (itTemp-&gt;second-&gt;type &amp; ENCLOSING)) {
<a name="l00504"></a>00504             itTemp-&gt;second-&gt;type |= BOUNDARY;
<a name="l00505"></a>00505             <span class="comment">// Debug output</span>
<a name="l00506"></a>00506             <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>)
<a name="l00507"></a>00507                 EV &lt;&lt; <span class="stringliteral">&quot;[NeighborsList::buildVoronoi()]\n&quot;</span>
<a name="l00508"></a>00508                 &lt;&lt; <span class="stringliteral">&quot;    Site at [&quot;</span> &lt;&lt; itTemp-&gt;second-&gt;coord.x &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00509"></a>00509                 &lt;&lt; itTemp-&gt;second-&gt;coord.y &lt;&lt; <span class="stringliteral">&quot;] is a boundary neighbor.&quot;</span>
<a name="l00510"></a>00510                 &lt;&lt; endl;
<a name="l00511"></a>00511         }
<a name="l00512"></a>00512         <span class="keywordflow">if</span>(!itTemp-&gt;second-&gt;innerEdge[1] &amp;&amp; itTemp-&gt;second-&gt;innerEdge[2]) {
<a name="l00513"></a>00513             itTemp-&gt;second-&gt;type |= NEW;
<a name="l00514"></a>00514             <span class="comment">// Debug output</span>
<a name="l00515"></a>00515             <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>)
<a name="l00516"></a>00516                 EV &lt;&lt; <span class="stringliteral">&quot;[NeighborsList::buildVoronoi()]\n&quot;</span>
<a name="l00517"></a>00517                    &lt;&lt; <span class="stringliteral">&quot;    Site at [&quot;</span> &lt;&lt; itTemp-&gt;second-&gt;coord.x &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00518"></a>00518                    &lt;&lt; itTemp-&gt;second-&gt;coord.y &lt;&lt; <span class="stringliteral">&quot;] is a new neighbor for site at &quot;</span> &lt;&lt; new_pos.<a class="code" href="classVector2D.html#ac5c4e553815737aa24bec8281270178f">x</a> &lt;&lt; <span class="stringliteral">&quot;:&quot;</span> &lt;&lt; new_pos.<a class="code" href="classVector2D.html#ac38d0179cfe74c30fee290a703ab209a">y</a> &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>
<a name="l00519"></a>00519                    &lt;&lt; endl;
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521         <span class="comment">// enhanced enclosing check</span>
<a name="l00522"></a>00522         <span class="keywordflow">if</span>(!enclosingCheck.<a class="code" href="classNodeHandle.html#ab5136375a4548ced7c2014a73c8743c9" title="indicates if this NodeHandle is specified">isUnspecified</a>() &amp;&amp; (<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(enclosingCheck) != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end())) {
<a name="l00523"></a>00523             <a class="code" href="classSite.html">Site</a>* tempSite = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(enclosingCheck)-&gt;second;
<a name="l00524"></a>00524             <span class="keywordflow">for</span>(EnclosingSet::iterator itSet = tempSite-&gt;<a class="code" href="classSite.html#a0b03f30a81bb8c872570ca60d3bde3f3">enclosingSet</a>.begin(); itSet != tempSite-&gt;<a class="code" href="classSite.html#a0b03f30a81bb8c872570ca60d3bde3f3">enclosingSet</a>.end(); ++itSet) {
<a name="l00525"></a>00525                 <span class="keywordflow">if</span>(tempSite-&gt;<a class="code" href="classSite.html#a5f6d5fd56ae316f506bcb02590f1a24e">oldEnclosingSet</a>.find(*itSet) == tempSite-&gt;<a class="code" href="classSite.html#a5f6d5fd56ae316f506bcb02590f1a24e">oldEnclosingSet</a>.end()
<a name="l00526"></a>00526                     &amp;&amp; <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(*itSet) != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end()) {
<a name="l00527"></a>00527                     <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(*itSet)-&gt;second-&gt;type |= <a class="code" href="VastDefs_8h.html#ab6bca16ed021b1e211fde8669758f199">NEW</a>;
<a name="l00528"></a>00528                 }
<a name="l00529"></a>00529             }
<a name="l00530"></a>00530             tempSite-&gt;<a class="code" href="classSite.html#a0b03f30a81bb8c872570ca60d3bde3f3">enclosingSet</a>.swap(tempSite-&gt;<a class="code" href="classSite.html#a5f6d5fd56ae316f506bcb02590f1a24e">oldEnclosingSet</a>);
<a name="l00531"></a>00531         }
<a name="l00532"></a>00532         <span class="comment">// reset inner- and outeredge indicator</span>
<a name="l00533"></a>00533         itTemp-&gt;second-&gt;innerEdge[0] = <span class="keyword">false</span>;
<a name="l00534"></a>00534         itTemp-&gt;second-&gt;innerEdge[1] = <span class="keyword">false</span>;
<a name="l00535"></a>00535         itTemp-&gt;second-&gt;innerEdge[2] = <span class="keyword">false</span>;
<a name="l00536"></a>00536         itTemp-&gt;second-&gt;outerEdge = <span class="keyword">false</span>;
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538     <span class="comment">// clean up</span>
<a name="l00539"></a>00539     <a class="code" href="classVast.html#afa2c209389e2a7e721c238336501971b">edgelist</a>.<a class="code" href="classEdgeList.html#aeeb737f31a13a16c51a05d55b4dc3701" title="Resets the list for further use.">reset</a>();
<a name="l00540"></a>00540     <a class="code" href="classVast.html#a8080d25da7c61e9d731f5d84779b7d8c">heap</a>.<a class="code" href="classHeapPQ.html#a9f68f6eeefb48d1767a6516d516eb2ed">PQreset</a>();
<a name="l00541"></a>00541     <a class="code" href="classVast.html#a74a56d4cdcb37e86d85a893696ba7780">geom</a>.<a class="code" href="classGeometry.html#ae9a788d2d88a35f4bd8ae18817a6c897">reset</a>();
<a name="l00542"></a>00542 }
<a name="l00543"></a>00543 
<a name="l00544"></a><a class="code" href="classVast.html#aac593b11c556c63cbdb49984bc6e9b34">00544</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#aac593b11c556c63cbdb49984bc6e9b34">Vast::buildVoronoi</a>()
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546     <a class="code" href="classVast.html#aac593b11c556c63cbdb49984bc6e9b34">buildVoronoi</a>(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>, <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>);
<a name="l00547"></a>00547 }
<a name="l00548"></a>00548 
<a name="l00549"></a><a class="code" href="classVast.html#ac0eb8a31568b3fbec02f6251e7d05e46">00549</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#ac0eb8a31568b3fbec02f6251e7d05e46">Vast::removeNeighbors</a>()
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551     <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end();) {
<a name="l00552"></a>00552         <span class="comment">// if current site is no neighbor remove it else go on to next site</span>
<a name="l00553"></a>00553         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type == <a class="code" href="VastDefs_8h.html#abde25a67f4046530ae1c572cefeb5869">UNDEF</a>) {
<a name="l00554"></a>00554             <span class="comment">// Debug output</span>
<a name="l00555"></a>00555             <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>)  EV &lt;&lt; <span class="stringliteral">&quot;[NeighborsList::removeNeighbors()]\n&quot;</span>
<a name="l00556"></a>00556                                 &lt;&lt; <span class="stringliteral">&quot;    Site at [&quot;</span> &lt;&lt; itSites-&gt;second-&gt;coord.x &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; itSites-&gt;second-&gt;coord.y
<a name="l00557"></a>00557                                 &lt;&lt; <span class="stringliteral">&quot;] has been removed from list.&quot;</span>
<a name="l00558"></a>00558                                 &lt;&lt; endl;
<a name="l00559"></a>00559             <a class="code" href="classVast.html#a72ef8a625cc4c37c0513fc842bd09470">Positions</a>.erase(itSites-&gt;second-&gt;coord);
<a name="l00560"></a>00560             <span class="keyword">delete</span> itSites-&gt;second;
<a name="l00561"></a>00561             <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.erase(itSites++);
<a name="l00562"></a>00562         }
<a name="l00563"></a>00563         <span class="keywordflow">else</span> ++itSites;
<a name="l00564"></a>00564     }
<a name="l00565"></a>00565 }
<a name="l00566"></a>00566 
<a name="l00567"></a><a class="code" href="classVast.html#abe5f7fe27677c21cb0421ace877ff368">00567</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#abe5f7fe27677c21cb0421ace877ff368" title="This method gets call **.gracefulLeaveDelay seconds before it is killed.">Vast::handleNodeLeaveNotification</a>()
<a name="l00568"></a>00568 {
<a name="l00569"></a>00569     <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>) {
<a name="l00570"></a>00570         <span class="comment">// debug output</span>
<a name="l00571"></a>00571         <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l00572"></a>00572             EV &lt;&lt; <span class="stringliteral">&quot;[Vast::receiveChangeNotification() @ &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00573"></a>00573                &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00574"></a>00574                &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; is leaving the overlay.&quot;</span>
<a name="l00575"></a>00575                &lt;&lt; endl;
<a name="l00576"></a>00576         }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         <a class="code" href="classCompReadyMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">CompReadyMessage</a>* readyMsg = <span class="keyword">new</span> <a class="code" href="classCompReadyMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">CompReadyMessage</a>(<span class="stringliteral">&quot;OVERLAY_FINISHED&quot;</span>);
<a name="l00579"></a>00579         readyMsg-&gt;<a class="code" href="classCompReadyMessage.html#ac5158504d6b97a32974f14c9b1a7a662">setReady</a>(<span class="keyword">false</span>);
<a name="l00580"></a>00580         readyMsg-&gt;<a class="code" href="classCompReadyMessage.html#ad9a52c5f788e0c11a75bbb5df3855ac0">setComp</a>(<a class="code" href="classBaseOverlay.html#a92e0d3f96a5716245465e05da60ef487">getThisCompType</a>());
<a name="l00581"></a>00581         <a class="code" href="classVast.html#ad3da9d482e3f5e50e0555cb561805320">sendToApp</a>(readyMsg);
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583 }
<a name="l00584"></a>00584 
<a name="l00585"></a><a class="code" href="classVast.html#a927d7255a4ffb6ab2ef1f46c5cba8fb4">00585</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a927d7255a4ffb6ab2ef1f46c5cba8fb4" title="This method gets call **.gracefulLeaveDelay seconds before it is killed if this node is among the gra...">Vast::handleNodeGracefulLeaveNotification</a>()
<a name="l00586"></a>00586 {
<a name="l00587"></a>00587      <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>) {
<a name="l00588"></a>00588         <span class="comment">// generate node leave messages</span>
<a name="l00589"></a>00589         <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastListMsg = <span class="keyword">new</span> <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>(<span class="stringliteral">&quot;NODE_LEAVE&quot;</span>);
<a name="l00590"></a>00590         vastListMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fac2f6b0a84b96ac134911c0d532a4a91c">NODE_LEAVE</a>);
<a name="l00591"></a>00591         <span class="comment">// fill neighbors list</span>
<a name="l00592"></a>00592         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a51421ae8e810c22b4395f0335e6a22b5">setNeighborNodeArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l00593"></a>00593         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#acdf513aff66a23092146597c5904d72e">setNeighborPosArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l00594"></a>00594         <span class="keywordtype">int</span> i = 0;
<a name="l00595"></a>00595         <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00596"></a>00596             <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type &amp; <a class="code" href="VastDefs_8h.html#a2aedfe59324ff558559ff9932c649443">ENCLOSING</a>) {
<a name="l00597"></a>00597                 vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a3a43039b97fdc8c2cdab789146a99771">setNeighborNode</a>(i, itSites-&gt;second-&gt;addr);
<a name="l00598"></a>00598                 vastListMsg-&gt;<a class="code" href="classVastListMessage.html#aa4b76d6cf2e98d70a5b742b51525bcc2">setNeighborPos</a>(i, itSites-&gt;second-&gt;coord);
<a name="l00599"></a>00599                 ++i;
<a name="l00600"></a>00600             }
<a name="l00601"></a>00601         }
<a name="l00602"></a>00602         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a51421ae8e810c22b4395f0335e6a22b5">setNeighborNodeArraySize</a>(i);
<a name="l00603"></a>00603         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#acdf513aff66a23092146597c5904d72e">setNeighborPosArraySize</a>(i);
<a name="l00604"></a>00604 
<a name="l00605"></a>00605         vastListMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#afd61f02ed0c547b46d3376a4e4e7dc1c">VASTLIST_L</a>(vastListMsg));
<a name="l00606"></a>00606         <span class="keywordflow">if</span>(vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a284ee95a466d4e7c1b4f803acd47be2d">getNeighborNodeArraySize</a>() &gt; 0) {
<a name="l00607"></a>00607             <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00608"></a>00608                 <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastCopyMsg = <span class="keyword">new</span> <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>(*vastListMsg);
<a name="l00609"></a>00609                <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastCopyMsg, itSites-&gt;second-&gt;addr);
<a name="l00610"></a>00610             }
<a name="l00611"></a>00611         }
<a name="l00612"></a>00612         <span class="keyword">delete</span> vastListMsg;
<a name="l00613"></a>00613         <a class="code" href="classVast.html#a9f49980680ed52219a6ef0a1bcff412b">changeState</a>(<a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa4c1b397f6c4682baf7db280e7f15520a">INIT</a>);
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a><a class="code" href="classVast.html#aa54887a2c280267a9a401e50c240f6d5">00617</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#aa54887a2c280267a9a401e50c240f6d5">Vast::processJoinTimer</a>()
<a name="l00618"></a>00618 {
<a name="l00619"></a>00619     <a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a> *sgcMsg = <span class="keyword">new</span> <a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a>(<span class="stringliteral">&quot;MOVEMENT_REQUEST&quot;</span>);
<a name="l00620"></a>00620     sgcMsg-&gt;<a class="code" href="classGameAPIMessage.html#a3c12a88e720037a70248b0db6a46fc99">setCommand</a>(<a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6baebd21087dd4fccf5bea6d56c351f76d1">MOVEMENT_REQUEST</a>);
<a name="l00621"></a>00621     <a class="code" href="classVast.html#ad3da9d482e3f5e50e0555cb561805320">sendToApp</a>(sgcMsg);
<a name="l00622"></a>00622 }
<a name="l00623"></a>00623 
<a name="l00624"></a><a class="code" href="classVast.html#af30893315b517cde6403ebf5a0aca8af">00624</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#af30893315b517cde6403ebf5a0aca8af">Vast::processPingTimer</a>()
<a name="l00625"></a>00625 {
<a name="l00626"></a>00626     <span class="keywordtype">bool</span> abnormalLeave = <span class="keyword">false</span>;
<a name="l00627"></a>00627     <span class="keywordtype">bool</span> boundaryLeave = <span class="keyword">false</span>;
<a name="l00628"></a>00628     std::set&lt;NodeHandle&gt; removeSet;
<a name="l00629"></a>00629     <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00630"></a>00630         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;tstamp &lt; 0.0) { <span class="comment">// node is dropped cause no pong has been received see below</span>
<a name="l00631"></a>00631             abnormalLeave = <span class="keyword">true</span>;
<a name="l00632"></a>00632             <span class="keywordflow">if</span>(!(itSites-&gt;second-&gt;type &amp; <a class="code" href="VastDefs_8h.html#ac37458b05fa7ffc23c7d126c12990a7c">NEIGHBOR</a>)) boundaryLeave = <span class="keyword">true</span>;
<a name="l00633"></a>00633             itSites-&gt;second-&gt;type = UNDEF;
<a name="l00634"></a>00634             removeSet.insert( itSites-&gt;first );
<a name="l00635"></a>00635         }
<a name="l00636"></a>00636         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itSites-&gt;second-&gt;tstamp &lt; simTime() - <a class="code" href="classVast.html#ad79f8a786033cb62653286f8cc5015e5">pingTimeout</a>) { <span class="comment">// node showed no activity for some time request pong and mark it to be dropped next time</span>
<a name="l00637"></a>00637             <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastMsg = <span class="keyword">new</span> <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a>(<span class="stringliteral">&quot;PING&quot;</span>);
<a name="l00638"></a>00638             vastMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a3a95ef902bc659901cceef98e0bc8041">PING</a>);
<a name="l00639"></a>00639             vastMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#ab6942347876cb4befb4da670eb90871f">VAST_L</a>(vastMsg));
<a name="l00640"></a>00640             <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastMsg, itSites-&gt;second-&gt;addr);
<a name="l00641"></a>00641             itSites-&gt;second-&gt;tstamp = -1.0;
<a name="l00642"></a>00642         }
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644     <span class="keywordflow">if</span>(abnormalLeave) {
<a name="l00645"></a>00645         <a class="code" href="classVast.html#afe368cd0468509b32f40acfc196a1856">synchronizeApp</a>();
<a name="l00646"></a>00646         <span class="keywordflow">for</span>( std::set&lt;NodeHandle&gt;::iterator it = removeSet.begin(); it != removeSet.end(); ++it) {
<a name="l00647"></a>00647             <a class="code" href="classVast.html#a3e7c0afd3098cc61ede525a6a59fb71f">removeNode</a>( *it );
<a name="l00648"></a>00648         }
<a name="l00649"></a>00649         <span class="comment">// removeNeighbors();</span>
<a name="l00650"></a>00650         <span class="keywordflow">if</span>(boundaryLeave) {
<a name="l00651"></a>00651             <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00652"></a>00652                 <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type &amp; <a class="code" href="VastDefs_8h.html#a985bae7b67bcb96c5565a24a5f6d4cba">BOUNDARY</a>) {
<a name="l00653"></a>00653                     <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastMsg = <span class="keyword">new</span> <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a>(<span class="stringliteral">&quot;ENCLOSING_NEIGHBORS_REQUEST&quot;</span>);
<a name="l00654"></a>00654                     vastMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a328174aefc34e2aa1577e73ca6e0eb70">ENCLOSING_NEIGHBORS_REQUEST</a>);
<a name="l00655"></a>00655                     vastMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#ab6942347876cb4befb4da670eb90871f">VAST_L</a>(vastMsg));
<a name="l00656"></a>00656                     <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastMsg, itSites-&gt;second-&gt;addr);
<a name="l00657"></a>00657                 }
<a name="l00658"></a>00658             }
<a name="l00659"></a>00659         }
<a name="l00660"></a>00660         <span class="comment">//buildVoronoi();</span>
<a name="l00661"></a>00661         <span class="comment">//removeNeighbors(); should be superfluous</span>
<a name="l00662"></a>00662     }
<a name="l00663"></a>00663 }
<a name="l00664"></a>00664 
<a name="l00665"></a><a class="code" href="classVast.html#a0eadb10fa255a3a2b89b1296d87be07d">00665</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a0eadb10fa255a3a2b89b1296d87be07d">Vast::processSecTimer</a>()
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667     <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(
<a name="l00668"></a>00668         <span class="keywordflow">if</span>(<a class="code" href="classVast.html#af30ae27611d3b281fb3a7f16b329f539">bytesPerSecond</a> &gt; <a class="code" href="classVast.html#aea94419d8d7589930d1b2e1b4de0468d">maxBytesPerSecondSent</a>) {
<a name="l00669"></a>00669             <a class="code" href="classVast.html#aea94419d8d7589930d1b2e1b4de0468d">maxBytesPerSecondSent</a> = <a class="code" href="classVast.html#af30ae27611d3b281fb3a7f16b329f539">bytesPerSecond</a>;
<a name="l00670"></a>00670         }
<a name="l00671"></a>00671         <a class="code" href="classVast.html#a90f9ed7d27fee143970e838e2a7bea15">averageBytesPerSecondSent</a> += <a class="code" href="classVast.html#af30ae27611d3b281fb3a7f16b329f539">bytesPerSecond</a>;
<a name="l00672"></a>00672         ++<a class="code" href="classVast.html#a120c3c82cafcab0a237fe080e71a4862">secTimerCount</a>;
<a name="l00673"></a>00673     );
<a name="l00674"></a>00674     <a class="code" href="classVast.html#af30ae27611d3b281fb3a7f16b329f539">bytesPerSecond</a> = 0;
<a name="l00675"></a>00675 }
<a name="l00676"></a>00676 
<a name="l00677"></a><a class="code" href="classVast.html#a1297368d6e59e3d9528b082f5ec043f4">00677</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a1297368d6e59e3d9528b082f5ec043f4">Vast::processCheckCriticalTimer</a>()
<a name="l00678"></a>00678 {
<a name="l00679"></a>00679     <span class="keywordtype">double</span> NeighborLevel;
<a name="l00680"></a>00680     <span class="keywordtype">int</span> NeighborSum = 0;
<a name="l00681"></a>00681     <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00682"></a>00682         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;neighborCount &gt; 0) {
<a name="l00683"></a>00683             NeighborSum += itSites-&gt;second-&gt;neighborCount;
<a name="l00684"></a>00684         }
<a name="l00685"></a>00685     }
<a name="l00686"></a>00686     NeighborLevel = (double)(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size() * <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size()) / (<span class="keywordtype">double</span>)NeighborSum;
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     <span class="keywordflow">if</span>(NeighborLevel &lt; <a class="code" href="classVast.html#ab68ac286673ed0ae4e2e05215481d667">criticalThreshold</a>) {
<a name="l00689"></a>00689         <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastListMsg = <span class="keyword">new</span> <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>(<span class="stringliteral">&quot;BACKUP_NEIGHBORS&quot;</span>);
<a name="l00690"></a>00690         vastListMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a7157cf88037067097b25279589eec51c">BACKUP_NEIGHBORS</a>);
<a name="l00691"></a>00691         <span class="comment">// fill neighbors list</span>
<a name="l00692"></a>00692         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a51421ae8e810c22b4395f0335e6a22b5">setNeighborNodeArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l00693"></a>00693         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#acdf513aff66a23092146597c5904d72e">setNeighborPosArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l00694"></a>00694         <span class="keywordtype">int</span> i = 0;
<a name="l00695"></a>00695         <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00696"></a>00696             vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a3a43039b97fdc8c2cdab789146a99771">setNeighborNode</a>(i, itSites-&gt;second-&gt;addr);
<a name="l00697"></a>00697             vastListMsg-&gt;<a class="code" href="classVastListMessage.html#aa4b76d6cf2e98d70a5b742b51525bcc2">setNeighborPos</a>(i, itSites-&gt;second-&gt;coord);
<a name="l00698"></a>00698             ++i;
<a name="l00699"></a>00699         }
<a name="l00700"></a>00700         vastListMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#afd61f02ed0c547b46d3376a4e4e7dc1c">VASTLIST_L</a>(vastListMsg));
<a name="l00701"></a>00701         <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00702"></a>00702             <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastCopyMsg = <span class="keyword">new</span> <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>(*vastListMsg);
<a name="l00703"></a>00703             <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastCopyMsg, itSites-&gt;second-&gt;addr);
<a name="l00704"></a>00704         }
<a name="l00705"></a>00705         <span class="keyword">delete</span> vastListMsg;
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707 }
<a name="l00708"></a>00708 
<a name="l00709"></a><a class="code" href="classVast.html#a3e41736afd958b63b754c0bcc425cbfe">00709</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a3e41736afd958b63b754c0bcc425cbfe">Vast::processDiscoveryTimer</a>()
<a name="l00710"></a>00710 {
<a name="l00711"></a>00711     <span class="keywordflow">for</span>(StockList::iterator itStock = <a class="code" href="classVast.html#a1b80c395388f7cc10a7a084bac6157e7">Stock</a>.begin(); itStock != <a class="code" href="classVast.html#a1b80c395388f7cc10a7a084bac6157e7">Stock</a>.end(); ++itStock) {
<a name="l00712"></a>00712         <a class="code" href="classVastMoveMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMoveMessage</a> *vastMoveMsg = <span class="keyword">new</span> <a class="code" href="classVastMoveMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMoveMessage</a>(<span class="stringliteral">&quot;NODE_MOVE&quot;</span>);
<a name="l00713"></a>00713         vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad9745223990da14f545a02e12e727b63">NODE_MOVE</a>);
<a name="l00714"></a>00714         vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#a5e57dca590d5742e7b1846e703f189ee">setNewPos</a>(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>);
<a name="l00715"></a>00715         vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#a6fa5bc1106c583d2991f58ab0698bf38">setRequest_list</a>(<span class="keyword">true</span>);
<a name="l00716"></a>00716         vastMoveMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#a865e3b42837bb08abf934321cf8ea6a7">VASTMOVE_L</a>(vastMoveMsg));
<a name="l00717"></a>00717         <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastMoveMsg, *itStock);
<a name="l00718"></a>00718     }
<a name="l00719"></a>00719 }
<a name="l00720"></a>00720 
<a name="l00721"></a><a class="code" href="classVast.html#a25469658017340ae776e74d966ba5f54">00721</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a25469658017340ae776e74d966ba5f54">Vast::handleJoin</a>(<a class="code" href="classGameAPIPositionMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIPositionMessage</a> *sgcMsg)
<a name="l00722"></a>00722 {
<a name="l00723"></a>00723     <a class="code" href="classTransportAddress.html" title="This class implements a common transport address.">TransportAddress</a> joinNode = <a class="code" href="classBaseOverlay.html#abe4dea93564123116c97d5c4721f0504" title="pointer to the BootstrapList module">bootstrapList</a>-&gt;<a class="code" href="classBootstrapList.html#af6e1422372d548ba574e136c1a10ccaa" title="Get a bootstrap node from the bootstrap list.">getBootstrapNode</a>();
<a name="l00724"></a>00724     <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a> = sgcMsg-&gt;<a class="code" href="classGameAPIPositionMessage.html#a62cb5e229193a2e0118e240de2494d53">getPosition</a>();
<a name="l00725"></a>00725     <span class="comment">// check if this is the only node in the overlay</span>
<a name="l00726"></a>00726     <span class="keywordflow">if</span>(joinNode.<a class="code" href="classTransportAddress.html#a026e777c423ff2a0280edd2fa5472e74" title="indicates if TransportAddress is specified">isUnspecified</a>()) {
<a name="l00727"></a>00727         <a class="code" href="classVast.html#a9f49980680ed52219a6ef0a1bcff412b">changeState</a>(<a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>);
<a name="l00728"></a>00728     }
<a name="l00729"></a>00729     <span class="keywordflow">else</span> {
<a name="l00730"></a>00730         <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastMsg = <span class="keyword">new</span> <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a>(<span class="stringliteral">&quot;JOIN_REQUEST&quot;</span>);
<a name="l00731"></a>00731         vastMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="GiaMessage__m_8h.html#ac712f468e66678ffb5df03be6d6a8157a71fec090ff88ece51771bbbf434064ec">JOIN_REQUEST</a>);
<a name="l00732"></a>00732         vastMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#ab6942347876cb4befb4da670eb90871f">VAST_L</a>(vastMsg));
<a name="l00733"></a>00733         <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastMsg, joinNode);
<a name="l00734"></a>00734     }
<a name="l00735"></a>00735 }
<a name="l00736"></a>00736 
<a name="l00737"></a><a class="code" href="classVast.html#a092f27883a3661a5b1ffe905e68df738">00737</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a092f27883a3661a5b1ffe905e68df738">Vast::handleMove</a>(<a class="code" href="classGameAPIPositionMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIPositionMessage</a>* sgcMsg)
<a name="l00738"></a>00738 {
<a name="l00739"></a>00739     <a class="code" href="classVector2D.html">Vector2D</a> pos = sgcMsg-&gt;<a class="code" href="classGameAPIPositionMessage.html#a62cb5e229193a2e0118e240de2494d53">getPosition</a>();
<a name="l00740"></a>00740     <span class="comment">// test if new position is legal</span>
<a name="l00741"></a>00741     <span class="keywordflow">if</span>(<a class="code" href="classVast.html#a72ef8a625cc4c37c0513fc842bd09470">Positions</a>.find(pos) != <a class="code" href="classVast.html#a72ef8a625cc4c37c0513fc842bd09470">Positions</a>.end()) {
<a name="l00742"></a>00742         <a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a> *gameMsg = <span class="keyword">new</span> <a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a>(<span class="stringliteral">&quot;MOVEMENT_REQUEST&quot;</span>);
<a name="l00743"></a>00743         gameMsg-&gt;<a class="code" href="classGameAPIMessage.html#a3c12a88e720037a70248b0db6a46fc99">setCommand</a>(<a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6baebd21087dd4fccf5bea6d56c351f76d1">MOVEMENT_REQUEST</a>);
<a name="l00744"></a>00744         <a class="code" href="classVast.html#ad3da9d482e3f5e50e0555cb561805320">sendToApp</a>(gameMsg);
<a name="l00745"></a>00745         <span class="keywordflow">return</span>;
<a name="l00746"></a>00746     }
<a name="l00747"></a>00747     <span class="comment">// set new position</span>
<a name="l00748"></a>00748     <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a> = pos;
<a name="l00749"></a>00749     <span class="comment">// update voronoi</span>
<a name="l00750"></a>00750     <a class="code" href="classVast.html#aac593b11c556c63cbdb49984bc6e9b34">buildVoronoi</a>();
<a name="l00751"></a>00751     <a class="code" href="classVast.html#afe368cd0468509b32f40acfc196a1856">synchronizeApp</a>();
<a name="l00752"></a>00752     <a class="code" href="classVast.html#ac0eb8a31568b3fbec02f6251e7d05e46">removeNeighbors</a>();
<a name="l00753"></a>00753     <span class="comment">// send position update to neighbors</span>
<a name="l00754"></a>00754     <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00755"></a>00755         <a class="code" href="classVastMoveMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMoveMessage</a> *vastMoveMsg = <span class="keyword">new</span> <a class="code" href="classVastMoveMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMoveMessage</a>(<span class="stringliteral">&quot;NODE_MOVE&quot;</span>);
<a name="l00756"></a>00756         vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad9745223990da14f545a02e12e727b63">NODE_MOVE</a>);
<a name="l00757"></a>00757         vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#a5e57dca590d5742e7b1846e703f189ee">setNewPos</a>(pos);
<a name="l00758"></a>00758         vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#ad192cbdd59a12fd4b9a40c8bc77d9a3e">setIs_boundary</a>(itSites-&gt;second-&gt;type &amp; <a class="code" href="VastDefs_8h.html#a985bae7b67bcb96c5565a24a5f6d4cba">BOUNDARY</a>);
<a name="l00759"></a>00759         vastMoveMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#a865e3b42837bb08abf934321cf8ea6a7">VASTMOVE_L</a>(vastMoveMsg));
<a name="l00760"></a>00760         <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastMoveMsg, itSites-&gt;second-&gt;addr);
<a name="l00761"></a>00761     }
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00764"></a><a class="code" href="classVast.html#a645e007e0427c40f13eadf6f914f9881">00764</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a645e007e0427c40f13eadf6f914f9881">Vast::handleEvent</a>( <a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a>* msg )
<a name="l00765"></a>00765 {
<a name="l00766"></a>00766     <span class="comment">// send event to neighbors</span>
<a name="l00767"></a>00767     <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00768"></a>00768         <a class="code" href="classVastEventMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastEventMessage</a> *vastMsg = <span class="keyword">new</span> <a class="code" href="classVastEventMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastEventMessage</a>(<span class="stringliteral">&quot;EVENT&quot;</span>);
<a name="l00769"></a>00769         vastMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a0e3f3deef32a4742dc7a553c15c71f51">VAST_EVENT</a>);
<a name="l00770"></a>00770         vastMsg-&gt;encapsulate((cPacket*)msg-&gt;<a class="code" href="classGameAPIMessage.html#a4efd0fa1b03d99fd4f063020d9250077">dup</a>());
<a name="l00771"></a>00771         <span class="comment">// FIXME: Message length!</span>
<a name="l00772"></a>00772         <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastMsg, itSites-&gt;second-&gt;addr);
<a name="l00773"></a>00773     }
<a name="l00774"></a>00774 }
<a name="l00775"></a>00775 
<a name="l00776"></a><a class="code" href="classVast.html#a3b1ec50a85c2e2e6c7c3e081acd1dcd2">00776</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a3b1ec50a85c2e2e6c7c3e081acd1dcd2">Vast::handleJoinRequest</a>(<a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastMsg)
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778     <a class="code" href="classSite.html">Site</a> *forwardSite = NULL;
<a name="l00779"></a>00779     <span class="comment">// start with this node</span>
<a name="l00780"></a>00780     <span class="keywordtype">double</span> min_dist = <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>.<a class="code" href="classVector2D.html#ae01a1f04ce4ee6f09f3fbc72893412cb">distanceSqr</a>(vastMsg-&gt;<a class="code" href="classVastMessage.html#acd4b084b9e888caaaafa0872cd2cd640">getPos</a>());
<a name="l00781"></a>00781     forwardSite = &amp;<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>;
<a name="l00782"></a>00782     <span class="comment">// iterate through all neighbors</span>
<a name="l00783"></a>00783     <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00784"></a>00784         <span class="comment">// dont forward to nodes which are still joining</span>
<a name="l00785"></a>00785         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;coord.distanceSqr(vastMsg-&gt;<a class="code" href="classVastMessage.html#acd4b084b9e888caaaafa0872cd2cd640">getPos</a>()) &lt; min_dist &amp;&amp; itSites-&gt;second-&gt;neighborCount &gt;= 0) {
<a name="l00786"></a>00786             min_dist = itSites-&gt;second-&gt;<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>.<a class="code" href="classVector2D.html#ae01a1f04ce4ee6f09f3fbc72893412cb">distanceSqr</a>(vastMsg-&gt;<a class="code" href="classVastMessage.html#acd4b084b9e888caaaafa0872cd2cd640">getPos</a>());
<a name="l00787"></a>00787             forwardSite = itSites-&gt;second;
<a name="l00788"></a>00788         }
<a name="l00789"></a>00789     }
<a name="l00790"></a>00790     <span class="comment">// do nothing and let node retry with new position if current position is illegal</span>
<a name="l00791"></a>00791     <span class="keywordflow">if</span>(min_dist == 0.0) {
<a name="l00792"></a>00792         <span class="keyword">delete</span> vastMsg;
<a name="l00793"></a>00793     }
<a name="l00794"></a>00794     <span class="keywordflow">else</span> {
<a name="l00795"></a>00795         <span class="comment">// send an acknowledge or forward request if any of our neighbors is closer to joining node</span>
<a name="l00796"></a>00796         <span class="keywordflow">if</span>(forwardSite-&gt;<a class="code" href="classSite.html#a8285244e3eb082cd382c6971b56066a9">type</a> &amp; <a class="code" href="VastDefs_8h.html#ac048bf3907733b6148c78e7345a30525">THIS</a>) {
<a name="l00797"></a>00797             <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastListMsg = <span class="keyword">new</span> <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>(<span class="stringliteral">&quot;JOIN_ACKNOWLEDGE&quot;</span>);
<a name="l00798"></a>00798             vastListMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad2045a15ed8b82d3db379cc54ba0b7d4">JOIN_ACKNOWLEDGE</a>);
<a name="l00799"></a>00799             <span class="comment">// fill neighbors list</span>
<a name="l00800"></a>00800             vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a51421ae8e810c22b4395f0335e6a22b5">setNeighborNodeArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l00801"></a>00801             vastListMsg-&gt;<a class="code" href="classVastListMessage.html#acdf513aff66a23092146597c5904d72e">setNeighborPosArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l00802"></a>00802             <span class="keywordtype">int</span> i = 0;
<a name="l00803"></a>00803             <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00804"></a>00804                 vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a3a43039b97fdc8c2cdab789146a99771">setNeighborNode</a>(i, itSites-&gt;second-&gt;addr);
<a name="l00805"></a>00805                 vastListMsg-&gt;<a class="code" href="classVastListMessage.html#aa4b76d6cf2e98d70a5b742b51525bcc2">setNeighborPos</a>(i, itSites-&gt;second-&gt;coord);
<a name="l00806"></a>00806                 ++i;
<a name="l00807"></a>00807             }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809             vastListMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#afd61f02ed0c547b46d3376a4e4e7dc1c">VASTLIST_L</a>(vastListMsg));
<a name="l00810"></a>00810             <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastListMsg, vastMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>());
<a name="l00811"></a>00811 
<a name="l00812"></a>00812             <span class="comment">// add node to list to propagte its position early</span>
<a name="l00813"></a>00813             <span class="comment">// nieghborCount is set to -1 to indicate node is still joining</span>
<a name="l00814"></a>00814             <a class="code" href="classVast.html#a27eff8db1664e9cd1e081c6dd3a64f42">addNode</a>(vastMsg-&gt;<a class="code" href="classVastMessage.html#acd4b084b9e888caaaafa0872cd2cd640">getPos</a>(), vastMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>(), -1);
<a name="l00815"></a>00815             <span class="comment">// update voronoi with new neighbors</span>
<a name="l00816"></a>00816             <a class="code" href="classVast.html#aac593b11c556c63cbdb49984bc6e9b34">buildVoronoi</a>();
<a name="l00817"></a>00817             <a class="code" href="classVast.html#afe368cd0468509b32f40acfc196a1856">synchronizeApp</a>();
<a name="l00818"></a>00818             <span class="comment">// removeNeighbors();</span>
<a name="l00819"></a>00819             <span class="keyword">delete</span> vastMsg;
<a name="l00820"></a>00820         }
<a name="l00821"></a>00821         <span class="keywordflow">else</span> {
<a name="l00822"></a>00822             <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastMsg, forwardSite-&gt;<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>);
<a name="l00823"></a>00823         }
<a name="l00824"></a>00824     }
<a name="l00825"></a>00825 }
<a name="l00826"></a>00826 
<a name="l00827"></a><a class="code" href="classVast.html#ae3f2d9c26130a6986478513bc281e080">00827</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#ae3f2d9c26130a6986478513bc281e080">Vast::handleJoinAcknowledge</a>(<a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastListMsg)
<a name="l00828"></a>00828 {
<a name="l00829"></a>00829     <span class="comment">// add acceptor node</span>
<a name="l00830"></a>00830     <a class="code" href="classVast.html#a9f49980680ed52219a6ef0a1bcff412b">changeState</a>(<a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>);
<a name="l00831"></a>00831     <a class="code" href="classVast.html#a27eff8db1664e9cd1e081c6dd3a64f42">addNode</a>(vastListMsg-&gt;<a class="code" href="classVastMessage.html#acd4b084b9e888caaaafa0872cd2cd640">getPos</a>(), vastListMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>(), vastListMsg-&gt;<a class="code" href="classVastMessage.html#a91722b2dc4522f9b533db87c9eb9c56e">getNeighborCount</a>());
<a name="l00832"></a>00832     <span class="comment">// add new neighbors</span>
<a name="l00833"></a>00833     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a284ee95a466d4e7c1b4f803acd47be2d">getNeighborNodeArraySize</a>(); i++) {
<a name="l00834"></a>00834         <a class="code" href="classVast.html#a27eff8db1664e9cd1e081c6dd3a64f42">addNode</a>(vastListMsg-&gt;<a class="code" href="classVastListMessage.html#ab21fc36623f45fc11ef02f510b3dceee">getNeighborPos</a>(i), vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a4779058fdfb7630a9ac3658377e033d4">getNeighborNode</a>(i));
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836     <span class="comment">// update voronoi with new neighbors</span>
<a name="l00837"></a>00837     <a class="code" href="classVast.html#aac593b11c556c63cbdb49984bc6e9b34">buildVoronoi</a>();
<a name="l00838"></a>00838     <a class="code" href="classVast.html#afe368cd0468509b32f40acfc196a1856">synchronizeApp</a>();
<a name="l00839"></a>00839     <span class="comment">// removeNeighbors();</span>
<a name="l00840"></a>00840     <span class="comment">// contact new neighbors</span>
<a name="l00841"></a>00841     <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00842"></a>00842         <a class="code" href="classVastMoveMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMoveMessage</a> *vastMoveMsg = <span class="keyword">new</span> <a class="code" href="classVastMoveMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMoveMessage</a>(<span class="stringliteral">&quot;NODE_MOVE&quot;</span>);
<a name="l00843"></a>00843         vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad9745223990da14f545a02e12e727b63">NODE_MOVE</a>);
<a name="l00844"></a>00844         vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#a5e57dca590d5742e7b1846e703f189ee">setNewPos</a>(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>);
<a name="l00845"></a>00845         vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#ad192cbdd59a12fd4b9a40c8bc77d9a3e">setIs_boundary</a>(itSites-&gt;second-&gt;type &amp; <a class="code" href="VastDefs_8h.html#a985bae7b67bcb96c5565a24a5f6d4cba">BOUNDARY</a>);
<a name="l00846"></a>00846         vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#a6fa5bc1106c583d2991f58ab0698bf38">setRequest_list</a>(<span class="keyword">true</span>);
<a name="l00847"></a>00847         vastMoveMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#a865e3b42837bb08abf934321cf8ea6a7">VASTMOVE_L</a>(vastMoveMsg));
<a name="l00848"></a>00848         <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastMoveMsg, itSites-&gt;second-&gt;addr);
<a name="l00849"></a>00849     }
<a name="l00850"></a>00850 }
<a name="l00851"></a>00851 
<a name="l00852"></a><a class="code" href="classVast.html#a9a1ea2b26ce93b38b226fd0eeb494998">00852</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a9a1ea2b26ce93b38b226fd0eeb494998">Vast::handleNodeMove</a>(<a class="code" href="classVastMoveMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMoveMessage</a> *vastMoveMsg)
<a name="l00853"></a>00853 {
<a name="l00854"></a>00854     <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(
<a name="l00855"></a>00855             <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(
<a name="l00856"></a>00856                 <span class="stringliteral">&quot;Vast: MoveDelay&quot;</span>,
<a name="l00857"></a>00857                 SIMTIME_DBL(simTime()) - SIMTIME_DBL(vastMoveMsg-&gt;getCreationTime())
<a name="l00858"></a>00858                 );
<a name="l00859"></a>00859             );
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     <a class="code" href="classVector2D.html">Vector2D</a> old_p, new_p;
<a name="l00862"></a>00862     old_p = vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#acd4b084b9e888caaaafa0872cd2cd640">getPos</a>();
<a name="l00863"></a>00863     new_p = vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#a6b79e923f8cf72150b2b59e5c0f2a59c">getNewPos</a>();
<a name="l00864"></a>00864     <a class="code" href="classVast.html#a27eff8db1664e9cd1e081c6dd3a64f42">addNode</a>(new_p, vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>(), vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#a91722b2dc4522f9b533db87c9eb9c56e">getNeighborCount</a>());
<a name="l00865"></a>00865     <span class="comment">// update voronoi with new neighbor detection or without</span>
<a name="l00866"></a>00866     <span class="keywordflow">if</span>(vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#a4ff4ff5bbee058b7ecb88066f24a1955">getIs_boundary</a>() || vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#ac3a4b30c70da42a1d9fefba6d4b0a762">getRequest_list</a>()) {
<a name="l00867"></a>00867         <a class="code" href="classVast.html#aac593b11c556c63cbdb49984bc6e9b34">buildVoronoi</a>(old_p, new_p, vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>()); <span class="comment">// enhanced enclosing check</span>
<a name="l00868"></a>00868         <a class="code" href="classVast.html#afe368cd0468509b32f40acfc196a1856">synchronizeApp</a>(vastMoveMsg);
<a name="l00869"></a>00869         <span class="comment">// removeNeighbors();</span>
<a name="l00870"></a>00870         <span class="comment">// send new neighbors</span>
<a name="l00871"></a>00871         <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastListMsg = <span class="keyword">new</span> <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>(<span class="stringliteral">&quot;NEW_NEIGHBORS&quot;</span>);
<a name="l00872"></a>00872         vastListMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fa3aafac4a63883acb0402e9a5dcae8110">NEW_NEIGHBORS</a>);
<a name="l00873"></a>00873 
<a name="l00874"></a>00874         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a51421ae8e810c22b4395f0335e6a22b5">setNeighborNodeArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l00875"></a>00875         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#acdf513aff66a23092146597c5904d72e">setNeighborPosArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l00876"></a>00876 
<a name="l00877"></a>00877         <span class="keywordtype">int</span> i = 0;
<a name="l00878"></a>00878         <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00879"></a>00879             <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type &amp; <a class="code" href="VastDefs_8h.html#ab6bca16ed021b1e211fde8669758f199">NEW</a> || vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#ac3a4b30c70da42a1d9fefba6d4b0a762">getRequest_list</a>()) {
<a name="l00880"></a>00880                 vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a3a43039b97fdc8c2cdab789146a99771">setNeighborNode</a>(i, itSites-&gt;second-&gt;addr);
<a name="l00881"></a>00881                 vastListMsg-&gt;<a class="code" href="classVastListMessage.html#aa4b76d6cf2e98d70a5b742b51525bcc2">setNeighborPos</a>(i, itSites-&gt;second-&gt;coord);
<a name="l00882"></a>00882                 ++i;
<a name="l00883"></a>00883             }
<a name="l00884"></a>00884         }
<a name="l00885"></a>00885         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a51421ae8e810c22b4395f0335e6a22b5">setNeighborNodeArraySize</a>(i);
<a name="l00886"></a>00886         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#acdf513aff66a23092146597c5904d72e">setNeighborPosArraySize</a>(i);
<a name="l00887"></a>00887         vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a9872572935b3ac570e3e47b112619578">setRequestEnclosingNeighbors</a>(<span class="keyword">true</span>);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889         vastListMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#afd61f02ed0c547b46d3376a4e4e7dc1c">VASTLIST_L</a>(vastListMsg));
<a name="l00890"></a>00890         <span class="keywordflow">if</span>(vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a284ee95a466d4e7c1b4f803acd47be2d">getNeighborNodeArraySize</a>() &gt; 0) {
<a name="l00891"></a>00891             <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastListMsg, vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>());
<a name="l00892"></a>00892         }
<a name="l00893"></a>00893         <span class="keywordflow">else</span> {
<a name="l00894"></a>00894             <span class="keyword">delete</span> vastListMsg;
<a name="l00895"></a>00895         }
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897     <span class="keywordflow">else</span> {
<a name="l00898"></a>00898         <span class="comment">// buildVoronoi();</span>
<a name="l00899"></a>00899         <a class="code" href="classVast.html#afe368cd0468509b32f40acfc196a1856">synchronizeApp</a>(vastMoveMsg);
<a name="l00900"></a>00900         <span class="comment">// removeNeighbors();</span>
<a name="l00901"></a>00901     }
<a name="l00902"></a>00902 }
<a name="l00903"></a>00903 
<a name="l00904"></a><a class="code" href="classVast.html#a50d7f96259000a44b65ee3951cb75ef5">00904</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a50d7f96259000a44b65ee3951cb75ef5">Vast::handleNewNeighbors</a>(<a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastListMsg)
<a name="l00905"></a>00905 {
<a name="l00906"></a>00906     <span class="comment">// add new neighbors</span>
<a name="l00907"></a>00907     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a284ee95a466d4e7c1b4f803acd47be2d">getNeighborNodeArraySize</a>(); i++) {
<a name="l00908"></a>00908         <a class="code" href="classVast.html#a27eff8db1664e9cd1e081c6dd3a64f42">addNode</a>(vastListMsg-&gt;<a class="code" href="classVastListMessage.html#ab21fc36623f45fc11ef02f510b3dceee">getNeighborPos</a>(i), vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a4779058fdfb7630a9ac3658377e033d4">getNeighborNode</a>(i));
<a name="l00909"></a>00909 
<a name="l00910"></a>00910         <span class="keywordflow">if</span>(vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a310301deb6e923737554b28876e39d13">getRequestEnclosingNeighbors</a>()) {
<a name="l00911"></a>00911             <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastMsg = <span class="keyword">new</span> <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a>(<span class="stringliteral">&quot;ENCLOSING_NEIGHBORS_REQUEST&quot;</span>);
<a name="l00912"></a>00912             vastMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a328174aefc34e2aa1577e73ca6e0eb70">ENCLOSING_NEIGHBORS_REQUEST</a>);
<a name="l00913"></a>00913             vastMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#ab6942347876cb4befb4da670eb90871f">VAST_L</a>(vastMsg));
<a name="l00914"></a>00914             <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastMsg, vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a4779058fdfb7630a9ac3658377e033d4">getNeighborNode</a>(i));
<a name="l00915"></a>00915         }
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917     <span class="comment">// update voronoi with new neighbors</span>
<a name="l00918"></a>00918 <span class="comment">//    buildVoronoi();</span>
<a name="l00919"></a>00919 <span class="comment">//    synchronizeApp();</span>
<a name="l00920"></a>00920     <span class="comment">// removeNeighbors();</span>
<a name="l00921"></a>00921 }
<a name="l00922"></a>00922 
<a name="l00923"></a><a class="code" href="classVast.html#aa5b06ce84e80dfe3f274327a8cebf3d9">00923</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#aa5b06ce84e80dfe3f274327a8cebf3d9">Vast::handleNodeLeave</a>(<a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastListMsg)
<a name="l00924"></a>00924 {
<a name="l00925"></a>00925     <a class="code" href="classVast.html#a3e7c0afd3098cc61ede525a6a59fb71f">removeNode</a>(vastListMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>());
<a name="l00926"></a>00926     <span class="comment">// add possible new neighbors</span>
<a name="l00927"></a>00927     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a284ee95a466d4e7c1b4f803acd47be2d">getNeighborNodeArraySize</a>(); i++) {
<a name="l00928"></a>00928         <a class="code" href="classVast.html#a27eff8db1664e9cd1e081c6dd3a64f42">addNode</a>(vastListMsg-&gt;<a class="code" href="classVastListMessage.html#ab21fc36623f45fc11ef02f510b3dceee">getNeighborPos</a>(i), vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a4779058fdfb7630a9ac3658377e033d4">getNeighborNode</a>(i));
<a name="l00929"></a>00929     }
<a name="l00930"></a>00930     <span class="comment">// update voronoi with new neighbors</span>
<a name="l00931"></a>00931     <span class="comment">// buildVoronoi();</span>
<a name="l00932"></a>00932     <span class="comment">// synchronizeApp();</span>
<a name="l00933"></a>00933     <span class="comment">// removeNeighbors();</span>
<a name="l00934"></a>00934 }
<a name="l00935"></a>00935 
<a name="l00936"></a><a class="code" href="classVast.html#adde7e0c8aab03277a63461d134fc6daa">00936</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#adde7e0c8aab03277a63461d134fc6daa">Vast::handleEnclosingNeighborsRequest</a>(<a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastMsg)
<a name="l00937"></a>00937 {
<a name="l00938"></a>00938     <span class="comment">// send new neighbors</span>
<a name="l00939"></a>00939     <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastListMsg = <span class="keyword">new</span> <a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a>(<span class="stringliteral">&quot;NEW_NEIGHBORS&quot;</span>);
<a name="l00940"></a>00940     vastListMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fa3aafac4a63883acb0402e9a5dcae8110">NEW_NEIGHBORS</a>);
<a name="l00941"></a>00941 
<a name="l00942"></a>00942     vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a51421ae8e810c22b4395f0335e6a22b5">setNeighborNodeArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l00943"></a>00943     vastListMsg-&gt;<a class="code" href="classVastListMessage.html#acdf513aff66a23092146597c5904d72e">setNeighborPosArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <span class="keywordtype">int</span> i = 0;
<a name="l00946"></a>00946     <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l00947"></a>00947         <span class="keywordflow">if</span>((itSites-&gt;second-&gt;type &amp; <a class="code" href="VastDefs_8h.html#a2aedfe59324ff558559ff9932c649443">ENCLOSING</a>) &amp;&amp; itSites-&gt;second-&gt;addr != vastMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>()) {
<a name="l00948"></a>00948             vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a3a43039b97fdc8c2cdab789146a99771">setNeighborNode</a>(i, itSites-&gt;second-&gt;addr);
<a name="l00949"></a>00949             vastListMsg-&gt;<a class="code" href="classVastListMessage.html#aa4b76d6cf2e98d70a5b742b51525bcc2">setNeighborPos</a>(i, itSites-&gt;second-&gt;coord);
<a name="l00950"></a>00950             ++i;
<a name="l00951"></a>00951         }
<a name="l00952"></a>00952     }
<a name="l00953"></a>00953     vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a51421ae8e810c22b4395f0335e6a22b5">setNeighborNodeArraySize</a>(i);
<a name="l00954"></a>00954     vastListMsg-&gt;<a class="code" href="classVastListMessage.html#acdf513aff66a23092146597c5904d72e">setNeighborPosArraySize</a>(i);
<a name="l00955"></a>00955 
<a name="l00956"></a>00956     vastListMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#afd61f02ed0c547b46d3376a4e4e7dc1c">VASTLIST_L</a>(vastListMsg));
<a name="l00957"></a>00957     <span class="keywordflow">if</span>(vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a284ee95a466d4e7c1b4f803acd47be2d">getNeighborNodeArraySize</a>() &gt; 0) {
<a name="l00958"></a>00958         <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastListMsg, vastMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>());
<a name="l00959"></a>00959     }
<a name="l00960"></a>00960     <span class="keywordflow">else</span> {
<a name="l00961"></a>00961         <span class="keyword">delete</span> vastListMsg;
<a name="l00962"></a>00962     }
<a name="l00963"></a>00963 }
<a name="l00964"></a>00964 
<a name="l00965"></a><a class="code" href="classVast.html#a7183562b322a046e2f23f8f8f668fdca">00965</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a7183562b322a046e2f23f8f8f668fdca">Vast::handleBackupNeighbors</a>(<a class="code" href="classVastListMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastListMessage</a> *vastListMsg)
<a name="l00966"></a>00966 {
<a name="l00967"></a>00967     <span class="comment">// add new neighbors to stock list</span>
<a name="l00968"></a>00968     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a284ee95a466d4e7c1b4f803acd47be2d">getNeighborNodeArraySize</a>(); i++) {
<a name="l00969"></a>00969         <span class="keywordflow">if</span>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a4779058fdfb7630a9ac3658377e033d4">getNeighborNode</a>(i)) == <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end()) {
<a name="l00970"></a>00970             <a class="code" href="classVast.html#a35d59294c560dd21f9ac30729eddfdb2">addNodeToStock</a>(vastListMsg-&gt;<a class="code" href="classVastListMessage.html#a4779058fdfb7630a9ac3658377e033d4">getNeighborNode</a>(i));
<a name="l00971"></a>00971         }
<a name="l00972"></a>00972     }
<a name="l00973"></a>00973 }
<a name="l00974"></a>00974 
<a name="l00975"></a><a class="code" href="classVast.html#a1361682de85c7ecc63476b0a9db712f0">00975</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a1361682de85c7ecc63476b0a9db712f0">Vast::handlePing</a>(<a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastMsg)
<a name="l00976"></a>00976 {
<a name="l00977"></a>00977     <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastPongMsg = <span class="keyword">new</span> <a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a>(<span class="stringliteral">&quot;PONG&quot;</span>);
<a name="l00978"></a>00978     vastPongMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607ae911a27de4bca30604be3515f31b2057">PONG</a>);
<a name="l00979"></a>00979     vastPongMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#ab6942347876cb4befb4da670eb90871f">VAST_L</a>(vastPongMsg));
<a name="l00980"></a>00980     <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastPongMsg, vastMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>());
<a name="l00981"></a>00981 }
<a name="l00982"></a>00982 
<a name="l00983"></a><a class="code" href="classVast.html#a183cca07bd6ddceb33eebfba75bf1b80">00983</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a183cca07bd6ddceb33eebfba75bf1b80">Vast::handlePong</a>(<a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastMsg)
<a name="l00984"></a>00984 {
<a name="l00985"></a>00985     <span class="comment">// replace entry cause it was probably outdated</span>
<a name="l00986"></a>00986     <a class="code" href="classVast.html#a27eff8db1664e9cd1e081c6dd3a64f42">addNode</a>(vastMsg-&gt;<a class="code" href="classVastMessage.html#acd4b084b9e888caaaafa0872cd2cd640">getPos</a>(), vastMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>(), vastMsg-&gt;<a class="code" href="classVastMessage.html#a91722b2dc4522f9b533db87c9eb9c56e">getNeighborCount</a>());
<a name="l00987"></a>00987     <span class="comment">// update voronoi</span>
<a name="l00988"></a>00988     <span class="comment">//buildVoronoi();</span>
<a name="l00989"></a>00989     <span class="comment">//synchronizeApp();</span>
<a name="l00990"></a>00990     <span class="comment">// removeNeighbors();</span>
<a name="l00991"></a>00991 }
<a name="l00992"></a>00992 
<a name="l00993"></a><a class="code" href="classVast.html#ac8599f81539fdaee6cd4cfd5cca2b8f4">00993</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#ac8599f81539fdaee6cd4cfd5cca2b8f4">Vast::handleDiscardNode</a>(<a class="code" href="classVastDiscardMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastDiscardMessage</a> *vastMsg)
<a name="l00994"></a>00994 {
<a name="l00995"></a>00995     <span class="comment">// discard outdated entry</span>
<a name="l00996"></a>00996     <a class="code" href="classVast.html#a3e7c0afd3098cc61ede525a6a59fb71f">removeNode</a>(vastMsg-&gt;<a class="code" href="classVastDiscardMessage.html#ab1aafc5df134ef62c4af2ef06ca87b25">getDiscardNode</a>());
<a name="l00997"></a>00997     <span class="comment">// update voronoi</span>
<a name="l00998"></a>00998     <span class="comment">//buildVoronoi();</span>
<a name="l00999"></a>00999     <span class="comment">//synchronizeApp();</span>
<a name="l01000"></a>01000     <span class="comment">// removeNeighbors();</span>
<a name="l01001"></a>01001 }
<a name="l01002"></a>01002 
<a name="l01003"></a><a class="code" href="classVast.html#a23e724cfc93976442b57ed98c60b585d">01003</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a23e724cfc93976442b57ed98c60b585d">Vast::sendDiscardNode</a>(<a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastMsg)
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005     <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> discardNode;
<a name="l01006"></a>01006     discardNode.<a class="code" href="classTransportAddress.html#a1c7b834dc2e6e738f1f4db8711a12814" title="Sets the ip address, port and NAT type.">setIp</a>(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>());
<a name="l01007"></a>01007     discardNode.<a class="code" href="classNodeHandle.html#af3992f1fda9ea42dc10bf4739e47700a" title="saves given key to NodeHandle::key">setKey</a>(vastMsg-&gt;<a class="code" href="classVastMessage.html#a9c9cdb5c0fbbdc0835ec81958c149a42">getDestKey</a>());
<a name="l01008"></a>01008     <span class="comment">// send message</span>
<a name="l01009"></a>01009     <a class="code" href="classVastDiscardMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastDiscardMessage</a> *vastDiscardMsg = <span class="keyword">new</span> <a class="code" href="classVastDiscardMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastDiscardMessage</a>(<span class="stringliteral">&quot;DISCARD_NODE&quot;</span>);
<a name="l01010"></a>01010     vastDiscardMsg-&gt;<a class="code" href="classVastMessage.html#a87de369621441a358ebd786b6e84f415">setCommand</a>(<a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607ad62d6ba53c9c3efbda433545708a79b5">DISCARD_NODE</a>);
<a name="l01011"></a>01011     vastDiscardMsg-&gt;<a class="code" href="classVastDiscardMessage.html#aefd10b1de82b010aaa6a597d4b00f4f5">setDiscardNode</a>(discardNode);
<a name="l01012"></a>01012     <span class="comment">// debug output</span>
<a name="l01013"></a>01013     <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) EV &lt;&lt; <span class="stringliteral">&quot;[Vast::sendDiscardNode() @ &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l01014"></a>01014                        &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l01015"></a>01015                        &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; is leaving the overlay.&quot;</span>
<a name="l01016"></a>01016                        &lt;&lt; endl;
<a name="l01017"></a>01017     vastDiscardMsg-&gt;setBitLength(<a class="code" href="Vast__m_8h.html#afd16ed69aea89cb14af62cfcf3ebaf64">VASTDISCARD_L</a>(vastDiscardMsg));
<a name="l01018"></a>01018     <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">sendMessage</a>(vastDiscardMsg, vastMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>());
<a name="l01019"></a>01019 }
<a name="l01020"></a>01020 
<a name="l01021"></a><a class="code" href="classVast.html#afe368cd0468509b32f40acfc196a1856">01021</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#afe368cd0468509b32f40acfc196a1856">Vast::synchronizeApp</a>(<a class="code" href="classVastMoveMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMoveMessage</a> *vastMoveMsg)
<a name="l01022"></a>01022 {
<a name="l01023"></a>01023     <a class="code" href="classGameAPIListMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIListMessage</a> *sgcMsg = <span class="keyword">new</span> <a class="code" href="classGameAPIListMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIListMessage</a>(<span class="stringliteral">&quot;NEIGHBOR_UPDATE&quot;</span>);
<a name="l01024"></a>01024     sgcMsg-&gt;<a class="code" href="classGameAPIMessage.html#a3c12a88e720037a70248b0db6a46fc99">setCommand</a>(<a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba360dbdf5c7f61a4d26263e2a010057d7">NEIGHBOR_UPDATE</a>);
<a name="l01025"></a>01025 
<a name="l01026"></a>01026     sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6cc71a3065a72e5636753f4e0904ad38">setRemoveNeighborArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l01027"></a>01027     sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6bac1604abbdf9c0ec959343b7b64834">setAddNeighborArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size() + 1);
<a name="l01028"></a>01028     sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a81292ede7c0903f5982efcc7625024f1">setNeighborPositionArraySize</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size() + 1);
<a name="l01029"></a>01029 
<a name="l01030"></a>01030     <span class="keywordtype">int</span> remSize, addSize;
<a name="l01031"></a>01031     remSize = addSize = 0;
<a name="l01032"></a>01032     <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l01033"></a>01033         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type == <a class="code" href="VastDefs_8h.html#abde25a67f4046530ae1c572cefeb5869">UNDEF</a>) {
<a name="l01034"></a>01034             sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a1a1ada09672c98b3a21eff0a6021d42c">setRemoveNeighbor</a>(remSize, itSites-&gt;second-&gt;addr);
<a name="l01035"></a>01035             ++remSize;
<a name="l01036"></a>01036         }
<a name="l01037"></a>01037         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!itSites-&gt;second-&gt;isAdded) {
<a name="l01038"></a>01038             sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#ad0a32a6a2f89f49e1824578e0b7a640a">setAddNeighbor</a>(addSize, itSites-&gt;second-&gt;addr);
<a name="l01039"></a>01039             sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a32b3e775c8f0f5b850bf3047f7ddc30f">setNeighborPosition</a>(addSize, itSites-&gt;second-&gt;coord);
<a name="l01040"></a>01040             itSites-&gt;second-&gt;isAdded = <span class="keyword">true</span>;
<a name="l01041"></a>01041             ++addSize;
<a name="l01042"></a>01042         }
<a name="l01043"></a>01043     }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     <span class="keywordflow">if</span>(vastMoveMsg &amp;&amp;
<a name="l01046"></a>01046        <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>()) != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end() &amp;&amp;
<a name="l01047"></a>01047        <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.find(vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>())-&gt;second-&gt;isAdded) {
<a name="l01048"></a>01048         sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#ad0a32a6a2f89f49e1824578e0b7a640a">setAddNeighbor</a>(addSize, vastMoveMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>());
<a name="l01049"></a>01049         sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a32b3e775c8f0f5b850bf3047f7ddc30f">setNeighborPosition</a>(addSize, vastMoveMsg-&gt;<a class="code" href="classVastMoveMessage.html#a6b79e923f8cf72150b2b59e5c0f2a59c">getNewPos</a>());
<a name="l01050"></a>01050         ++addSize;
<a name="l01051"></a>01051     }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6cc71a3065a72e5636753f4e0904ad38">setRemoveNeighborArraySize</a>(remSize);
<a name="l01054"></a>01054     sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6bac1604abbdf9c0ec959343b7b64834">setAddNeighborArraySize</a>(addSize);
<a name="l01055"></a>01055     sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a81292ede7c0903f5982efcc7625024f1">setNeighborPositionArraySize</a>(addSize);
<a name="l01056"></a>01056 
<a name="l01057"></a>01057     <span class="keywordflow">if</span>(sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#ae59494fd094b6d8c365675aacc7b680b">getAddNeighborArraySize</a>() || sgcMsg-&gt;<a class="code" href="classGameAPIListMessage.html#acf76a431085300d7ee4ba9f32f63d4e9">getRemoveNeighborArraySize</a>()) {
<a name="l01058"></a>01058         <a class="code" href="classVast.html#ad3da9d482e3f5e50e0555cb561805320">sendToApp</a>(sgcMsg);
<a name="l01059"></a>01059     }
<a name="l01060"></a>01060     <span class="keywordflow">else</span> {
<a name="l01061"></a>01061         <span class="keyword">delete</span> sgcMsg;
<a name="l01062"></a>01062     }
<a name="l01063"></a>01063 }
<a name="l01064"></a>01064 
<a name="l01065"></a><a class="code" href="classVast.html#ad3da9d482e3f5e50e0555cb561805320">01065</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#ad3da9d482e3f5e50e0555cb561805320">Vast::sendToApp</a>(cMessage *msg)
<a name="l01066"></a>01066 {
<a name="l01067"></a>01067     <span class="comment">// debug output</span>
<a name="l01068"></a>01068     <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) EV &lt;&lt; <span class="stringliteral">&quot;[Vast::sendToApp() @ &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l01069"></a>01069                        &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l01070"></a>01070                        &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; sending &quot;</span> &lt;&lt; msg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; to application.&quot;</span>
<a name="l01071"></a>01071                        &lt;&lt; endl;
<a name="l01072"></a>01072     send(msg, <span class="stringliteral">&quot;appOut&quot;</span>);
<a name="l01073"></a>01073 }
<a name="l01074"></a>01074 
<a name="l01075"></a><a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">01075</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a746611132de4dcbba0ece46cf75798b6">Vast::sendMessage</a>(<a class="code" href="classVastMessage.html" title="Class generated from overlay/vast/Vast.msg by opp_msgc.">VastMessage</a> *vastMsg, <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> destAddr)
<a name="l01076"></a>01076 {
<a name="l01077"></a>01077     <span class="comment">// collect statistics</span>
<a name="l01078"></a>01078     <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(
<a name="l01079"></a>01079         <span class="keywordflow">switch</span>(vastMsg-&gt;<a class="code" href="classVastMessage.html#a4faf79e8d3e56ae8b1007468d64f415e">getCommand</a>()) {
<a name="l01080"></a>01080             <span class="keywordflow">case</span> <a class="code" href="GiaMessage__m_8h.html#ac712f468e66678ffb5df03be6d6a8157a71fec090ff88ece51771bbbf434064ec">JOIN_REQUEST</a>: {
<a name="l01081"></a>01081                 <a class="code" href="classVast.html#a8cae35144fc3d3615ca900f4a5d016f5">joinRequestBytesSent</a> += vastMsg-&gt;getByteLength();
<a name="l01082"></a>01082             } <span class="keywordflow">break</span>;
<a name="l01083"></a>01083             <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad2045a15ed8b82d3db379cc54ba0b7d4">JOIN_ACKNOWLEDGE</a>: {
<a name="l01084"></a>01084                 <a class="code" href="classVast.html#af1b66db4acda86bc53121f530ad3305f">joinAcknowledgeBytesSent</a> += vastMsg-&gt;getByteLength();
<a name="l01085"></a>01085             } <span class="keywordflow">break</span>;
<a name="l01086"></a>01086             <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad9745223990da14f545a02e12e727b63">NODE_MOVE</a>: {
<a name="l01087"></a>01087                 <a class="code" href="classVast.html#ae7e6d853f952734f8e1c41d5c3f82dd3">nodeMoveBytesSent</a> += vastMsg-&gt;getByteLength();
<a name="l01088"></a>01088             } <span class="keywordflow">break</span>;
<a name="l01089"></a>01089             <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fa3aafac4a63883acb0402e9a5dcae8110">NEW_NEIGHBORS</a>: {
<a name="l01090"></a>01090                 <a class="code" href="classVast.html#a0bb1c36ab41d09526a7b54433b2a1f54">newNeighborsBytesSent</a> += vastMsg-&gt;getByteLength();
<a name="l01091"></a>01091             } <span class="keywordflow">break</span>;
<a name="l01092"></a>01092             <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fac2f6b0a84b96ac134911c0d532a4a91c">NODE_LEAVE</a>: {
<a name="l01093"></a>01093                 <a class="code" href="classVast.html#aec8877ef5725ece7aa4f1e7dc6ec47c6">nodeLeaveBytesSent</a> += vastMsg-&gt;getByteLength();
<a name="l01094"></a>01094             } <span class="keywordflow">break</span>;
<a name="l01095"></a>01095             <span class="keywordflow">case</span> <a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a328174aefc34e2aa1577e73ca6e0eb70">ENCLOSING_NEIGHBORS_REQUEST</a>: {
<a name="l01096"></a>01096                 <a class="code" href="classVast.html#a42fa22094150446e8b0d2e2e2c58ef02">enclosingNeighborsRequestBytesSent</a> += vastMsg-&gt;getByteLength();
<a name="l01097"></a>01097             } <span class="keywordflow">break</span>;
<a name="l01098"></a>01098             <span class="keywordflow">case</span> <a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607a3a95ef902bc659901cceef98e0bc8041">PING</a>: {
<a name="l01099"></a>01099                 <a class="code" href="classVast.html#afea7ca8faed771a898b0daa3cffafeeb">pingBytesSent</a> += vastMsg-&gt;getByteLength();
<a name="l01100"></a>01100             } <span class="keywordflow">break</span>;
<a name="l01101"></a>01101             <span class="keywordflow">case</span> <a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607ae911a27de4bca30604be3515f31b2057">PONG</a>: {
<a name="l01102"></a>01102                 <a class="code" href="classVast.html#af8a09f477664314710211ec69de5944f">pongBytesSent</a> += vastMsg-&gt;getByteLength();
<a name="l01103"></a>01103             } <span class="keywordflow">break</span>;
<a name="l01104"></a>01104             <span class="keywordflow">case</span> <a class="code" href="Vast__m_8h.html#affe4c21be5de8586938eff67f154b607ad62d6ba53c9c3efbda433545708a79b5">DISCARD_NODE</a>: {
<a name="l01105"></a>01105                 <a class="code" href="classVast.html#a53543eccb1be540b3d7875cf0cdd0b52">discardNodeBytesSent</a> += vastMsg-&gt;getByteLength();
<a name="l01106"></a>01106             } <span class="keywordflow">break</span>;
<a name="l01107"></a>01107         }
<a name="l01108"></a>01108         <a class="code" href="classVast.html#af30ae27611d3b281fb3a7f16b329f539">bytesPerSecond</a> += vastMsg-&gt;getByteLength();
<a name="l01109"></a>01109     );
<a name="l01110"></a>01110 
<a name="l01111"></a>01111     <span class="comment">// debug output</span>
<a name="l01112"></a>01112     <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) EV &lt;&lt; <span class="stringliteral">&quot;[Vast::sendMessage() @ &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l01113"></a>01113                        &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l01114"></a>01114                        &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; sending &quot;</span> &lt;&lt; vastMsg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; to &quot;</span> &lt;&lt; destAddr.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>
<a name="l01115"></a>01115                        &lt;&lt; endl;
<a name="l01116"></a>01116     <span class="comment">// set vastbase message stuff</span>
<a name="l01117"></a>01117     vastMsg-&gt;<a class="code" href="classVastMessage.html#ab9503f128fd5f7c00211be85b9794690">setDestKey</a>(destAddr.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l01118"></a>01118     <span class="comment">// fill in sender information only if we are not forwarding a message from another node</span>
<a name="l01119"></a>01119     <span class="comment">// e.g. a joining node</span>
<a name="l01120"></a>01120     <span class="keywordflow">if</span>(vastMsg-&gt;<a class="code" href="classVastMessage.html#a39ede7a350c6cb596d2042bb95f36c59">getSourceNode</a>().<a class="code" href="classNodeHandle.html#ab5136375a4548ced7c2014a73c8743c9" title="indicates if this NodeHandle is specified">isUnspecified</a>()) {
<a name="l01121"></a>01121         vastMsg-&gt;<a class="code" href="classVastMessage.html#a0ca22786d23f8153121258e53e0905fa">setSourceNode</a>(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>);
<a name="l01122"></a>01122         vastMsg-&gt;<a class="code" href="classVastMessage.html#ac3bb0363658bc128e98f37c1be761c60">setPos</a>(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>);
<a name="l01123"></a>01123         vastMsg-&gt;<a class="code" href="classVastMessage.html#adab72387cbfb5f9261f016a88b0a64c2">setNeighborCount</a>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size());
<a name="l01124"></a>01124     }
<a name="l01125"></a>01125 
<a name="l01126"></a>01126     <a class="code" href="classBaseOverlay.html#a124850e5bc8d81b3eb4f3aec75868449" title="Sends message to underlay.">sendMessageToUDP</a>(destAddr, vastMsg);
<a name="l01127"></a>01127 }
<a name="l01128"></a>01128 
<a name="l01129"></a><a class="code" href="classVast.html#a1bfee43b8a5cde362b7ff137f3597c78">01129</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a1bfee43b8a5cde362b7ff137f3597c78">Vast::setBootstrapedIcon</a>()
<a name="l01130"></a>01130 {
<a name="l01131"></a>01131     <span class="keywordflow">if</span>(ev.isGUI()) {
<a name="l01132"></a>01132         <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>) {
<a name="l01133"></a>01133             getParentModule()-&gt;getParentModule()-&gt;getDisplayString().setTagArg(<span class="stringliteral">&quot;i2&quot;</span>, 1, <span class="stringliteral">&quot;green&quot;</span>);
<a name="l01134"></a>01134             getDisplayString().setTagArg(<span class="stringliteral">&quot;i&quot;</span>, 1, <span class="stringliteral">&quot;green&quot;</span>);
<a name="l01135"></a>01135         }
<a name="l01136"></a>01136         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fabe22ce6e9471e472a566ba6cc27fbb5a">JOINING</a>) {
<a name="l01137"></a>01137             getParentModule()-&gt;getParentModule()-&gt;getDisplayString().setTagArg(<span class="stringliteral">&quot;i2&quot;</span>, 1, <span class="stringliteral">&quot;yellow&quot;</span>);
<a name="l01138"></a>01138             getDisplayString().setTagArg(<span class="stringliteral">&quot;i&quot;</span>, 1, <span class="stringliteral">&quot;yellow&quot;</span>);
<a name="l01139"></a>01139         }
<a name="l01140"></a>01140         <span class="keywordflow">else</span> {
<a name="l01141"></a>01141             getParentModule()-&gt;getParentModule()-&gt;getDisplayString().setTagArg(<span class="stringliteral">&quot;i2&quot;</span>, 1, <span class="stringliteral">&quot;red&quot;</span>);
<a name="l01142"></a>01142             getDisplayString().setTagArg(<span class="stringliteral">&quot;i&quot;</span>, 1, <span class="stringliteral">&quot;red&quot;</span>);
<a name="l01143"></a>01143         }
<a name="l01144"></a>01144     }
<a name="l01145"></a>01145 }
<a name="l01146"></a>01146 
<a name="l01147"></a><a class="code" href="classVast.html#a5ebb4aad5fd0a309cae1d09762b6c270">01147</a> <span class="keywordtype">void</span> <a class="code" href="classVast.html#a5ebb4aad5fd0a309cae1d09762b6c270" title="collects statistical data in derived class">Vast::finishOverlay</a>()
<a name="l01148"></a>01148 {
<a name="l01149"></a>01149     <a class="code" href="classBaseOverlay.html#a933e505ea77cae4ab0c8edcb77ade2c7" title="pointer to GlobalNodeList in this node">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#a95a2d64d3d19185ae4e2f24ec13ee5d4" title="Debootstraps peers in the peer set.">removePeer</a>(<a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>);
<a name="l01150"></a>01150 
<a name="l01151"></a>01151 <span class="comment">//    We use our own time count to avoid rounding errors</span>
<a name="l01152"></a>01152 <span class="comment">//    simtime_t time = globalStatistics-&gt;calcMeasuredLifetime(creationTime);</span>
<a name="l01153"></a>01153 <span class="comment">//    if(time == 0) return;</span>
<a name="l01154"></a>01154     <span class="keywordflow">if</span>(<a class="code" href="classVast.html#a120c3c82cafcab0a237fe080e71a4862">secTimerCount</a> == 0) <span class="keywordflow">return</span>;
<a name="l01155"></a>01155 
<a name="l01156"></a>01156     <span class="comment">// collect statistics</span>
<a name="l01157"></a>01157     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: JOIN_REQUEST bytes sent/s&quot;</span>, <a class="code" href="classVast.html#a8cae35144fc3d3615ca900f4a5d016f5">joinRequestBytesSent</a>/(<span class="keywordtype">double</span>) <a class="code" href="classVast.html#a120c3c82cafcab0a237fe080e71a4862">secTimerCount</a>);
<a name="l01158"></a>01158     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: JOIN_ACKNOWLEDGE bytes sent/s&quot;</span>, <a class="code" href="classVast.html#af1b66db4acda86bc53121f530ad3305f">joinAcknowledgeBytesSent</a>/(<span class="keywordtype">double</span>) secTimerCount);
<a name="l01159"></a>01159     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: NODE_MOVE bytes sent/s&quot;</span>, <a class="code" href="classVast.html#ae7e6d853f952734f8e1c41d5c3f82dd3">nodeMoveBytesSent</a>/(<span class="keywordtype">double</span>) secTimerCount);
<a name="l01160"></a>01160     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: NEW_NEIGHBORS bytes sent/s&quot;</span>, <a class="code" href="classVast.html#a0bb1c36ab41d09526a7b54433b2a1f54">newNeighborsBytesSent</a>/(<span class="keywordtype">double</span>) secTimerCount);
<a name="l01161"></a>01161     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: NODE_LEAVE bytes sent/s&quot;</span>, <a class="code" href="classVast.html#aec8877ef5725ece7aa4f1e7dc6ec47c6">nodeLeaveBytesSent</a>/(<span class="keywordtype">double</span>) secTimerCount);
<a name="l01162"></a>01162     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: ENCLOSING_NEIGHBORS_REQUEST bytes sent/s&quot;</span>, <a class="code" href="classVast.html#a42fa22094150446e8b0d2e2e2c58ef02">enclosingNeighborsRequestBytesSent</a>/(<span class="keywordtype">double</span>) secTimerCount);
<a name="l01163"></a>01163     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: PING bytes sent/s&quot;</span>, <a class="code" href="classVast.html#afea7ca8faed771a898b0daa3cffafeeb">pingBytesSent</a>/(<span class="keywordtype">double</span>) secTimerCount);
<a name="l01164"></a>01164     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: PONG bytes sent/s&quot;</span>, <a class="code" href="classVast.html#af8a09f477664314710211ec69de5944f">pongBytesSent</a>/(<span class="keywordtype">double</span>) secTimerCount);
<a name="l01165"></a>01165     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: DISCARD_NODE bytes sent/s&quot;</span>, <a class="code" href="classVast.html#a53543eccb1be540b3d7875cf0cdd0b52">discardNodeBytesSent</a>/(<span class="keywordtype">double</span>) secTimerCount);
<a name="l01166"></a>01166 
<a name="l01167"></a>01167     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: max bytes/second sent&quot;</span>, <a class="code" href="classVast.html#aea94419d8d7589930d1b2e1b4de0468d">maxBytesPerSecondSent</a>);
<a name="l01168"></a>01168     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Vast: average bytes/second sent&quot;</span>, <a class="code" href="classVast.html#a90f9ed7d27fee143970e838e2a7bea15">averageBytesPerSecondSent</a> / (<span class="keywordtype">double</span>) secTimerCount);
<a name="l01169"></a>01169 }
<a name="l01170"></a>01170 
<a name="l01171"></a><a class="code" href="classVast.html#ac3b579a608533fc6f2cf91e0fd79842a">01171</a> <span class="keywordtype">double</span> <a class="code" href="classVast.html#ac3b579a608533fc6f2cf91e0fd79842a">Vast::getAOI</a>()
<a name="l01172"></a>01172 {
<a name="l01173"></a>01173     Enter_Method_Silent();
<a name="l01174"></a>01174     <span class="keywordflow">return</span> <a class="code" href="classVast.html#a4720ff97b3ca3a6f53b9533f57a4fb56">AOI_size</a>;
<a name="l01175"></a>01175 }
<a name="l01176"></a>01176 
<a name="l01177"></a><a class="code" href="classVast.html#aa285352a2262c1a67208cd98659616a3">01177</a> <a class="code" href="classVector2D.html">Vector2D</a> <a class="code" href="classVast.html#aa285352a2262c1a67208cd98659616a3">Vast::getPosition</a>()
<a name="l01178"></a>01178 {
<a name="l01179"></a>01179     Enter_Method_Silent();
<a name="l01180"></a>01180     <span class="keywordflow">return</span> <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a47f1f719668ba23a61049c2178fd4226">coord</a>;
<a name="l01181"></a>01181 }
<a name="l01182"></a>01182 
<a name="l01183"></a><a class="code" href="classVast.html#a48cf3c577c61f00217c6e3e62a90fc9a">01183</a> <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> <a class="code" href="classVast.html#a48cf3c577c61f00217c6e3e62a90fc9a">Vast::getHandle</a>()
<a name="l01184"></a>01184 {
<a name="l01185"></a>01185     Enter_Method_Silent();
<a name="l01186"></a>01186     <span class="keywordflow">return</span> <a class="code" href="classVast.html#a6cc5cbcb1af32443b0ed007af8937073">thisSite</a>.<a class="code" href="classSite.html#a00aa6ee527770673220a97dd7bff3c4a">addr</a>;
<a name="l01187"></a>01187 }
<a name="l01188"></a>01188 
<a name="l01189"></a><a class="code" href="classVast.html#a4861053794596d6f2b7c5c24e44fc345">01189</a> <span class="keywordtype">double</span> <a class="code" href="classVast.html#a4861053794596d6f2b7c5c24e44fc345">Vast::getAreaDimension</a>()
<a name="l01190"></a>01190 {
<a name="l01191"></a>01191     Enter_Method_Silent();
<a name="l01192"></a>01192     <span class="keywordflow">return</span> <a class="code" href="classVast.html#afdc6b6327442ee54b2a92c930966aae6">areaDimension</a>;
<a name="l01193"></a>01193 }
<a name="l01194"></a>01194 
<a name="l01195"></a><a class="code" href="classVast.html#aba314a4b9ab92fe4b19126fae47a0501">01195</a> <a class="code" href="classVast.html#aba314a4b9ab92fe4b19126fae47a0501">Vast::~Vast</a>()
<a name="l01196"></a>01196 {
<a name="l01197"></a>01197     <span class="keywordflow">if</span>(<a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.size()) {
<a name="l01198"></a>01198         <span class="keywordflow">for</span>(SiteMap::iterator itSites = <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.begin(); itSites != <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.end(); ++itSites) {
<a name="l01199"></a>01199             <span class="keyword">delete</span> itSites-&gt;second;
<a name="l01200"></a>01200         }
<a name="l01201"></a>01201         <a class="code" href="classVast.html#aa91c3bc67b42ddb46d9ff6ff0dc9aaf7">Sites</a>.clear();
<a name="l01202"></a>01202         <a class="code" href="classVast.html#a72ef8a625cc4c37c0513fc842bd09470">Positions</a>.clear();
<a name="l01203"></a>01203     }
<a name="l01204"></a>01204     <span class="comment">// destroy self timer messages</span>
<a name="l01205"></a>01205     cancelAndDelete(<a class="code" href="classVast.html#a5679f28e0a58927ef5e707f8eafd9473">join_timer</a>);
<a name="l01206"></a>01206     cancelAndDelete(<a class="code" href="classVast.html#a34548c8fe764d86196e99f3bd8d5b793">ping_timer</a>);
<a name="l01207"></a>01207     cancelAndDelete(<a class="code" href="classVast.html#aff47bd08fb10c41ec16862934b098a4b">sec_timer</a>);
<a name="l01208"></a>01208     cancelAndDelete(<a class="code" href="classVast.html#a12f4439d33e9d3f8928c5cc81f36a141">discovery_timer</a>);
<a name="l01209"></a>01209     cancelAndDelete(<a class="code" href="classVast.html#a6da2c953a461445f77d16764f3545e6e">checkcritical_timer</a>);
<a name="l01210"></a>01210 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 3 2010 14:40:45 for OverSim by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
