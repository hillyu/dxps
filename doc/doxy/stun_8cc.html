<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OverSim: stun.cc File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_668dee661430860db5868c2621a9c372.html">src</a>      </li>
      <li><a class="el" href="dir_12590045ec6dcd64f3c4ad499444ef83.html">underlay</a>      </li>
      <li><a class="el" href="dir_e7abd501ef2699b72177966ee598d65b.html">singlehostunderlay</a>      </li>
      <li><a class="el" href="dir_e172c4d23ca9cdab66e1c382ceb2ddaa.html">stun</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<h1>stun.cc File Reference</h1>  </div>
</div>
<div class="contents">
<code>#include &lt;cassert&gt;</code><br/>
<code>#include &lt;cstring&gt;</code><br/>
<code>#include &lt;iostream&gt;</code><br/>
<code>#include &lt;cstdlib&gt;</code><br/>
<code>#include &lt;errno.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;unistd.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;sys/ioctl.h&gt;</code><br/>
<code>#include &lt;sys/socket.h&gt;</code><br/>
<code>#include &lt;sys/time.h&gt;</code><br/>
<code>#include &lt;sys/types.h&gt;</code><br/>
<code>#include &lt;arpa/inet.h&gt;</code><br/>
<code>#include &lt;fcntl.h&gt;</code><br/>
<code>#include &lt;netdb.h&gt;</code><br/>
<code>#include &lt;netinet/in.h&gt;</code><br/>
<code>#include &lt;arpa/nameser.h&gt;</code><br/>
<code>#include &lt;resolv.h&gt;</code><br/>
<code>#include &lt;net/if.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="stun__udp_8h_source.html">stun_udp.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="stun_8h_source.html">stun.h</a>&quot;</code><br/>

<p><a href="stun_8cc_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a6072c634968940fb89f70b65cf072c6a">NOSSL</a></td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#afdae90956a999518a90595e783525734">computeHmac</a> (char *hmac, const char *input, int length, const char *key, int keySize)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a16624b9ba3d6b2f1c821571fa467c544">stunParseAtrAddress</a> (char *body, unsigned int hdrLen, <a class="el" href="structStunAtrAddress4.html">StunAtrAddress4</a> &amp;result)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#af2f9f10bd394cb42037f1997266b978a">stunParseAtrChangeRequest</a> (char *body, unsigned int hdrLen, <a class="el" href="structStunAtrChangeRequest.html">StunAtrChangeRequest</a> &amp;result)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#afdf35a5dc5c3d6b7109c290308e32887">stunParseAtrError</a> (char *body, unsigned int hdrLen, <a class="el" href="structStunAtrError.html">StunAtrError</a> &amp;result)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a739d3cc61a2a1609b96d535ae74a6221">stunParseAtrUnknown</a> (char *body, unsigned int hdrLen, <a class="el" href="structStunAtrUnknown.html">StunAtrUnknown</a> &amp;result)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a2c161a60854ecb6fe959dff3fe422310">stunParseAtrString</a> (char *body, unsigned int hdrLen, <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;result)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a4e7e4c29e1424831e001c9ffa9b74b53">stunParseAtrIntegrity</a> (char *body, unsigned int hdrLen, <a class="el" href="structStunAtrIntegrity.html">StunAtrIntegrity</a> &amp;result)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#af81c30137f26a4cb158b48aa21f4f681">stunParseMessage</a> (char *buf, unsigned int bufLen, <a class="el" href="structStunMessage.html">StunMessage</a> &amp;msg, bool verbose)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a> (char *buf, <a class="el" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a> data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a9d2486d010a2edf7a8ef74cc44f18de1">encode32</a> (char *buf, <a class="el" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a32bf1e0d5e4833c497c540b4681dd808">encode</a> (char *buf, const char *data, unsigned int length)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a85ef119873a4b4a76012d89f1d6c23fb">encodeAtrAddress4</a> (char *ptr, <a class="el" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a> type, const <a class="el" href="structStunAtrAddress4.html">StunAtrAddress4</a> &amp;atr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a076612a210669e11d7c284f08b3a34b2">encodeAtrChangeRequest</a> (char *ptr, const <a class="el" href="structStunAtrChangeRequest.html">StunAtrChangeRequest</a> &amp;atr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a61a6cc411fa597374048437e28ddffdf">encodeAtrError</a> (char *ptr, const <a class="el" href="structStunAtrError.html">StunAtrError</a> &amp;atr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a09523c814cf26f59012e800713447143">encodeAtrUnknown</a> (char *ptr, const <a class="el" href="structStunAtrUnknown.html">StunAtrUnknown</a> &amp;atr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a3d149acb0bcd480596ea26b73b47d05f">encodeXorOnly</a> (char *ptr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a765920e3cdcc343b0ed69a8fab4a1736">encodeAtrString</a> (char *ptr, <a class="el" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a> type, const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;atr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#ad58a0afd3626cc03abb1d92edbf6c4d3">encodeAtrIntegrity</a> (char *ptr, const <a class="el" href="structStunAtrIntegrity.html">StunAtrIntegrity</a> &amp;atr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">unsigned int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a4f9e869279d41bbf1785d321b4360f61">stunEncodeMessage</a> (const <a class="el" href="structStunMessage.html">StunMessage</a> &amp;msg, char *buf, unsigned int bufLen, const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;password, bool verbose)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a67e399c9420f09178de194bee0bde87a">stunRand</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#ad4a19c401bea76c471959a32a19b777e">stunRandomPort</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">return a random number to use as a port  <a href="#ad4a19c401bea76c471959a32a19b777e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a2c6016ed098c5abccd8fd044c02fb6dc">toHex</a> (const char *buffer, int bufferSize, char *output)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a5f442520a968eaa3f90caa8dcd40bd33">stunCreateUserName</a> (const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;source, <a class="el" href="structStunAtrString.html">StunAtrString</a> *username)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#aa8926aedab40d08f5cff31d759415962">stunCreatePassword</a> (const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;username, <a class="el" href="structStunAtrString.html">StunAtrString</a> *password)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="stun_8h.html#aa1d7d331b6d522d6d9840fece27108d8">UInt64</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a43c07bd7f476e16ea3e48a1033e90ba0">stunGetSystemTimeSecs</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">ostream &amp;&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a8cca5b933ad45c62c8d5e4c82dfb19cc">operator&lt;&lt;</a> (ostream &amp;strm, const <a class="el" href="structUInt128.html">UInt128</a> &amp;r)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">ostream &amp;&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a34a70949080bffbb59fb937092c26802">operator&lt;&lt;</a> (ostream &amp;strm, const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;addr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#af497f133b72e1dc4595d9d293d706351">stunParseHostName</a> (char *peerName, <a class="el" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> &amp;ip, <a class="el" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a> &amp;portVal, <a class="el" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a> defaultPort)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#acc6ab05f9237a355919b963c6835ec9e">stunParseServerName</a> (char *name, <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;addr)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">find the IP address of a the specified stun server - return false is fails parse  <a href="#acc6ab05f9237a355919b963c6835ec9e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a965ceef7c244ec6895b9670acdf57930">stunCreateErrorResponse</a> (<a class="el" href="structStunMessage.html">StunMessage</a> &amp;response, int cl, int number, const char *msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a1382231021dcb9f568718d9a75087f48">stunCreateSharedSecretResponse</a> (const <a class="el" href="structStunMessage.html">StunMessage</a> &amp;request, const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;source, <a class="el" href="structStunMessage.html">StunMessage</a> &amp;response)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a811b0bd40524a040d7ec6676e9635c22">stunServerProcessMsg</a> (char *buf, unsigned int bufLen, <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;from, <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;secondary, <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;myAddr, <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;altAddr, <a class="el" href="structStunMessage.html">StunMessage</a> *resp, <a class="el" href="structStunAddress4.html">StunAddress4</a> *destination, <a class="el" href="structStunAtrString.html">StunAtrString</a> *hmacPassword, bool *changePort, bool *changeIp, bool verbose)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a99639b68ee528c79e96973a2642184a4">stunInitServer</a> (<a class="el" href="structStunServerInfo.html">StunServerInfo</a> &amp;info, const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;myAddr, const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;altAddr, int startMediaPort, bool verbose)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">return true if all is OK Create a media relay and do the STERN thing if startMediaPort is non-zero  <a href="#a99639b68ee528c79e96973a2642184a4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a9ed82a9b4b17f3f4d9bf1fd4d5b8bfd2">stunStopServer</a> (<a class="el" href="structStunServerInfo.html">StunServerInfo</a> &amp;info)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a9c0e750bd19cdfcf4b2b36f9ddefc497">stunServerProcess</a> (<a class="el" href="structStunServerInfo.html">StunServerInfo</a> &amp;info, bool verbose)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">return true if all is OK  <a href="#a9c0e750bd19cdfcf4b2b36f9ddefc497"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a7c8890aa737ed2b41734471121af77a2">stunFindLocalInterfaces</a> (<a class="el" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> *addresses, int maxRet)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">returns number of address found - take array or addres  <a href="#a7c8890aa737ed2b41734471121af77a2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a07bb6d28e9a67cc882184b04c227e82b">stunBuildReqSimple</a> (<a class="el" href="structStunMessage.html">StunMessage</a> *msg, const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;username, bool changePort, bool changeIp, unsigned int id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#ab17bbe96f9bef6d767fbee081ca123d7">stunSendTest</a> (<a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> myFd, <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;dest, const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;username, const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;password, int testNum, bool verbose)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#ae9317a5a127d1281953d961bcfbd2496">stunGetUserNameAndPassword</a> (const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;dest, <a class="el" href="structStunAtrString.html">StunAtrString</a> *username, <a class="el" href="structStunAtrString.html">StunAtrString</a> *password)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a3e28deadbde134f7d00a0f35e70267c6">stunTest</a> (<a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;dest, int testNum, bool verbose, <a class="el" href="structStunAddress4.html">StunAddress4</a> *sAddr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="stun_8h.html#a73736c0f7526e31ef6a35dcc0ebd34ce">NatType</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#a1bcb91a498bf5e73ba5b150c5a698c7d">stunNatType</a> (<a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;dest, bool verbose, bool *preservePort, bool *hairpin, int port, <a class="el" href="structStunAddress4.html">StunAddress4</a> *sAddr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#aa31355ece8353da047608020106c0b60">stunOpenSocket</a> (<a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;dest, <a class="el" href="structStunAddress4.html">StunAddress4</a> *mapAddr, int port, <a class="el" href="structStunAddress4.html">StunAddress4</a> *srcAddr, bool verbose)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="stun_8cc.html#ad45b49d1f841269cea994ca84e8d071b">stunOpenSocketPair</a> (<a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;dest, <a class="el" href="structStunAddress4.html">StunAddress4</a> *mapAddr, int *fd1, int *fd2, int port, <a class="el" href="structStunAddress4.html">StunAddress4</a> *srcAddr, bool verbose)</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a6072c634968940fb89f70b65cf072c6a"></a><!-- doxytag: member="stun.cc::NOSSL" ref="a6072c634968940fb89f70b65cf072c6a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NOSSL</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00036">36</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="afdae90956a999518a90595e783525734"></a><!-- doxytag: member="stun.cc::computeHmac" ref="afdae90956a999518a90595e783525734" args="(char *hmac, const char *input, int length, const char *key, int keySize)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void computeHmac </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>hmac</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>input</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>length</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>keySize</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00723">723</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00802">stunCreatePassword()</a>, <a class="el" href="stun_8cc_source.html#l00764">stunCreateUserName()</a>, and <a class="el" href="stun_8cc_source.html#l00544">stunEncodeMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   strncpy(hmac,<span class="stringliteral">&quot;hmac-not-implemented&quot;</span>,20);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a32bf1e0d5e4833c497c540b4681dd808"></a><!-- doxytag: member="stun.cc::encode" ref="a32bf1e0d5e4833c497c540b4681dd808" args="(char *buf, const char *data, unsigned int length)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* encode </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>length</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00458">458</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00488">encodeAtrError()</a>, <a class="el" href="stun_8cc_source.html#l00534">encodeAtrIntegrity()</a>, <a class="el" href="stun_8cc_source.html#l00522">encodeAtrString()</a>, and <a class="el" href="stun_8cc_source.html#l00544">stunEncodeMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   memcpy(buf, data, length);
   <span class="keywordflow">return</span> buf + length;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a495405bc65a0788775febd87866ece36"></a><!-- doxytag: member="stun.cc::encode16" ref="a495405bc65a0788775febd87866ece36" args="(char *buf, UInt16 data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* encode16 </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a>&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00441">441</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00466">encodeAtrAddress4()</a>, <a class="el" href="stun_8cc_source.html#l00479">encodeAtrChangeRequest()</a>, <a class="el" href="stun_8cc_source.html#l00488">encodeAtrError()</a>, <a class="el" href="stun_8cc_source.html#l00534">encodeAtrIntegrity()</a>, <a class="el" href="stun_8cc_source.html#l00522">encodeAtrString()</a>, <a class="el" href="stun_8cc_source.html#l00501">encodeAtrUnknown()</a>, <a class="el" href="stun_8cc_source.html#l00514">encodeXorOnly()</a>, and <a class="el" href="stun_8cc_source.html#l00544">stunEncodeMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <a class="code" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a> ndata = htons(data);
   memcpy(buf, reinterpret_cast&lt;void*&gt;(&amp;ndata), <span class="keyword">sizeof</span>(<a class="code" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a>));
   <span class="keywordflow">return</span> buf + <span class="keyword">sizeof</span>(UInt16);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9d2486d010a2edf7a8ef74cc44f18de1"></a><!-- doxytag: member="stun.cc::encode32" ref="a9d2486d010a2edf7a8ef74cc44f18de1" args="(char *buf, UInt32 data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* encode32 </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a>&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00449">449</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00466">encodeAtrAddress4()</a>, and <a class="el" href="stun_8cc_source.html#l00479">encodeAtrChangeRequest()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> ndata = htonl(data);
   memcpy(buf, reinterpret_cast&lt;void*&gt;(&amp;ndata), <span class="keyword">sizeof</span>(<a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a>));
   <span class="keywordflow">return</span> buf + <span class="keyword">sizeof</span>(UInt32);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a85ef119873a4b4a76012d89f1d6c23fb"></a><!-- doxytag: member="stun.cc::encodeAtrAddress4" ref="a85ef119873a4b4a76012d89f1d6c23fb" args="(char *ptr, UInt16 type, const StunAtrAddress4 &amp;atr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* encodeAtrAddress4 </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a>&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAtrAddress4.html">StunAtrAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>atr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00466">466</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00544">stunEncodeMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, type);
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, 8);
   *ptr++ = atr.<a class="code" href="structStunAtrAddress4.html#afe6ed0534166b0fd194b23b01ddad7b4">pad</a>;
   *ptr++ = <a class="code" href="stun_8h.html#ac2c7bc41e1b918c98583006fd7025bc5" title="define a structure to hold a stun address">IPv4Family</a>;
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, atr.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>);
   ptr = <a class="code" href="stun_8cc.html#a9d2486d010a2edf7a8ef74cc44f18de1">encode32</a>(ptr, atr.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>);

   <span class="keywordflow">return</span> ptr;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a076612a210669e11d7c284f08b3a34b2"></a><!-- doxytag: member="stun.cc::encodeAtrChangeRequest" ref="a076612a210669e11d7c284f08b3a34b2" args="(char *ptr, const StunAtrChangeRequest &amp;atr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* encodeAtrChangeRequest </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAtrChangeRequest.html">StunAtrChangeRequest</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>atr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00479">479</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00544">stunEncodeMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, <a class="code" href="stun_8h.html#a6183c3f6e20ddc5bf9acd531d37c4b08">ChangeRequest</a>);
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, 4);
   ptr = <a class="code" href="stun_8cc.html#a9d2486d010a2edf7a8ef74cc44f18de1">encode32</a>(ptr, atr.<a class="code" href="structStunAtrChangeRequest.html#adbb006a8e7cc0637d01959c8ba985c0c">value</a>);
   <span class="keywordflow">return</span> ptr;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a61a6cc411fa597374048437e28ddffdf"></a><!-- doxytag: member="stun.cc::encodeAtrError" ref="a61a6cc411fa597374048437e28ddffdf" args="(char *ptr, const StunAtrError &amp;atr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* encodeAtrError </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAtrError.html">StunAtrError</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>atr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00488">488</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00544">stunEncodeMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, <a class="code" href="stun_8h.html#a750ec1534b2aebc05c90b9e6fe9532c7">ErrorCode</a>);
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, 6 + atr.<a class="code" href="structStunAtrError.html#adcac61cdac715d64ebaa78e6847e1108">sizeReason</a>);
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, atr.<a class="code" href="structStunAtrError.html#ae2d32994bcf7387452902e139f2b652f">pad</a>);
   *ptr++ = atr.<a class="code" href="structStunAtrError.html#aef65890aa74d342d326ea74000064be5">errorClass</a>;
   *ptr++ = atr.<a class="code" href="structStunAtrError.html#abdee224c138f23ad06aeb97ed9d6e0fe">number</a>;
   ptr = <a class="code" href="stun_8cc.html#a32bf1e0d5e4833c497c540b4681dd808">encode</a>(ptr, atr.<a class="code" href="structStunAtrError.html#a3bb11d3802d0bfe65a153d8a6bccd472">reason</a>, atr.<a class="code" href="structStunAtrError.html#adcac61cdac715d64ebaa78e6847e1108">sizeReason</a>);
   <span class="keywordflow">return</span> ptr;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad58a0afd3626cc03abb1d92edbf6c4d3"></a><!-- doxytag: member="stun.cc::encodeAtrIntegrity" ref="ad58a0afd3626cc03abb1d92edbf6c4d3" args="(char *ptr, const StunAtrIntegrity &amp;atr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* encodeAtrIntegrity </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAtrIntegrity.html">StunAtrIntegrity</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>atr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00534">534</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00544">stunEncodeMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, <a class="code" href="stun_8h.html#a0371caac677f72f19ea073dd152197f0">MessageIntegrity</a>);
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, 20);
   ptr = <a class="code" href="stun_8cc.html#a32bf1e0d5e4833c497c540b4681dd808">encode</a>(ptr, atr.<a class="code" href="structStunAtrIntegrity.html#a584fa6b758583be87dfad5c10da9fd44">hash</a>, <span class="keyword">sizeof</span>(atr.<a class="code" href="structStunAtrIntegrity.html#a584fa6b758583be87dfad5c10da9fd44">hash</a>));
   <span class="keywordflow">return</span> ptr;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a765920e3cdcc343b0ed69a8fab4a1736"></a><!-- doxytag: member="stun.cc::encodeAtrString" ref="a765920e3cdcc343b0ed69a8fab4a1736" args="(char *ptr, UInt16 type, const StunAtrString &amp;atr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* encodeAtrString </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a>&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>atr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00522">522</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00544">stunEncodeMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert(atr.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> % 4 == 0);

   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, type);
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, atr.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a>);
   ptr = <a class="code" href="stun_8cc.html#a32bf1e0d5e4833c497c540b4681dd808">encode</a>(ptr, atr.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>, atr.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a>);
   <span class="keywordflow">return</span> ptr;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a09523c814cf26f59012e800713447143"></a><!-- doxytag: member="stun.cc::encodeAtrUnknown" ref="a09523c814cf26f59012e800713447143" args="(char *ptr, const StunAtrUnknown &amp;atr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* encodeAtrUnknown </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>ptr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAtrUnknown.html">StunAtrUnknown</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>atr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00501">501</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00544">stunEncodeMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, <a class="code" href="stun_8h.html#ac5d0f4ecd6bc741747a3ff79b6e5a96c">UnknownAttribute</a>);
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, 2+2*atr.<a class="code" href="structStunAtrUnknown.html#a39f2cca60b76d9476cd2a61a349e72d6">numAttributes</a>);
   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;atr.<a class="code" href="structStunAtrUnknown.html#a39f2cca60b76d9476cd2a61a349e72d6">numAttributes</a>; i++)
   {
      ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, atr.<a class="code" href="structStunAtrUnknown.html#a2a9ac6afb38e1f951bc7cb8ec0b2a888">attrType</a>[i]);
   }
   <span class="keywordflow">return</span> ptr;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3d149acb0bcd480596ea26b73b47d05f"></a><!-- doxytag: member="stun.cc::encodeXorOnly" ref="a3d149acb0bcd480596ea26b73b47d05f" args="(char *ptr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* encodeXorOnly </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>ptr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00514">514</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00544">stunEncodeMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, <a class="code" href="stun_8h.html#a615f23f67cf9c716c91fa445e272da3c">XorOnly</a> );
   <span class="keywordflow">return</span> ptr;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8cca5b933ad45c62c8d5e4c82dfb19cc"></a><!-- doxytag: member="stun.cc::operator&lt;&lt;" ref="a8cca5b933ad45c62c8d5e4c82dfb19cc" args="(ostream &amp;strm, const UInt128 &amp;r)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ostream&amp; operator&lt;&lt; </td>
          <td>(</td>
          <td class="paramtype">ostream &amp;&nbsp;</td>
          <td class="paramname"> <em>strm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structUInt128.html">UInt128</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>r</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00835">835</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   strm &lt;&lt; int(r.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[0]);
   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=1; i&lt;16; i++ )
   {
      strm &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; int(r.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[i]);
   }

   <span class="keywordflow">return</span> strm;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a34a70949080bffbb59fb937092c26802"></a><!-- doxytag: member="stun.cc::operator&lt;&lt;" ref="a34a70949080bffbb59fb937092c26802" args="(ostream &amp;strm, const StunAddress4 &amp;addr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ostream&amp; operator&lt;&lt; </td>
          <td>(</td>
          <td class="paramtype">ostream &amp;&nbsp;</td>
          <td class="paramname"> <em>strm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>addr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00847">847</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> ip = addr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
   strm &lt;&lt; ((int)(ip&gt;&gt;24)&amp;0xFF) &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>;
   strm &lt;&lt; ((int)(ip&gt;&gt;16)&amp;0xFF) &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>;
   strm &lt;&lt; ((int)(ip&gt;&gt; 8)&amp;0xFF) &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>;
   strm &lt;&lt; ((int)(ip&gt;&gt; 0)&amp;0xFF) ;

   strm &lt;&lt; <span class="stringliteral">&quot;:&quot;</span> &lt;&lt; addr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;

   <span class="keywordflow">return</span> strm;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a07bb6d28e9a67cc882184b04c227e82b"></a><!-- doxytag: member="stun.cc::stunBuildReqSimple" ref="a07bb6d28e9a67cc882184b04c227e82b" args="(StunMessage *msg, const StunAtrString &amp;username, bool changePort, bool changeIp, unsigned int id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void stunBuildReqSimple </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structStunMessage.html">StunMessage</a> *&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>username</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>changePort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>changeIp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>id</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01697">1697</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01734">stunSendTest()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert( msg );
   memset( msg , 0 , <span class="keyword">sizeof</span>(*msg) );

   msg-&gt;<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a7cc96e6cbb87582e56f298eb891c43e2">msgType</a> = <a class="code" href="stun_8h.html#a4dfa49ebae731be7b582f0fc7b57d429">BindRequestMsg</a>;

   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;16; i=i+4 )
   {
      assert(i+3&lt;16);
      <span class="keywordtype">int</span> r = <a class="code" href="stun_8cc.html#a67e399c9420f09178de194bee0bde87a">stunRand</a>();
      msg-&gt;<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[i+0]= r&gt;&gt;0;
      msg-&gt;<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[i+1]= r&gt;&gt;8;
      msg-&gt;<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[i+2]= r&gt;&gt;16;
      msg-&gt;<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[i+3]= r&gt;&gt;24;
   }

   <span class="keywordflow">if</span> ( <span class="keywordtype">id</span> != 0 )
   {
      msg-&gt;<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[0] = id;
   }

   msg-&gt;<a class="code" href="structStunMessage.html#a0fe2488f060fe65507c9a58bbb66899f">hasChangeRequest</a> = <span class="keyword">true</span>;
   msg-&gt;<a class="code" href="structStunMessage.html#a65e5de40376764ea12d96f5b5ebe2c29">changeRequest</a>.<a class="code" href="structStunAtrChangeRequest.html#adbb006a8e7cc0637d01959c8ba985c0c">value</a> =(changeIp?<a class="code" href="stun_8h.html#ad0235d173b2af6e92be9843aaa585eef">ChangeIpFlag</a>:0) |
      (changePort?<a class="code" href="stun_8h.html#a2f247c137dd06ef8971319b9a6078ef4">ChangePortFlag</a>:0);

   <span class="keywordflow">if</span> ( username.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> &gt; 0 )
   {
      msg-&gt;<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a> = <span class="keyword">true</span>;
      msg-&gt;<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a> = username;
   }
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a965ceef7c244ec6895b9670acdf57930"></a><!-- doxytag: member="stun.cc::stunCreateErrorResponse" ref="a965ceef7c244ec6895b9670acdf57930" args="(StunMessage &amp;response, int cl, int number, const char *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void stunCreateErrorResponse </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structStunMessage.html">StunMessage</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>response</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>number</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>msg</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00980">980</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01019">stunServerProcessMsg()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   response.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a7cc96e6cbb87582e56f298eb891c43e2">msgType</a> = <a class="code" href="stun_8h.html#ae440f0f666689240a0aa0f450d1783ab">BindErrorResponseMsg</a>;
   response.<a class="code" href="structStunMessage.html#afe66349979726d392fa4f0c9c84ebedf">hasErrorCode</a> = <span class="keyword">true</span>;
   response.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>.<a class="code" href="structStunAtrError.html#aef65890aa74d342d326ea74000064be5">errorClass</a> = cl;
   response.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>.<a class="code" href="structStunAtrError.html#abdee224c138f23ad06aeb97ed9d6e0fe">number</a> = number;
   strcpy(response.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>.<a class="code" href="structStunAtrError.html#a3bb11d3802d0bfe65a153d8a6bccd472">reason</a>, msg);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa8926aedab40d08f5cff31d759415962"></a><!-- doxytag: member="stun.cc::stunCreatePassword" ref="aa8926aedab40d08f5cff31d759415962" args="(const StunAtrString &amp;username, StunAtrString *password)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void stunCreatePassword </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>username</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrString.html">StunAtrString</a> *&nbsp;</td>
          <td class="paramname"> <em>password</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00802">802</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01002">stunCreateSharedSecretResponse()</a>, <a class="el" href="stun_8cc_source.html#l01801">stunGetUserNameAndPassword()</a>, and <a class="el" href="stun_8cc_source.html#l01019">stunServerProcessMsg()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordtype">char</span> hmac[20];
   <span class="keywordtype">char</span> key[] = <span class="stringliteral">&quot;Fluffy&quot;</span>;
   <span class="comment">//char buffer[STUN_MAX_STRING];</span>
   <a class="code" href="stun_8cc.html#afdae90956a999518a90595e783525734">computeHmac</a>(hmac, username.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>, strlen(username.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>), key, strlen(key));
   <a class="code" href="stun_8cc.html#a2c6016ed098c5abccd8fd044c02fb6dc">toHex</a>(hmac, 20, password-&gt;<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>);
   password-&gt;<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = 40;
   password-&gt;<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>[40]=0;

   <span class="comment">//clog &lt;&lt; &quot;password=&quot; &lt;&lt; password-&gt;value &lt;&lt; endl;</span>
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1382231021dcb9f568718d9a75087f48"></a><!-- doxytag: member="stun.cc::stunCreateSharedSecretResponse" ref="a1382231021dcb9f568718d9a75087f48" args="(const StunMessage &amp;request, const StunAddress4 &amp;source, StunMessage &amp;response)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void stunCreateSharedSecretResponse </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structStunMessage.html">StunMessage</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>request</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>source</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunMessage.html">StunMessage</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>response</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01002">1002</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01019">stunServerProcessMsg()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   response.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a7cc96e6cbb87582e56f298eb891c43e2">msgType</a> = <a class="code" href="stun_8h.html#af179b3b160dd9d71db8bcff29500504c">SharedSecretResponseMsg</a>;
   response.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a> = request.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>;

   response.<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a> = <span class="keyword">true</span>;
   <a class="code" href="stun_8cc.html#a5f442520a968eaa3f90caa8dcd40bd33">stunCreateUserName</a>( source, &amp;response.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>);

   response.<a class="code" href="structStunMessage.html#ac09b6e5f081db9f5ec2c1a4532676366">hasPassword</a> = <span class="keyword">true</span>;
   <a class="code" href="stun_8cc.html#aa8926aedab40d08f5cff31d759415962">stunCreatePassword</a>( response.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>, &amp;response.<a class="code" href="structStunMessage.html#aa15cab0d5b2a9a044895e81d527c1b68">password</a>);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5f442520a968eaa3f90caa8dcd40bd33"></a><!-- doxytag: member="stun.cc::stunCreateUserName" ref="a5f442520a968eaa3f90caa8dcd40bd33" args="(const StunAddress4 &amp;source, StunAtrString *username)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void stunCreateUserName </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>source</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrString.html">StunAtrString</a> *&nbsp;</td>
          <td class="paramname"> <em>username</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00764">764</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01002">stunCreateSharedSecretResponse()</a>, and <a class="el" href="stun_8cc_source.html#l01801">stunGetUserNameAndPassword()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <a class="code" href="stun_8h.html#aa1d7d331b6d522d6d9840fece27108d8">UInt64</a> time = <a class="code" href="stun_8cc.html#a43c07bd7f476e16ea3e48a1033e90ba0">stunGetSystemTimeSecs</a>();
   time -= (time % 20*60);
   <span class="comment">//UInt64 hitime = time &gt;&gt; 32;</span>
   <a class="code" href="stun_8h.html#aa1d7d331b6d522d6d9840fece27108d8">UInt64</a> lotime = time &amp; 0xFFFFFFFF;

   <span class="keywordtype">char</span> buffer[1024];
   sprintf(buffer,
           <span class="stringliteral">&quot;%08x:%08x:%08x:&quot;</span>,
           <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a>(source.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>),
           <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a>(<a class="code" href="stun_8cc.html#a67e399c9420f09178de194bee0bde87a">stunRand</a>()),
           <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a>(lotime));
   assert( strlen(buffer) &lt; 1024 );

   assert(strlen(buffer) + 41 &lt; <a class="code" href="stun_8h.html#ac4d86797b42c1696b7acbd715481c0b1">STUN_MAX_STRING</a>);

   <span class="keywordtype">char</span> hmac[20];
   <span class="keywordtype">char</span> key[] = <span class="stringliteral">&quot;Jason&quot;</span>;
   <a class="code" href="stun_8cc.html#afdae90956a999518a90595e783525734">computeHmac</a>(hmac, buffer, strlen(buffer), key, strlen(key) );
   <span class="keywordtype">char</span> hmacHex[41];
   <a class="code" href="stun_8cc.html#a2c6016ed098c5abccd8fd044c02fb6dc">toHex</a>(hmac, 20, hmacHex );
   hmacHex[40] =0;

   strcat(buffer,hmacHex);

   <span class="keywordtype">int</span> l = strlen(buffer);
   assert( l+1 &lt; <a class="code" href="stun_8h.html#ac4d86797b42c1696b7acbd715481c0b1">STUN_MAX_STRING</a> );
   assert( l%4 == 0 );

   username-&gt;<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = l;
   memcpy(username-&gt;<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>,buffer,l);
   username-&gt;<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>[l]=0;

   <span class="comment">//if (verbose) clog &lt;&lt; &quot;computed username=&quot; &lt;&lt; username.value &lt;&lt; endl;</span>
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a4f9e869279d41bbf1785d321b4360f61"></a><!-- doxytag: member="stun.cc::stunEncodeMessage" ref="a4f9e869279d41bbf1785d321b4360f61" args="(const StunMessage &amp;msg, char *buf, unsigned int bufLen, const StunAtrString &amp;password, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned int stunEncodeMessage </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structStunMessage.html">StunMessage</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>bufLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>password</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00544">544</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01734">stunSendTest()</a>, and <a class="el" href="stun_8cc_source.html#l01351">stunServerProcess()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert(bufLen &gt;= <span class="keyword">sizeof</span>(<a class="code" href="structStunMsgHdr.html">StunMsgHdr</a>));
   <span class="keywordtype">char</span>* ptr = buf;

   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a7cc96e6cbb87582e56f298eb891c43e2">msgType</a>);
   <span class="keywordtype">char</span>* lengthp = ptr;
   ptr = <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(ptr, 0);
   ptr = <a class="code" href="stun_8cc.html#a32bf1e0d5e4833c497c540b4681dd808">encode</a>(ptr, reinterpret_cast&lt;const char*&gt;(msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>), <span class="keyword">sizeof</span>(msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>));

   <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding stun message: &quot;</span> &lt;&lt; endl;
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#a605889708c9696c60f1284b3c486ca18">hasMappedAddress</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding MappedAddress: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a85ef119873a4b4a76012d89f1d6c23fb">encodeAtrAddress4</a> (ptr, <a class="code" href="stun_8h.html#a2479ede510923cc5e8a0c2da5558acc3">MappedAddress</a>, msg.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#ab7926e7d5ceb2d9c3337439ec89ec87d">hasResponseAddress</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding ResponseAddress: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#adb06537683f153438687995e8d1783c6">responseAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a85ef119873a4b4a76012d89f1d6c23fb">encodeAtrAddress4</a>(ptr, <a class="code" href="stun_8h.html#a91ab7c5c3d71a86a77679d0d2786fae8">ResponseAddress</a>, msg.<a class="code" href="structStunMessage.html#adb06537683f153438687995e8d1783c6">responseAddress</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#a0fe2488f060fe65507c9a58bbb66899f">hasChangeRequest</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding ChangeRequest: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a65e5de40376764ea12d96f5b5ebe2c29">changeRequest</a>.<a class="code" href="structStunAtrChangeRequest.html#adbb006a8e7cc0637d01959c8ba985c0c">value</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a076612a210669e11d7c284f08b3a34b2">encodeAtrChangeRequest</a>(ptr, msg.<a class="code" href="structStunMessage.html#a65e5de40376764ea12d96f5b5ebe2c29">changeRequest</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#a5feb7431931118218d78642c4a7c83db">hasSourceAddress</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding SourceAddress: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#ab7203fc2e5a8b1248c9e14ce6e6ec313">sourceAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a85ef119873a4b4a76012d89f1d6c23fb">encodeAtrAddress4</a>(ptr, <a class="code" href="stun_8h.html#ab2b81c4c09625b39c5a1d57ee2b460a4">SourceAddress</a>, msg.<a class="code" href="structStunMessage.html#ab7203fc2e5a8b1248c9e14ce6e6ec313">sourceAddress</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#a4d3036e012cce04e6be670898f4e24eb">hasChangedAddress</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding ChangedAddress: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a85ef119873a4b4a76012d89f1d6c23fb">encodeAtrAddress4</a>(ptr, <a class="code" href="stun_8h.html#a930a1eeda1f0620132bfdea315e711f7">ChangedAddress</a>, msg.<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding Username: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a765920e3cdcc343b0ed69a8fab4a1736">encodeAtrString</a>(ptr, <a class="code" href="stun_8h.html#a0845232ed07b469d1262348e1618b962">Username</a>, msg.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#ac09b6e5f081db9f5ec2c1a4532676366">hasPassword</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding Password: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#aa15cab0d5b2a9a044895e81d527c1b68">password</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a765920e3cdcc343b0ed69a8fab4a1736">encodeAtrString</a>(ptr, <a class="code" href="stun_8h.html#a1741d36983135a1f2eefa1b1473956a2">Password</a>, msg.<a class="code" href="structStunMessage.html#aa15cab0d5b2a9a044895e81d527c1b68">password</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#afe66349979726d392fa4f0c9c84ebedf">hasErrorCode</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding ErrorCode: class=&quot;</span>
                        &lt;&lt; int(msg.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>.<a class="code" href="structStunAtrError.html#aef65890aa74d342d326ea74000064be5">errorClass</a>)
                        &lt;&lt; <span class="stringliteral">&quot; number=&quot;</span> &lt;&lt; int(msg.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>.<a class="code" href="structStunAtrError.html#abdee224c138f23ad06aeb97ed9d6e0fe">number</a>)
                        &lt;&lt; <span class="stringliteral">&quot; reason=&quot;</span>
                        &lt;&lt; msg.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>.<a class="code" href="structStunAtrError.html#a3bb11d3802d0bfe65a153d8a6bccd472">reason</a>
                        &lt;&lt; endl;

      ptr = <a class="code" href="stun_8cc.html#a61a6cc411fa597374048437e28ddffdf">encodeAtrError</a>(ptr, msg.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#a29507d464e9900ced2ce92c75bb158a4">hasUnknownAttributes</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding UnknownAttribute: ???&quot;</span> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a09523c814cf26f59012e800713447143">encodeAtrUnknown</a>(ptr, msg.<a class="code" href="structStunMessage.html#a40311e31449afb24c3e40db8c8fc6911">unknownAttributes</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#ab88124a21ca8562a44a696ed4b39fa4f">hasReflectedFrom</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding ReflectedFrom: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#ab80a59189b1b938698339f788417f32b">reflectedFrom</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a85ef119873a4b4a76012d89f1d6c23fb">encodeAtrAddress4</a>(ptr, <a class="code" href="stun_8h.html#a11d1c4b717d340b20582ac7dead1cd49">ReflectedFrom</a>, msg.<a class="code" href="structStunMessage.html#ab80a59189b1b938698339f788417f32b">reflectedFrom</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#a8e149870681eebee0a55b0f630c89471">hasXorMappedAddress</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding XorMappedAddress: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a2ef5db0ff5bd395800262b8b9d49b6bb">xorMappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a85ef119873a4b4a76012d89f1d6c23fb">encodeAtrAddress4</a> (ptr, <a class="code" href="stun_8h.html#afd742381f8d8131e21dac399b8a26c3a">XorMappedAddress</a>, msg.<a class="code" href="structStunMessage.html#a2ef5db0ff5bd395800262b8b9d49b6bb">xorMappedAddress</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#ad2d3b64955956272841f656fe354aa18">xorOnly</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding xorOnly: &quot;</span> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a3d149acb0bcd480596ea26b73b47d05f">encodeXorOnly</a>( ptr );
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#afcf544b5b0663edad215525b8bcd67df">hasServerName</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding ServerName: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a1998c160a79020e146957c14ae1add11">serverName</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a765920e3cdcc343b0ed69a8fab4a1736">encodeAtrString</a>(ptr, <a class="code" href="stun_8h.html#a53f47b517798fa3e1b64313d04168ea2">ServerName</a>, msg.<a class="code" href="structStunMessage.html#a1998c160a79020e146957c14ae1add11">serverName</a>);
   }
   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#ace894f36510487ec8151609513974eba">hasSecondaryAddress</a>)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Encoding SecondaryAddress: &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a8fc16bd394228aa6fa6e1f5f98c356c1">secondaryAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
      ptr = <a class="code" href="stun_8cc.html#a85ef119873a4b4a76012d89f1d6c23fb">encodeAtrAddress4</a> (ptr, <a class="code" href="stun_8h.html#a4d77a59e0dc2c3c06deb3730baa78f80">SecondaryAddress</a>, msg.<a class="code" href="structStunMessage.html#a8fc16bd394228aa6fa6e1f5f98c356c1">secondaryAddress</a>);
   }

   <span class="keywordflow">if</span> (password.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> &gt; 0)
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;HMAC with password: &quot;</span> &lt;&lt; password.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a> &lt;&lt; endl;

      <a class="code" href="structStunAtrIntegrity.html">StunAtrIntegrity</a> integrity;
      <a class="code" href="stun_8cc.html#afdae90956a999518a90595e783525734">computeHmac</a>(integrity.<a class="code" href="structStunAtrIntegrity.html#a584fa6b758583be87dfad5c10da9fd44">hash</a>, buf, <span class="keywordtype">int</span>(ptr-buf) , password.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>, password.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a>);
      ptr = <a class="code" href="stun_8cc.html#ad58a0afd3626cc03abb1d92edbf6c4d3">encodeAtrIntegrity</a>(ptr, integrity);
   }
   <span class="keywordflow">if</span> (verbose) clog &lt;&lt; endl;

   <a class="code" href="stun_8cc.html#a495405bc65a0788775febd87866ece36">encode16</a>(lengthp, <a class="code" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a>(ptr - buf - <span class="keyword">sizeof</span>(<a class="code" href="structStunMsgHdr.html">StunMsgHdr</a>)));
   <span class="keywordflow">return</span> int(ptr - buf);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7c8890aa737ed2b41734471121af77a2"></a><!-- doxytag: member="stun.cc::stunFindLocalInterfaces" ref="a7c8890aa737ed2b41734471121af77a2" args="(UInt32 *addresses, int maxRet)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int stunFindLocalInterfaces </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> *&nbsp;</td>
          <td class="paramname"> <em>addresses</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>maxRet</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>returns number of address found - take array or addres </p>

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01630">1630</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
<span class="preprocessor">#if defined(WIN32) || defined(__sparc__)</span>
<span class="preprocessor"></span>   <span class="keywordflow">return</span> 0;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>   <span class="keyword">struct </span>ifconf ifc;

   <span class="keywordtype">int</span> s = socket( AF_INET, SOCK_DGRAM, 0 );
   <span class="keywordtype">int</span> len = 100 * <span class="keyword">sizeof</span>(<span class="keyword">struct </span>ifreq);

   <span class="keywordtype">char</span> buf[ len ];

   ifc.ifc_len = len;
   ifc.ifc_buf = buf;

   <span class="keywordtype">int</span> e = ioctl(s,SIOCGIFCONF,&amp;ifc);
   <span class="keywordtype">char</span> *ptr = buf;
   <span class="keywordtype">int</span> tl = ifc.ifc_len;
   <span class="keywordtype">int</span> count=0;

   <span class="keywordflow">while</span> ( (tl &gt; 0) &amp;&amp; ( count &lt; maxRet) )
   {
      <span class="keyword">struct </span>ifreq* ifr = (<span class="keyword">struct </span>ifreq *)ptr;

      <span class="keywordtype">int</span> si = <span class="keyword">sizeof</span>(ifr-&gt;ifr_name) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr);
      tl -= si;
      ptr += si;
      <span class="comment">//char* name = ifr-&gt;ifr_ifrn.ifrn_name;</span>
      <span class="comment">//cerr &lt;&lt; &quot;name = &quot; &lt;&lt; name &lt;&lt; endl;</span>

      <span class="keyword">struct </span>ifreq ifr2;
      ifr2 = *ifr;

      e = ioctl(s,SIOCGIFADDR,&amp;ifr2);
      <span class="keywordflow">if</span> ( e == -1 )
      {
         <span class="keywordflow">break</span>;
      }

      <span class="comment">//cerr &lt;&lt; &quot;ioctl addr e = &quot; &lt;&lt; e &lt;&lt; endl;</span>

      <span class="keyword">struct </span>sockaddr a = ifr2.ifr_addr;
      <span class="keyword">struct </span>sockaddr_in* addr = (<span class="keyword">struct </span>sockaddr_in*) &amp;a;

      <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> ai = ntohl( addr-&gt;sin_addr.s_addr );
      <span class="keywordflow">if</span> (<span class="keywordtype">int</span>((ai&gt;&gt;24)&amp;0xFF) != 127)
      {
         addresses[count++] = ai;
      }

<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span>      cerr &lt;&lt; <span class="stringliteral">&quot;Detected interface &quot;</span>
           &lt;&lt; int((ai&gt;&gt;24)&amp;0xFF) &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>
           &lt;&lt; int((ai&gt;&gt;16)&amp;0xFF) &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>
           &lt;&lt; int((ai&gt;&gt; 8)&amp;0xFF) &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>
           &lt;&lt; int((ai    )&amp;0xFF) &lt;&lt; endl;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>   }

   <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>(s);

   <span class="keywordflow">return</span> count;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a43c07bd7f476e16ea3e48a1033e90ba0"></a><!-- doxytag: member="stun.cc::stunGetSystemTimeSecs" ref="a43c07bd7f476e16ea3e48a1033e90ba0" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stun_8h.html#aa1d7d331b6d522d6d9840fece27108d8">UInt64</a> stunGetSystemTimeSecs </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00817">817</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00764">stunCreateUserName()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <a class="code" href="stun_8h.html#aa1d7d331b6d522d6d9840fece27108d8">UInt64</a> time=0;
<span class="preprocessor">#if defined(WIN32)</span>
<span class="preprocessor"></span>   SYSTEMTIME t;
   <span class="comment">// CJ TODO - this probably has bug on wrap around every 24 hours</span>
   GetSystemTime( &amp;t );
   time = (t.wHour*60+t.wMinute)*60+t.wSecond;
#<span class="keywordflow">else</span>
   <span class="keyword">struct</span> timeval now;
   gettimeofday( &amp;now , NULL );
   <span class="comment">//assert( now );</span>
   time = now.tv_sec;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>   <span class="keywordflow">return</span> time;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae9317a5a127d1281953d961bcfbd2496"></a><!-- doxytag: member="stun.cc::stunGetUserNameAndPassword" ref="ae9317a5a127d1281953d961bcfbd2496" args="(const StunAddress4 &amp;dest, StunAtrString *username, StunAtrString *password)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void stunGetUserNameAndPassword </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>dest</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrString.html">StunAtrString</a> *&nbsp;</td>
          <td class="paramname"> <em>username</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrString.html">StunAtrString</a> *&nbsp;</td>
          <td class="paramname"> <em>password</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01801">1801</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01876">stunNatType()</a>, <a class="el" href="stun_8cc_source.html#l02247">stunOpenSocket()</a>, <a class="el" href="stun_8cc_source.html#l02314">stunOpenSocketPair()</a>, and <a class="el" href="stun_8cc_source.html#l01813">stunTest()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="comment">// !cj! This is totally bogus - need to make TLS connection to dest and get a</span>
   <span class="comment">// username and password to use</span>
   <a class="code" href="stun_8cc.html#a5f442520a968eaa3f90caa8dcd40bd33">stunCreateUserName</a>(dest, username);
   <a class="code" href="stun_8cc.html#aa8926aedab40d08f5cff31d759415962">stunCreatePassword</a>(*username, password);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a99639b68ee528c79e96973a2642184a4"></a><!-- doxytag: member="stun.cc::stunInitServer" ref="a99639b68ee528c79e96973a2642184a4" args="(StunServerInfo &amp;info, const StunAddress4 &amp;myAddr, const StunAddress4 &amp;altAddr, int startMediaPort, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool stunInitServer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structStunServerInfo.html">StunServerInfo</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>info</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>myAddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>altAddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>startMediaPort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>return true if all is OK Create a media relay and do the STERN thing if startMediaPort is non-zero </p>

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01249">1249</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert( myAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 );
   assert( altAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>!= 0 );
   assert( myAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>  != 0 );
   <span class="comment">//assert( altAddr.addr != 0 );</span>

   info.<a class="code" href="structStunServerInfo.html#a9abf6e6b89123dd6d7a71bba5a0b77d6">myAddr</a> = myAddr;
   info.<a class="code" href="structStunServerInfo.html#ac6295f141e0926994747bbc198a19d55">altAddr</a> = altAddr;

   info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a> = <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;
   info.<a class="code" href="structStunServerInfo.html#a2da8a94e9a9867e7c5d3b3e3c317120c">altPortFd</a> = <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;
   info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a> = <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;
   info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a> = <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;

   memset(info.<a class="code" href="structStunServerInfo.html#aed8568086c549986f985f02a691da173">relays</a>, 0, <span class="keyword">sizeof</span>(info.<a class="code" href="structStunServerInfo.html#aed8568086c549986f985f02a691da173">relays</a>));
   <span class="keywordflow">if</span> (startMediaPort &gt; 0)
   {
      info.<a class="code" href="structStunServerInfo.html#a5dcc784d754928455caab60d6a34f73e">relay</a> = <span class="keyword">true</span>;

      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;MAX_MEDIA_RELAYS; ++i)
      {
         <a class="code" href="structStunMediaRelay.html">StunMediaRelay</a>* relay = &amp;info.<a class="code" href="structStunServerInfo.html#aed8568086c549986f985f02a691da173">relays</a>[i];
         relay-&gt;<a class="code" href="structStunMediaRelay.html#a18c86cb9d0058de5ab6b5adf449a275b">relayPort</a> = startMediaPort+i;
         relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a> = 0;
         relay-&gt;<a class="code" href="structStunMediaRelay.html#a16873193e181c40809e3f3f91bfb78ff">expireTime</a> = 0;
      }
   }
   <span class="keywordflow">else</span>
   {
      info.<a class="code" href="structStunServerInfo.html#a5dcc784d754928455caab60d6a34f73e">relay</a> = <span class="keyword">false</span>;
   }

   <span class="keywordflow">if</span> ((info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a> = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>(myAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>, myAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>,verbose)) == <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>)
   {
      clog &lt;&lt; <span class="stringliteral">&quot;Can&#39;t open &quot;</span> &lt;&lt; myAddr &lt;&lt; endl;
      <a class="code" href="stun_8cc.html#a9ed82a9b4b17f3f4d9bf1fd4d5b8bfd2">stunStopServer</a>(info);

      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   <span class="comment">//if (verbose) clog &lt;&lt; &quot;Opened &quot; &lt;&lt; myAddr.addr &lt;&lt; &quot;:&quot; &lt;&lt; myAddr.port &lt;&lt; &quot; --&gt; &quot; &lt;&lt; info.myFd &lt;&lt; endl;</span>

   <span class="keywordflow">if</span> ((info.<a class="code" href="structStunServerInfo.html#a2da8a94e9a9867e7c5d3b3e3c317120c">altPortFd</a> = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>(altAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>,myAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>,verbose)) == <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>)
   {
      clog &lt;&lt; <span class="stringliteral">&quot;Can&#39;t open &quot;</span> &lt;&lt; myAddr &lt;&lt; endl;
      <a class="code" href="stun_8cc.html#a9ed82a9b4b17f3f4d9bf1fd4d5b8bfd2">stunStopServer</a>(info);
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   <span class="comment">//if (verbose) clog &lt;&lt; &quot;Opened &quot; &lt;&lt; myAddr.addr &lt;&lt; &quot;:&quot; &lt;&lt; altAddr.port &lt;&lt; &quot; --&gt; &quot; &lt;&lt; info.altPortFd &lt;&lt; endl;</span>


   info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a> = <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;
   <span class="keywordflow">if</span> (  altAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> != 0 )
   {
      <span class="keywordflow">if</span> ((info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a> = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>( myAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>, altAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>,verbose)) == <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>)
      {
         clog &lt;&lt; <span class="stringliteral">&quot;Can&#39;t open &quot;</span> &lt;&lt; altAddr &lt;&lt; endl;
         <a class="code" href="stun_8cc.html#a9ed82a9b4b17f3f4d9bf1fd4d5b8bfd2">stunStopServer</a>(info);
         <span class="keywordflow">return</span> <span class="keyword">false</span>;
      }
      <span class="comment">//if (verbose) clog &lt;&lt; &quot;Opened &quot; &lt;&lt; altAddr.addr &lt;&lt; &quot;:&quot; &lt;&lt; myAddr.port &lt;&lt; &quot; --&gt; &quot; &lt;&lt; info.altIpFd &lt;&lt; endl;;</span>
   }

   info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a> = <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>;
   <span class="keywordflow">if</span> (  altAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> != 0 )
   {  <span class="keywordflow">if</span> ((info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a> = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>(altAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>, altAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>,verbose)) == <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>)
      {
         clog &lt;&lt; <span class="stringliteral">&quot;Can&#39;t open &quot;</span> &lt;&lt; altAddr &lt;&lt; endl;
         <a class="code" href="stun_8cc.html#a9ed82a9b4b17f3f4d9bf1fd4d5b8bfd2">stunStopServer</a>(info);
         <span class="keywordflow">return</span> <span class="keyword">false</span>;
      }
      <span class="comment">//if (verbose) clog &lt;&lt; &quot;Opened &quot; &lt;&lt; altAddr.addr &lt;&lt; &quot;:&quot; &lt;&lt; altAddr.port &lt;&lt; &quot; --&gt; &quot; &lt;&lt; info.altIpPortFd &lt;&lt; endl;;</span>
   }

   <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1bcb91a498bf5e73ba5b150c5a698c7d"></a><!-- doxytag: member="stun.cc::stunNatType" ref="a1bcb91a498bf5e73ba5b150c5a698c7d" args="(StunAddress4 &amp;dest, bool verbose, bool *preservePort, bool *hairpin, int port, StunAddress4 *sAddr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stun_8h.html#a73736c0f7526e31ef6a35dcc0ebd34ce">NatType</a> stunNatType </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>dest</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool *&nbsp;</td>
          <td class="paramname"> <em>preservePort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool *&nbsp;</td>
          <td class="paramname"> <em>hairpin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>port</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> *&nbsp;</td>
          <td class="paramname"> <em>sAddr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01876">1876</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="SingleHostUnderlayConfigurator_8cc_source.html#l00057">SingleHostUnderlayConfigurator::initializeUnderlay()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert( dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> != 0 );
   assert( dest.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 );

   <span class="keywordflow">if</span> ( hairpin )
   {
      *hairpin = <span class="keyword">false</span>;
   }

   <span class="keywordflow">if</span> ( port == 0 )
   {
      port = <a class="code" href="stun_8cc.html#ad4a19c401bea76c471959a32a19b777e" title="return a random number to use as a port">stunRandomPort</a>();
   }
   <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> interfaceIp=0;
   <span class="keywordflow">if</span> (sAddr)
   {
      interfaceIp = sAddr-&gt;<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
   }
   <a class="code" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> myFd1 = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>(port,interfaceIp,verbose);
   <a class="code" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> myFd2 = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>(port+1,interfaceIp,verbose);

   <span class="keywordflow">if</span> ( ( myFd1 == <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>) || ( myFd2 == <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>) )
   {
        cerr &lt;&lt; <span class="stringliteral">&quot;Some problem opening port/interface to send on&quot;</span> &lt;&lt; endl;
       <span class="keywordflow">return</span> StunTypeFailure;
   }

   assert( myFd1 != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> );
   assert( myFd2 != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> );

   <span class="keywordtype">bool</span> respTestI=<span class="keyword">false</span>;
   <span class="keywordtype">bool</span> isNat=<span class="keyword">true</span>;
   <a class="code" href="structStunAddress4.html">StunAddress4</a> testIchangedAddr;
   <a class="code" href="structStunAddress4.html">StunAddress4</a> testImappedAddr;
   <span class="keywordtype">bool</span> respTestI2=<span class="keyword">false</span>;
   <span class="keywordtype">bool</span> mappedIpSame = <span class="keyword">true</span>;
   <a class="code" href="structStunAddress4.html">StunAddress4</a> testI2mappedAddr;
   <a class="code" href="structStunAddress4.html">StunAddress4</a> testI2dest=dest;
   <span class="keywordtype">bool</span> respTestII=<span class="keyword">false</span>;
   <span class="keywordtype">bool</span> respTestIII=<span class="keyword">false</span>;

   <span class="keywordtype">bool</span> respTestHairpin=<span class="keyword">false</span>;
   <span class="keywordtype">bool</span> respTestPreservePort=<span class="keyword">false</span>;

   memset(&amp;testImappedAddr,0,<span class="keyword">sizeof</span>(testImappedAddr));

   <a class="code" href="structStunAtrString.html">StunAtrString</a> username;
   <a class="code" href="structStunAtrString.html">StunAtrString</a> password;

   username.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = 0;
   password.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = 0;

<span class="preprocessor">#ifdef USE_TLS</span>
<span class="preprocessor"></span>   <a class="code" href="stun_8cc.html#ae9317a5a127d1281953d961bcfbd2496">stunGetUserNameAndPassword</a>( dest, username, password );
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
   <span class="keywordtype">int</span> count=0;
   <span class="keywordflow">while</span> ( count &lt; 7 )
   {
      <span class="keyword">struct </span>timeval tv;
      fd_set fdSet;
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fdSetSize;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      <span class="keywordtype">int</span> fdSetSize;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      FD_ZERO(&amp;fdSet); fdSetSize=0;
      FD_SET(myFd1,&amp;fdSet); fdSetSize = (myFd1+1&gt;fdSetSize) ? myFd1+1 : fdSetSize;
      FD_SET(myFd2,&amp;fdSet); fdSetSize = (myFd2+1&gt;fdSetSize) ? myFd2+1 : fdSetSize;
      tv.tv_sec=0;
      tv.tv_usec=150*1000; <span class="comment">// 150 ms</span>
      <span class="keywordflow">if</span> ( count == 0 ) tv.tv_usec=0;

      <span class="keywordtype">int</span>  err = select(fdSetSize, &amp;fdSet, NULL, NULL, &amp;tv);
      <span class="keywordtype">int</span> e = <a class="code" href="stun__udp_8h.html#a604d53fe9d66ce3a47ab2354b20f8e62">getErrno</a>();
      <span class="keywordflow">if</span> ( err == <a class="code" href="stun__udp_8h.html#a5196d10051a93efa5a7e25054b48c236">STUN_SOCKET_ERROR</a> )
      {
         <span class="comment">// error occured</span>
         cerr &lt;&lt; <span class="stringliteral">&quot;Error &quot;</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; strerror(e) &lt;&lt; <span class="stringliteral">&quot; in select&quot;</span> &lt;&lt; endl;
        <span class="keywordflow">return</span> StunTypeFailure;
     }
      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( err == 0 )
      {
         <span class="comment">// timeout occured</span>
         count++;

         <span class="keywordflow">if</span> ( !respTestI )
         {
            <a class="code" href="stun_8cc.html#ab17bbe96f9bef6d767fbee081ca123d7">stunSendTest</a>( myFd1, dest, username, password, 1 ,verbose );
         }

         <span class="keywordflow">if</span> ( (!respTestI2) &amp;&amp; respTestI )
         {
            <span class="comment">// check the address to send to if valid</span>
            <span class="keywordflow">if</span> (  ( testI2dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> != 0 ) &amp;&amp;
                  ( testI2dest.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 ) )
            {
               <a class="code" href="stun_8cc.html#ab17bbe96f9bef6d767fbee081ca123d7">stunSendTest</a>( myFd1, testI2dest, username, password, 10  ,verbose);
            }
         }

         <span class="keywordflow">if</span> ( !respTestII )
         {
            <a class="code" href="stun_8cc.html#ab17bbe96f9bef6d767fbee081ca123d7">stunSendTest</a>( myFd2, dest, username, password, 2 ,verbose );
         }

         <span class="keywordflow">if</span> ( !respTestIII )
         {
            <a class="code" href="stun_8cc.html#ab17bbe96f9bef6d767fbee081ca123d7">stunSendTest</a>( myFd2, dest, username, password, 3 ,verbose );
         }

         <span class="keywordflow">if</span> ( respTestI &amp;&amp; (!respTestHairpin) )
         {
            <span class="keywordflow">if</span> (  ( testImappedAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> != 0 ) &amp;&amp;
                  ( testImappedAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 ) )
            {
               <a class="code" href="stun_8cc.html#ab17bbe96f9bef6d767fbee081ca123d7">stunSendTest</a>( myFd1, testImappedAddr, username, password, 11 ,verbose );
            }
         }
      }
      <span class="keywordflow">else</span>
      {
         <span class="comment">//if (verbose) clog &lt;&lt; &quot;-----------------------------------------&quot; &lt;&lt; endl;</span>
         assert( err&gt;0 );
         <span class="comment">// data is avialbe on some fd</span>

         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;2; i++)
         {
            <a class="code" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> myFd;
            <span class="keywordflow">if</span> ( i==0 )
            {
               myFd=myFd1;
            }
            <span class="keywordflow">else</span>
            {
               myFd=myFd2;
            }

            <span class="keywordflow">if</span> ( myFd!=<a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> )
            {
               <span class="keywordflow">if</span> ( FD_ISSET(myFd,&amp;fdSet) )
               {
                  <span class="keywordtype">char</span> msg[STUN_MAX_MESSAGE_SIZE];
                  <span class="keywordtype">int</span> msgLen = <span class="keyword">sizeof</span>(msg);

                  <a class="code" href="structStunAddress4.html">StunAddress4</a> from;

                  <a class="code" href="stun__udp_8h.html#a6eef3fdbadd5e5a9de73b7be46ce5aa2" title="recive a UDP message">getMessage</a>( myFd,
                              msg,
                              &amp;msgLen,
                              &amp;from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>,
                              &amp;from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>,verbose );

                  <a class="code" href="structStunMessage.html">StunMessage</a> resp;
                  memset(&amp;resp, 0, <span class="keyword">sizeof</span>(<a class="code" href="structStunMessage.html">StunMessage</a>));

                  <a class="code" href="stun_8cc.html#af81c30137f26a4cb158b48aa21f4f681">stunParseMessage</a>( msg,msgLen, resp,verbose );

                  <span class="keywordflow">if</span> ( verbose )
                  {
                     clog &lt;&lt; <span class="stringliteral">&quot;Received message of type &quot;</span> &lt;&lt; resp.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a7cc96e6cbb87582e56f298eb891c43e2">msgType</a>
                          &lt;&lt; <span class="stringliteral">&quot;  id=&quot;</span> &lt;&lt; (int)(resp.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[0]) &lt;&lt; endl;
                  }

                  <span class="keywordflow">switch</span>( resp.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[0] )
                  {
                     <span class="keywordflow">case</span> 1:
                     {
                        <span class="keywordflow">if</span> ( !respTestI )
                        {

                           testIchangedAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = resp.<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
                           testIchangedAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = resp.<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;
                           testImappedAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = resp.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
                           testImappedAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = resp.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;

                           respTestPreservePort = ( testImappedAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> == port );
                           <span class="keywordflow">if</span> ( preservePort )
                           {
                              *preservePort = respTestPreservePort;
                           }

                           testI2dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = resp.<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;

                           <span class="keywordflow">if</span> (sAddr)
                           {
                              sAddr-&gt;<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = testImappedAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;
                              sAddr-&gt;<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = testImappedAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
                           }

                           count = 0;
                        }
                        respTestI=<span class="keyword">true</span>;
                     }
                     <span class="keywordflow">break</span>;
                     <span class="keywordflow">case</span> 2:
                     {
                        respTestII=<span class="keyword">true</span>;
                     }
                     <span class="keywordflow">break</span>;
                     <span class="keywordflow">case</span> 3:
                     {
                        respTestIII=<span class="keyword">true</span>;
                     }
                     <span class="keywordflow">break</span>;
                     <span class="keywordflow">case</span> 10:
                     {
                        <span class="keywordflow">if</span> ( !respTestI2 )
                        {
                           testI2mappedAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = resp.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
                           testI2mappedAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = resp.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;

                           mappedIpSame = <span class="keyword">false</span>;
                           <span class="keywordflow">if</span> ( (testI2mappedAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>  == testImappedAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> ) &amp;&amp;
                                (testI2mappedAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> == testImappedAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> ))
                           {
                              mappedIpSame = <span class="keyword">true</span>;
                           }


                        }
                        respTestI2=<span class="keyword">true</span>;
                     }
                     <span class="keywordflow">break</span>;
                     <span class="keywordflow">case</span> 11:
                     {

                        <span class="keywordflow">if</span> ( hairpin )
                        {
                           *hairpin = <span class="keyword">true</span>;
                        }
                        respTestHairpin = <span class="keyword">true</span>;
                     }
                     <span class="keywordflow">break</span>;
                  }
               }
            }
         }
      }
   }

   <span class="comment">// see if we can bind to this address</span>
   <span class="comment">//cerr &lt;&lt; &quot;try binding to &quot; &lt;&lt; testImappedAddr &lt;&lt; endl;</span>
   <a class="code" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> s = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>( 0<span class="comment">/*use ephemeral*/</span>, testImappedAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, <span class="keyword">false</span> );
   <span class="keywordflow">if</span> ( s != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> )
   {
      <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>(s);
      isNat = <span class="keyword">false</span>;
      <span class="comment">//cerr &lt;&lt; &quot;binding worked&quot; &lt;&lt; endl;</span>
   }
   <span class="keywordflow">else</span>
   {
      isNat = <span class="keyword">true</span>;
      <span class="comment">//cerr &lt;&lt; &quot;binding failed&quot; &lt;&lt; endl;</span>
   }

   <span class="keywordflow">if</span> (verbose)
   {
      clog &lt;&lt; <span class="stringliteral">&quot;test I = &quot;</span> &lt;&lt; respTestI &lt;&lt; endl;
      clog &lt;&lt; <span class="stringliteral">&quot;test II = &quot;</span> &lt;&lt; respTestII &lt;&lt; endl;
      clog &lt;&lt; <span class="stringliteral">&quot;test III = &quot;</span> &lt;&lt; respTestIII &lt;&lt; endl;
      clog &lt;&lt; <span class="stringliteral">&quot;test I(2) = &quot;</span> &lt;&lt; respTestI2 &lt;&lt; endl;
      clog &lt;&lt; <span class="stringliteral">&quot;is nat  = &quot;</span> &lt;&lt; isNat &lt;&lt;endl;
      clog &lt;&lt; <span class="stringliteral">&quot;mapped IP same = &quot;</span> &lt;&lt; mappedIpSame &lt;&lt; endl;
      clog &lt;&lt; <span class="stringliteral">&quot;hairpin = &quot;</span> &lt;&lt; respTestHairpin &lt;&lt; endl;
      clog &lt;&lt; <span class="stringliteral">&quot;preserver port = &quot;</span> &lt;&lt; respTestPreservePort &lt;&lt; endl;
   }

<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span>   <span class="comment">// implement logic flow chart from draft RFC</span>
   <span class="keywordflow">if</span> ( respTestI )
   {
      <span class="keywordflow">if</span> ( isNat )
      {
         <span class="keywordflow">if</span> (respTestII)
         {
            <span class="keywordflow">return</span> StunTypeConeNat;
         }
         <span class="keywordflow">else</span>
         {
            <span class="keywordflow">if</span> ( mappedIpSame )
            {
               <span class="keywordflow">if</span> ( respTestIII )
               {
                  <span class="keywordflow">return</span> StunTypeRestrictedNat;
               }
               <span class="keywordflow">else</span>
               {
                  <span class="keywordflow">return</span> StunTypePortRestrictedNat;
               }
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">return</span> StunTypeSymNat;
            }
         }
      }
      <span class="keywordflow">else</span>
      {
         <span class="keywordflow">if</span> (respTestII)
         {
            <span class="keywordflow">return</span> StunTypeOpen;
         }
         <span class="keywordflow">else</span>
         {
            <span class="keywordflow">return</span> StunTypeSymFirewall;
         }
      }
   }
   <span class="keywordflow">else</span>
   {
      <span class="keywordflow">return</span> StunTypeBlocked;
   }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>   <span class="keywordflow">if</span> ( respTestI ) <span class="comment">// not blocked</span>
   {
      <span class="keywordflow">if</span> ( isNat )
      {
         <span class="keywordflow">if</span> ( mappedIpSame )
         {
            <span class="keywordflow">if</span> (respTestII)
            {
               <span class="keywordflow">return</span> StunTypeIndependentFilter;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> ( respTestIII )
               {
                  <span class="keywordflow">return</span> StunTypeDependentFilter;
               }
               <span class="keywordflow">else</span>
               {
                  <span class="keywordflow">return</span> StunTypePortDependedFilter;
               }
            }
         }
         <span class="keywordflow">else</span> <span class="comment">// mappedIp is not same</span>
         {
            <span class="keywordflow">return</span> StunTypeDependentMapping;
         }
      }
      <span class="keywordflow">else</span>  <span class="comment">// isNat is false</span>
      {
         <span class="keywordflow">if</span> (respTestII)
         {
            <span class="keywordflow">return</span> StunTypeOpen;
         }
         <span class="keywordflow">else</span>
         {
            <span class="keywordflow">return</span> StunTypeFirewall;
         }
      }
   }
   <span class="keywordflow">else</span>
   {
      <span class="keywordflow">return</span> StunTypeBlocked;
   }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
   <span class="keywordflow">return</span> StunTypeUnknown;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa31355ece8353da047608020106c0b60"></a><!-- doxytag: member="stun.cc::stunOpenSocket" ref="aa31355ece8353da047608020106c0b60" args="(StunAddress4 &amp;dest, StunAddress4 *mapAddr, int port, StunAddress4 *srcAddr, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int stunOpenSocket </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>dest</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> *&nbsp;</td>
          <td class="paramname"> <em>mapAddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>port</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> *&nbsp;</td>
          <td class="paramname"> <em>srcAddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l02247">2247</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert( dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> != 0 );
   assert( dest.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 );
   assert( mapAddr );

   <span class="keywordflow">if</span> ( port == 0 )
   {
      port = <a class="code" href="stun_8cc.html#ad4a19c401bea76c471959a32a19b777e" title="return a random number to use as a port">stunRandomPort</a>();
   }
   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> interfaceIp = 0;
   <span class="keywordflow">if</span> ( srcAddr )
   {
      interfaceIp = srcAddr-&gt;<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
   }

   <a class="code" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> myFd = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>(port,interfaceIp,verbose);
   <span class="keywordflow">if</span> (myFd == <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>)
   {
      <span class="keywordflow">return</span> myFd;
   }

   <span class="keywordtype">char</span> msg[STUN_MAX_MESSAGE_SIZE];
   <span class="keywordtype">int</span> msgLen = <span class="keyword">sizeof</span>(msg);

   <a class="code" href="structStunAtrString.html">StunAtrString</a> username;
   <a class="code" href="structStunAtrString.html">StunAtrString</a> password;

   username.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = 0;
   password.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = 0;

<span class="preprocessor">#ifdef USE_TLS</span>
<span class="preprocessor"></span>   <a class="code" href="stun_8cc.html#ae9317a5a127d1281953d961bcfbd2496">stunGetUserNameAndPassword</a>( dest, username, password );
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
   <a class="code" href="stun_8cc.html#ab17bbe96f9bef6d767fbee081ca123d7">stunSendTest</a>(myFd, dest, username, password, 1, 0<span class="comment">/*false*/</span> );

   <a class="code" href="structStunAddress4.html">StunAddress4</a> from;

   <a class="code" href="stun__udp_8h.html#a6eef3fdbadd5e5a9de73b7be46ce5aa2" title="recive a UDP message">getMessage</a>( myFd, msg, &amp;msgLen, &amp;from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, &amp;from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>,verbose );

   <a class="code" href="structStunMessage.html">StunMessage</a> resp;
   memset(&amp;resp, 0, <span class="keyword">sizeof</span>(<a class="code" href="structStunMessage.html">StunMessage</a>));

   <span class="keywordtype">bool</span> ok = <a class="code" href="stun_8cc.html#af81c30137f26a4cb158b48aa21f4f681">stunParseMessage</a>( msg, msgLen, resp,verbose );
   <span class="keywordflow">if</span> (!ok)
   {
      <span class="keywordflow">return</span> -1;
   }

   <a class="code" href="structStunAddress4.html">StunAddress4</a> mappedAddr = resp.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>;
   <a class="code" href="structStunAddress4.html">StunAddress4</a> changedAddr = resp.<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>;

   <span class="comment">//clog &lt;&lt; &quot;--- stunOpenSocket --- &quot; &lt;&lt; endl;</span>
   <span class="comment">//clog &lt;&lt; &quot;\treq  id=&quot; &lt;&lt; req.id &lt;&lt; endl;</span>
   <span class="comment">//clog &lt;&lt; &quot;\tresp id=&quot; &lt;&lt; id &lt;&lt; endl;</span>
   <span class="comment">//clog &lt;&lt; &quot;\tmappedAddr=&quot; &lt;&lt; mappedAddr &lt;&lt; endl;</span>

   *mapAddr = mappedAddr;

   <span class="keywordflow">return</span> myFd;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad45b49d1f841269cea994ca84e8d071b"></a><!-- doxytag: member="stun.cc::stunOpenSocketPair" ref="ad45b49d1f841269cea994ca84e8d071b" args="(StunAddress4 &amp;dest, StunAddress4 *mapAddr, int *fd1, int *fd2, int port, StunAddress4 *srcAddr, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool stunOpenSocketPair </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>dest</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> *&nbsp;</td>
          <td class="paramname"> <em>mapAddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>fd1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>fd2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>port</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> *&nbsp;</td>
          <td class="paramname"> <em>srcAddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l02314">2314</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert( dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>!= 0 );
   assert( dest.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 );
   assert( mapAddr );

   <span class="keyword">const</span> <span class="keywordtype">int</span> NUM=3;

   <span class="keywordflow">if</span> ( port == 0 )
   {
      port = <a class="code" href="stun_8cc.html#ad4a19c401bea76c471959a32a19b777e" title="return a random number to use as a port">stunRandomPort</a>();
   }

   *fd1=-1;
   *fd2=-1;

   <span class="keywordtype">char</span> msg[STUN_MAX_MESSAGE_SIZE];
   <span class="keywordtype">int</span> msgLen =<span class="keyword">sizeof</span>(msg);

   <a class="code" href="structStunAddress4.html">StunAddress4</a> from;
   <span class="keywordtype">int</span> fd[NUM];
   <span class="keywordtype">int</span> i;

   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> interfaceIp = 0;
   <span class="keywordflow">if</span> ( srcAddr )
   {
      interfaceIp = srcAddr-&gt;<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
   }

   <span class="keywordflow">for</span>( i=0; i&lt;NUM; i++)
   {
      fd[i] = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>( (port == 0) ? 0 : (port + i),
                        interfaceIp, verbose);
      <span class="keywordflow">if</span> (fd[i] &lt; 0)
      {
         <span class="keywordflow">while</span> (i &gt; 0)
         {
            <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>(fd[--i]);
         }
         <span class="keywordflow">return</span> <span class="keyword">false</span>;
      }
   }

   <a class="code" href="structStunAtrString.html">StunAtrString</a> username;
   <a class="code" href="structStunAtrString.html">StunAtrString</a> password;

   username.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = 0;
   password.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = 0;

<span class="preprocessor">#ifdef USE_TLS</span>
<span class="preprocessor"></span>   <a class="code" href="stun_8cc.html#ae9317a5a127d1281953d961bcfbd2496">stunGetUserNameAndPassword</a>( dest, username, password );
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
   <span class="keywordflow">for</span>( i=0; i&lt;NUM; i++)
   {
      <a class="code" href="stun_8cc.html#ab17bbe96f9bef6d767fbee081ca123d7">stunSendTest</a>(fd[i], dest, username, password, 1<span class="comment">/*testNum*/</span>, verbose );
   }

   <a class="code" href="structStunAddress4.html">StunAddress4</a> mappedAddr[NUM];
   <span class="keywordflow">for</span>( i=0; i&lt;NUM; i++)
   {
      msgLen = <span class="keyword">sizeof</span>(msg)/<span class="keyword">sizeof</span>(*msg);
      <a class="code" href="stun__udp_8h.html#a6eef3fdbadd5e5a9de73b7be46ce5aa2" title="recive a UDP message">getMessage</a>( fd[i],
                  msg,
                  &amp;msgLen,
                  &amp;from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>,
                  &amp;from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> ,verbose);

      <a class="code" href="structStunMessage.html">StunMessage</a> resp;
      memset(&amp;resp, 0, <span class="keyword">sizeof</span>(<a class="code" href="structStunMessage.html">StunMessage</a>));

      <span class="keywordtype">bool</span> ok = <a class="code" href="stun_8cc.html#af81c30137f26a4cb158b48aa21f4f681">stunParseMessage</a>( msg, msgLen, resp, verbose );
      <span class="keywordflow">if</span> (!ok)
      {
         <span class="keywordflow">return</span> <span class="keyword">false</span>;
      }

      mappedAddr[i] = resp.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>;
      <a class="code" href="structStunAddress4.html">StunAddress4</a> changedAddr = resp.<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>;
   }

   <span class="keywordflow">if</span> (verbose)
   {
      clog &lt;&lt; <span class="stringliteral">&quot;--- stunOpenSocketPair --- &quot;</span> &lt;&lt; endl;
      <span class="keywordflow">for</span>( i=0; i&lt;NUM; i++)
      {
         clog &lt;&lt; <span class="stringliteral">&quot;\t mappedAddr=&quot;</span> &lt;&lt; mappedAddr[i] &lt;&lt; endl;
      }
   }

   <span class="keywordflow">if</span> ( mappedAddr[0].port %2 == 0 )
   {
      <span class="keywordflow">if</span> (  mappedAddr[0].port+1 ==  mappedAddr[1].port )
      {
         *mapAddr = mappedAddr[0];
         *fd1 = fd[0];
         *fd2 = fd[1];
         <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>( fd[2] );
         <span class="keywordflow">return</span> <span class="keyword">true</span>;
      }
   }
   <span class="keywordflow">else</span>
   {
      <span class="keywordflow">if</span> (( mappedAddr[1].port %2 == 0 )
          &amp;&amp; (  mappedAddr[1].port+1 ==  mappedAddr[2].port ))
      {
         *mapAddr = mappedAddr[1];
         *fd1 = fd[1];
         *fd2 = fd[2];
         <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>( fd[0] );
         <span class="keywordflow">return</span> <span class="keyword">true</span>;
      }
   }

   <span class="comment">// something failed, close all and return error</span>
   <span class="keywordflow">for</span>( i=0; i&lt;NUM; i++)
   {
      <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>( fd[i] );
   }

   <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a16624b9ba3d6b2f1c821571fa467c544"></a><!-- doxytag: member="stun.cc::stunParseAtrAddress" ref="a16624b9ba3d6b2f1c821571fa467c544" args="(char *body, unsigned int hdrLen, StunAtrAddress4 &amp;result)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool stunParseAtrAddress </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>body</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>hdrLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrAddress4.html">StunAtrAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>result</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00049">49</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00183">stunParseMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordflow">if</span> ( hdrLen != 8 )
   {
      clog &lt;&lt; <span class="stringliteral">&quot;hdrLen wrong for Address&quot;</span> &lt;&lt;endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   result.<a class="code" href="structStunAtrAddress4.html#afe6ed0534166b0fd194b23b01ddad7b4">pad</a> = *body++;
   result.<a class="code" href="structStunAtrAddress4.html#ab31f05e3cba900d7613bc9f226f171d0">family</a> = *body++;
   <span class="keywordflow">if</span> (result.<a class="code" href="structStunAtrAddress4.html#ab31f05e3cba900d7613bc9f226f171d0">family</a> == <a class="code" href="stun_8h.html#ac2c7bc41e1b918c98583006fd7025bc5" title="define a structure to hold a stun address">IPv4Family</a>)
   {
      <a class="code" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a> nport;
      memcpy(&amp;nport, body, 2); body+=2;
      result.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = ntohs(nport);

      <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> naddr;
      memcpy(&amp;naddr, body, 4); body+=4;
      result.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = ntohl(naddr);
      <span class="keywordflow">return</span> <span class="keyword">true</span>;
   }
   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result.<a class="code" href="structStunAtrAddress4.html#ab31f05e3cba900d7613bc9f226f171d0">family</a> == <a class="code" href="stun_8h.html#a5da56f5efebd69e84bf5fdb74a02bf8a">IPv6Family</a>)
   {
      clog &lt;&lt; <span class="stringliteral">&quot;ipv6 not supported&quot;</span> &lt;&lt; endl;
   }
   <span class="keywordflow">else</span>
   {
      clog &lt;&lt; <span class="stringliteral">&quot;bad address family: &quot;</span> &lt;&lt; result.<a class="code" href="structStunAtrAddress4.html#ab31f05e3cba900d7613bc9f226f171d0">family</a> &lt;&lt; endl;
   }

   <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="af2f9f10bd394cb42037f1997266b978a"></a><!-- doxytag: member="stun.cc::stunParseAtrChangeRequest" ref="af2f9f10bd394cb42037f1997266b978a" args="(char *body, unsigned int hdrLen, StunAtrChangeRequest &amp;result)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool stunParseAtrChangeRequest </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>body</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>hdrLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrChangeRequest.html">StunAtrChangeRequest</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>result</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00082">82</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00183">stunParseMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordflow">if</span> ( hdrLen != 4 )
   {
      clog &lt;&lt; <span class="stringliteral">&quot;hdr length = &quot;</span> &lt;&lt; hdrLen &lt;&lt; <span class="stringliteral">&quot; expecting &quot;</span> &lt;&lt; <span class="keyword">sizeof</span>(result) &lt;&lt; endl;

      clog &lt;&lt; <span class="stringliteral">&quot;Incorrect size for ChangeRequest&quot;</span> &lt;&lt; endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   <span class="keywordflow">else</span>
   {
      memcpy(&amp;result.<a class="code" href="structStunAtrChangeRequest.html#adbb006a8e7cc0637d01959c8ba985c0c">value</a>, body, 4);
      result.<a class="code" href="structStunAtrChangeRequest.html#adbb006a8e7cc0637d01959c8ba985c0c">value</a> = ntohl(result.<a class="code" href="structStunAtrChangeRequest.html#adbb006a8e7cc0637d01959c8ba985c0c">value</a>);
      <span class="keywordflow">return</span> <span class="keyword">true</span>;
   }
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="afdf35a5dc5c3d6b7109c290308e32887"></a><!-- doxytag: member="stun.cc::stunParseAtrError" ref="afdf35a5dc5c3d6b7109c290308e32887" args="(char *body, unsigned int hdrLen, StunAtrError &amp;result)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool stunParseAtrError </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>body</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>hdrLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrError.html">StunAtrError</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>result</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00100">100</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00183">stunParseMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordflow">if</span> ( hdrLen &gt;= <span class="keyword">sizeof</span>(result) )
   {
      clog &lt;&lt; <span class="stringliteral">&quot;head on Error too large&quot;</span> &lt;&lt; endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   <span class="keywordflow">else</span>
   {
      memcpy(&amp;result.<a class="code" href="structStunAtrError.html#ae2d32994bcf7387452902e139f2b652f">pad</a>, body, 2); body+=2;
      result.<a class="code" href="structStunAtrError.html#ae2d32994bcf7387452902e139f2b652f">pad</a> = ntohs(result.<a class="code" href="structStunAtrError.html#ae2d32994bcf7387452902e139f2b652f">pad</a>);
      result.<a class="code" href="structStunAtrError.html#aef65890aa74d342d326ea74000064be5">errorClass</a> = *body++;
      result.<a class="code" href="structStunAtrError.html#abdee224c138f23ad06aeb97ed9d6e0fe">number</a> = *body++;

      result.<a class="code" href="structStunAtrError.html#adcac61cdac715d64ebaa78e6847e1108">sizeReason</a> = hdrLen - 4;
      memcpy(&amp;result.<a class="code" href="structStunAtrError.html#a3bb11d3802d0bfe65a153d8a6bccd472">reason</a>, body, result.<a class="code" href="structStunAtrError.html#adcac61cdac715d64ebaa78e6847e1108">sizeReason</a>);
      result.<a class="code" href="structStunAtrError.html#a3bb11d3802d0bfe65a153d8a6bccd472">reason</a>[result.<a class="code" href="structStunAtrError.html#adcac61cdac715d64ebaa78e6847e1108">sizeReason</a>] = 0;
      <span class="keywordflow">return</span> <span class="keyword">true</span>;
   }
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a4e7e4c29e1424831e001c9ffa9b74b53"></a><!-- doxytag: member="stun.cc::stunParseAtrIntegrity" ref="a4e7e4c29e1424831e001c9ffa9b74b53" args="(char *body, unsigned int hdrLen, StunAtrIntegrity &amp;result)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool stunParseAtrIntegrity </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>body</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>hdrLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrIntegrity.html">StunAtrIntegrity</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>result</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00167">167</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00183">stunParseMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordflow">if</span> ( hdrLen != 20)
   {
      clog &lt;&lt; <span class="stringliteral">&quot;MessageIntegrity must be 20 bytes&quot;</span> &lt;&lt; endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   <span class="keywordflow">else</span>
   {
      memcpy(&amp;result.<a class="code" href="structStunAtrIntegrity.html#a584fa6b758583be87dfad5c10da9fd44">hash</a>, body, hdrLen);
      <span class="keywordflow">return</span> <span class="keyword">true</span>;
   }
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2c161a60854ecb6fe959dff3fe422310"></a><!-- doxytag: member="stun.cc::stunParseAtrString" ref="a2c161a60854ecb6fe959dff3fe422310" args="(char *body, unsigned int hdrLen, StunAtrString &amp;result)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool stunParseAtrString </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>body</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>hdrLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>result</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00143">143</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00183">stunParseMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordflow">if</span> ( hdrLen &gt;= <a class="code" href="stun_8h.html#ac4d86797b42c1696b7acbd715481c0b1">STUN_MAX_STRING</a> )
   {
      clog &lt;&lt; <span class="stringliteral">&quot;String is too large&quot;</span> &lt;&lt; endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   <span class="keywordflow">else</span>
   {
      <span class="keywordflow">if</span> (hdrLen % 4 != 0)
      {
         clog &lt;&lt; <span class="stringliteral">&quot;Bad length string &quot;</span> &lt;&lt; hdrLen &lt;&lt; endl;
         <span class="keywordflow">return</span> <span class="keyword">false</span>;
      }

      result.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = hdrLen;
      memcpy(&amp;result.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>, body, hdrLen);
      result.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>[hdrLen] = 0;
      <span class="keywordflow">return</span> <span class="keyword">true</span>;
   }
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a739d3cc61a2a1609b96d535ae74a6221"></a><!-- doxytag: member="stun.cc::stunParseAtrUnknown" ref="a739d3cc61a2a1609b96d535ae74a6221" args="(char *body, unsigned int hdrLen, StunAtrUnknown &amp;result)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool stunParseAtrUnknown </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>body</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>hdrLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrUnknown.html">StunAtrUnknown</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>result</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00122">122</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00183">stunParseMessage()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordflow">if</span> ( hdrLen &gt;= <span class="keyword">sizeof</span>(result) )
   {
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   <span class="keywordflow">else</span>
   {
      <span class="keywordflow">if</span> (hdrLen % 4 != 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;
      result.<a class="code" href="structStunAtrUnknown.html#a39f2cca60b76d9476cd2a61a349e72d6">numAttributes</a> = hdrLen / 4;
      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;result.<a class="code" href="structStunAtrUnknown.html#a39f2cca60b76d9476cd2a61a349e72d6">numAttributes</a>; i++)
      {
         memcpy(&amp;result.<a class="code" href="structStunAtrUnknown.html#a2a9ac6afb38e1f951bc7cb8ec0b2a888">attrType</a>[i], body, 2); body+=2;
         result.<a class="code" href="structStunAtrUnknown.html#a2a9ac6afb38e1f951bc7cb8ec0b2a888">attrType</a>[i] = ntohs(result.<a class="code" href="structStunAtrUnknown.html#a2a9ac6afb38e1f951bc7cb8ec0b2a888">attrType</a>[i]);
      }
      <span class="keywordflow">return</span> <span class="keyword">true</span>;
   }
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="af497f133b72e1dc4595d9d293d706351"></a><!-- doxytag: member="stun.cc::stunParseHostName" ref="af497f133b72e1dc4595d9d293d706351" args="(char *peerName, UInt32 &amp;ip, UInt16 &amp;portVal, UInt16 defaultPort)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool stunParseHostName </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>peerName</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>ip</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>portVal</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a>&nbsp;</td>
          <td class="paramname"> <em>defaultPort</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00863">863</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00964">stunParseServerName()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   in_addr sin_addr;

   <span class="keywordtype">char</span> host[512];
   strncpy(host,peerName,512);
   host[512-1]=<span class="charliteral">&#39;\0&#39;</span>;
   <span class="keywordtype">char</span>* port = NULL;

   <span class="keywordtype">int</span> portNum = defaultPort;

   <span class="comment">// pull out the port part if present.</span>
   <span class="keywordtype">char</span>* sep = strchr(host,<span class="charliteral">&#39;:&#39;</span>);

   <span class="keywordflow">if</span> ( sep == NULL )
   {
      portNum = defaultPort;
   }
   <span class="keywordflow">else</span>
   {
      *sep = <span class="charliteral">&#39;\0&#39;</span>;
      port = sep + 1;
      <span class="comment">// set port part</span>

      <span class="keywordtype">char</span>* endPtr=NULL;

      portNum = strtol(port,&amp;endPtr,10);

      <span class="keywordflow">if</span> ( endPtr != NULL )
      {
         <span class="keywordflow">if</span> ( *endPtr != <span class="charliteral">&#39;\0&#39;</span> )
         {
            portNum = defaultPort;
         }
      }
   }

   <span class="keywordflow">if</span> ( portNum &lt; 1024 ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
   <span class="keywordflow">if</span> ( portNum &gt;= 0xFFFF ) <span class="keywordflow">return</span> <span class="keyword">false</span>;

   <span class="comment">// figure out the host part</span>
   <span class="keyword">struct </span>hostent* h;

<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>   assert( strlen(host) &gt;= 1 );
   <span class="keywordflow">if</span> ( isdigit( host[0] ) )
   {
      <span class="comment">// assume it is a ip address</span>
      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> a = inet_addr(host);
      <span class="comment">//cerr &lt;&lt; &quot;a=0x&quot; &lt;&lt; hex &lt;&lt; a &lt;&lt; dec &lt;&lt; endl;</span>

      ip = ntohl( a );
   }
   <span class="keywordflow">else</span>
   {
      <span class="comment">// assume it is a host name</span>
      h = gethostbyname( host );

      <span class="keywordflow">if</span> ( h == NULL )
      {
         <span class="keywordtype">int</span> err = <a class="code" href="stun__udp_8h.html#a604d53fe9d66ce3a47ab2354b20f8e62">getErrno</a>();
         std::cerr &lt;&lt; <span class="stringliteral">&quot;error was &quot;</span> &lt;&lt; err &lt;&lt; std::endl;
         assert( err != <a class="code" href="stun__udp_8h.html#a25b517a4390903e6fa0f945e80a3394c">WSANOTINITIALISED</a> );

         ip = ntohl( 0x7F000001L );

         <span class="keywordflow">return</span> <span class="keyword">false</span>;
      }
      <span class="keywordflow">else</span>
      {
         sin_addr = *(<span class="keyword">struct </span>in_addr*)h-&gt;h_addr;
         ip = ntohl( sin_addr.s_addr );
      }
   }

<span class="preprocessor">#else</span>
<span class="preprocessor"></span>   h = gethostbyname( host );
   <span class="keywordflow">if</span> ( h == NULL )
   {
      <span class="keywordtype">int</span> err = <a class="code" href="stun__udp_8h.html#a604d53fe9d66ce3a47ab2354b20f8e62">getErrno</a>();
      std::cerr &lt;&lt; <span class="stringliteral">&quot;error was &quot;</span> &lt;&lt; err &lt;&lt; std::endl;
      ip = ntohl( 0x7F000001L );
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   <span class="keywordflow">else</span>
   {
      sin_addr = *(<span class="keyword">struct </span>in_addr*)h-&gt;h_addr;
      ip = ntohl( sin_addr.s_addr );
   }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
   portVal = portNum;

   <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="af81c30137f26a4cb158b48aa21f4f681"></a><!-- doxytag: member="stun.cc::stunParseMessage" ref="af81c30137f26a4cb158b48aa21f4f681" args="(char *buf, unsigned int bufLen, StunMessage &amp;msg, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool stunParseMessage </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>bufLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunMessage.html">StunMessage</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00183">183</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01876">stunNatType()</a>, <a class="el" href="stun_8cc_source.html#l02247">stunOpenSocket()</a>, <a class="el" href="stun_8cc_source.html#l02314">stunOpenSocketPair()</a>, <a class="el" href="stun_8cc_source.html#l01019">stunServerProcessMsg()</a>, and <a class="el" href="stun_8cc_source.html#l01813">stunTest()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Received stun message: &quot;</span> &lt;&lt; bufLen &lt;&lt; <span class="stringliteral">&quot; bytes&quot;</span> &lt;&lt; endl;
   memset(&amp;msg, 0, <span class="keyword">sizeof</span>(msg));

   <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(<a class="code" href="structStunMsgHdr.html">StunMsgHdr</a>) &gt; bufLen)
   {
      clog &lt;&lt; <span class="stringliteral">&quot;Bad message&quot;</span> &lt;&lt; endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }

   memcpy(&amp;msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>, buf, <span class="keyword">sizeof</span>(<a class="code" href="structStunMsgHdr.html">StunMsgHdr</a>));
   msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a7cc96e6cbb87582e56f298eb891c43e2">msgType</a> = ntohs(msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a7cc96e6cbb87582e56f298eb891c43e2">msgType</a>);
   msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a619e2158af7fd1b3de12b88899a7c5dd">msgLength</a> = ntohs(msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a619e2158af7fd1b3de12b88899a7c5dd">msgLength</a>);

   <span class="keywordflow">if</span> (msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a619e2158af7fd1b3de12b88899a7c5dd">msgLength</a> + <span class="keyword">sizeof</span>(<a class="code" href="structStunMsgHdr.html">StunMsgHdr</a>) != bufLen)
   {
      clog &lt;&lt; <span class="stringliteral">&quot;Message header length doesn&#39;t match message size: &quot;</span>
           &lt;&lt; msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a619e2158af7fd1b3de12b88899a7c5dd">msgLength</a> &lt;&lt; <span class="stringliteral">&quot; - &quot;</span> &lt;&lt; bufLen &lt;&lt; endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }

   <span class="keywordtype">char</span>* body = buf + <span class="keyword">sizeof</span>(<a class="code" href="structStunMsgHdr.html">StunMsgHdr</a>);
   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = msg.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a619e2158af7fd1b3de12b88899a7c5dd">msgLength</a>;

   <span class="comment">//clog &lt;&lt; &quot;bytes after header = &quot; &lt;&lt; size &lt;&lt; endl;</span>

   <span class="keywordflow">while</span> ( size &gt; 0 )
   {
      <span class="comment">// !jf! should check that there are enough bytes left in the buffer</span>

      <a class="code" href="structStunAtrHdr.html">StunAtrHdr</a>* attr = <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structStunAtrHdr.html">StunAtrHdr</a>*<span class="keyword">&gt;</span>(body);

      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> attrLen = ntohs(attr-&gt;<a class="code" href="structStunAtrHdr.html#a979c6bd5a4c93128cc316bef605191f5">length</a>);
      <span class="keywordtype">int</span> atrType = ntohs(attr-&gt;<a class="code" href="structStunAtrHdr.html#a303835ac7916984e097587ad499b568e">type</a>);

      <span class="comment">//if (verbose) clog &lt;&lt; &quot;Found attribute type=&quot; &lt;&lt; AttrNames[atrType] &lt;&lt; &quot; length=&quot; &lt;&lt; attrLen &lt;&lt; endl;</span>
      <span class="keywordflow">if</span> ( attrLen+4 &gt; size )
      {
         clog &lt;&lt; <span class="stringliteral">&quot;claims attribute is larger than size of message &quot;</span>
              &lt;&lt;<span class="stringliteral">&quot;(attribute type=&quot;</span>&lt;&lt;atrType&lt;&lt;<span class="stringliteral">&quot;)&quot;</span>&lt;&lt; endl;
         <span class="keywordflow">return</span> <span class="keyword">false</span>;
      }

      body += 4; <span class="comment">// skip the length and type in attribute header</span>
      size -= 4;

      <span class="keywordflow">switch</span> ( atrType )
      {
         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a2479ede510923cc5e8a0c2da5558acc3">MappedAddress</a>:
            msg.<a class="code" href="structStunMessage.html#a605889708c9696c60f1284b3c486ca18">hasMappedAddress</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> ( <a class="code" href="stun_8cc.html#a16624b9ba3d6b2f1c821571fa467c544">stunParseAtrAddress</a>(  body,  attrLen,  msg.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a> )== <span class="keyword">false</span> )
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing MappedAddress&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;MappedAddress = &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
            }

            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a91ab7c5c3d71a86a77679d0d2786fae8">ResponseAddress</a>:
            msg.<a class="code" href="structStunMessage.html#ab7926e7d5ceb2d9c3337439ec89ec87d">hasResponseAddress</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> ( <a class="code" href="stun_8cc.html#a16624b9ba3d6b2f1c821571fa467c544">stunParseAtrAddress</a>(  body,  attrLen,  msg.<a class="code" href="structStunMessage.html#adb06537683f153438687995e8d1783c6">responseAddress</a> )== <span class="keyword">false</span> )
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing ResponseAddress&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;ResponseAddress = &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#adb06537683f153438687995e8d1783c6">responseAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a6183c3f6e20ddc5bf9acd531d37c4b08">ChangeRequest</a>:
            msg.<a class="code" href="structStunMessage.html#a0fe2488f060fe65507c9a58bbb66899f">hasChangeRequest</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> (<a class="code" href="stun_8cc.html#af2f9f10bd394cb42037f1997266b978a">stunParseAtrChangeRequest</a>( body, attrLen, msg.<a class="code" href="structStunMessage.html#a65e5de40376764ea12d96f5b5ebe2c29">changeRequest</a>) == <span class="keyword">false</span>)
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing ChangeRequest&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;ChangeRequest = &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a65e5de40376764ea12d96f5b5ebe2c29">changeRequest</a>.<a class="code" href="structStunAtrChangeRequest.html#adbb006a8e7cc0637d01959c8ba985c0c">value</a> &lt;&lt; endl;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#ab2b81c4c09625b39c5a1d57ee2b460a4">SourceAddress</a>:
            msg.<a class="code" href="structStunMessage.html#a5feb7431931118218d78642c4a7c83db">hasSourceAddress</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> ( <a class="code" href="stun_8cc.html#a16624b9ba3d6b2f1c821571fa467c544">stunParseAtrAddress</a>(  body,  attrLen,  msg.<a class="code" href="structStunMessage.html#ab7203fc2e5a8b1248c9e14ce6e6ec313">sourceAddress</a> )== <span class="keyword">false</span> )
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing SourceAddress&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;SourceAddress = &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#ab7203fc2e5a8b1248c9e14ce6e6ec313">sourceAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a930a1eeda1f0620132bfdea315e711f7">ChangedAddress</a>:
            msg.<a class="code" href="structStunMessage.html#a4d3036e012cce04e6be670898f4e24eb">hasChangedAddress</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> ( <a class="code" href="stun_8cc.html#a16624b9ba3d6b2f1c821571fa467c544">stunParseAtrAddress</a>(  body,  attrLen,  msg.<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a> )== <span class="keyword">false</span> )
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing ChangedAddress&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;ChangedAddress = &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a0845232ed07b469d1262348e1618b962">Username</a>:
            msg.<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> (<a class="code" href="stun_8cc.html#a2c161a60854ecb6fe959dff3fe422310">stunParseAtrString</a>( body, attrLen, msg.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>) == <span class="keyword">false</span>)
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing Username&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Username = &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a> &lt;&lt; endl;
            }

            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a1741d36983135a1f2eefa1b1473956a2">Password</a>:
            msg.<a class="code" href="structStunMessage.html#ac09b6e5f081db9f5ec2c1a4532676366">hasPassword</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> (<a class="code" href="stun_8cc.html#a2c161a60854ecb6fe959dff3fe422310">stunParseAtrString</a>( body, attrLen, msg.<a class="code" href="structStunMessage.html#aa15cab0d5b2a9a044895e81d527c1b68">password</a>) == <span class="keyword">false</span>)
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing Password&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Password = &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#aa15cab0d5b2a9a044895e81d527c1b68">password</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a> &lt;&lt; endl;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a0371caac677f72f19ea073dd152197f0">MessageIntegrity</a>:
            msg.<a class="code" href="structStunMessage.html#a2a47413181e29d0de7063d4bfa6609ff">hasMessageIntegrity</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> (<a class="code" href="stun_8cc.html#a4e7e4c29e1424831e001c9ffa9b74b53">stunParseAtrIntegrity</a>( body, attrLen, msg.<a class="code" href="structStunMessage.html#a1b2c965443dc78688973c049713072d0">messageIntegrity</a>) == <span class="keyword">false</span>)
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing MessageIntegrity&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="comment">//if (verbose) clog &lt;&lt; &quot;MessageIntegrity = &quot; &lt;&lt; msg.messageIntegrity.hash &lt;&lt; endl;</span>
            }

            <span class="comment">// read the current HMAC</span>
            <span class="comment">// look up the password given the user of given the transaction id</span>
            <span class="comment">// compute the HMAC on the buffer</span>
            <span class="comment">// decide if they match or not</span>
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a750ec1534b2aebc05c90b9e6fe9532c7">ErrorCode</a>:
            msg.<a class="code" href="structStunMessage.html#afe66349979726d392fa4f0c9c84ebedf">hasErrorCode</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> (<a class="code" href="stun_8cc.html#afdf35a5dc5c3d6b7109c290308e32887">stunParseAtrError</a>(body, attrLen, msg.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>) == <span class="keyword">false</span>)
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing ErrorCode&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;ErrorCode = &quot;</span> &lt;&lt; int(msg.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>.<a class="code" href="structStunAtrError.html#aef65890aa74d342d326ea74000064be5">errorClass</a>)
                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; int(msg.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>.<a class="code" href="structStunAtrError.html#abdee224c138f23ad06aeb97ed9d6e0fe">number</a>)
                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a8e6a7183381efea4e4a92e2b4e8bba6a">errorCode</a>.<a class="code" href="structStunAtrError.html#a3bb11d3802d0bfe65a153d8a6bccd472">reason</a> &lt;&lt; endl;
            }

            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#ac5d0f4ecd6bc741747a3ff79b6e5a96c">UnknownAttribute</a>:
            msg.<a class="code" href="structStunMessage.html#a29507d464e9900ced2ce92c75bb158a4">hasUnknownAttributes</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> (<a class="code" href="stun_8cc.html#a739d3cc61a2a1609b96d535ae74a6221">stunParseAtrUnknown</a>(body, attrLen, msg.<a class="code" href="structStunMessage.html#a40311e31449afb24c3e40db8c8fc6911">unknownAttributes</a>) == <span class="keyword">false</span>)
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing UnknownAttribute&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a11d1c4b717d340b20582ac7dead1cd49">ReflectedFrom</a>:
            msg.<a class="code" href="structStunMessage.html#ab88124a21ca8562a44a696ed4b39fa4f">hasReflectedFrom</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> ( <a class="code" href="stun_8cc.html#a16624b9ba3d6b2f1c821571fa467c544">stunParseAtrAddress</a>(  body,  attrLen,  msg.<a class="code" href="structStunMessage.html#ab80a59189b1b938698339f788417f32b">reflectedFrom</a> ) == <span class="keyword">false</span> )
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing ReflectedFrom&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#afd742381f8d8131e21dac399b8a26c3a">XorMappedAddress</a>:
            msg.<a class="code" href="structStunMessage.html#a8e149870681eebee0a55b0f630c89471">hasXorMappedAddress</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> ( <a class="code" href="stun_8cc.html#a16624b9ba3d6b2f1c821571fa467c544">stunParseAtrAddress</a>(  body,  attrLen,  msg.<a class="code" href="structStunMessage.html#a2ef5db0ff5bd395800262b8b9d49b6bb">xorMappedAddress</a> ) == <span class="keyword">false</span> )
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing XorMappedAddress&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;XorMappedAddress = &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a615f23f67cf9c716c91fa445e272da3c">XorOnly</a>:
            msg.<a class="code" href="structStunMessage.html#ad2d3b64955956272841f656fe354aa18">xorOnly</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> (verbose)
            {
               clog &lt;&lt; <span class="stringliteral">&quot;xorOnly = true&quot;</span> &lt;&lt; endl;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a53f47b517798fa3e1b64313d04168ea2">ServerName</a>:
            msg.<a class="code" href="structStunMessage.html#afcf544b5b0663edad215525b8bcd67df">hasServerName</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> (<a class="code" href="stun_8cc.html#a2c161a60854ecb6fe959dff3fe422310">stunParseAtrString</a>( body, attrLen, msg.<a class="code" href="structStunMessage.html#a1998c160a79020e146957c14ae1add11">serverName</a>) == <span class="keyword">false</span>)
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing ServerName&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;ServerName = &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a1998c160a79020e146957c14ae1add11">serverName</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a> &lt;&lt; endl;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a4d77a59e0dc2c3c06deb3730baa78f80">SecondaryAddress</a>:
            msg.<a class="code" href="structStunMessage.html#ace894f36510487ec8151609513974eba">hasSecondaryAddress</a> = <span class="keyword">true</span>;
            <span class="keywordflow">if</span> ( <a class="code" href="stun_8cc.html#a16624b9ba3d6b2f1c821571fa467c544">stunParseAtrAddress</a>(  body,  attrLen,  msg.<a class="code" href="structStunMessage.html#a8fc16bd394228aa6fa6e1f5f98c356c1">secondaryAddress</a> ) == <span class="keyword">false</span> )
            {
               clog &lt;&lt; <span class="stringliteral">&quot;problem parsing secondaryAddress&quot;</span> &lt;&lt; endl;
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;SecondaryAddress = &quot;</span> &lt;&lt; msg.<a class="code" href="structStunMessage.html#a8fc16bd394228aa6fa6e1f5f98c356c1">secondaryAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
            }
            <span class="keywordflow">break</span>;

         <span class="keywordflow">default</span>:
            <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Unknown attribute: &quot;</span> &lt;&lt; atrType &lt;&lt; endl;
            <span class="keywordflow">if</span> ( atrType &lt;= 0x7FFF )
            {
               <span class="keywordflow">return</span> <span class="keyword">false</span>;
            }
      }

      body += attrLen;
      size -= attrLen;
   }

   <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="acc6ab05f9237a355919b963c6835ec9e"></a><!-- doxytag: member="stun.cc::stunParseServerName" ref="acc6ab05f9237a355919b963c6835ec9e" args="(char *name, StunAddress4 &amp;addr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool stunParseServerName </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>addr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>find the IP address of a the specified stun server - return false is fails parse </p>

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00964">964</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="SingleHostUnderlayConfigurator_8cc_source.html#l00057">SingleHostUnderlayConfigurator::initializeUnderlay()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert(name);

   <span class="comment">// TODO - put in DNS SRV stuff.</span>

   <span class="keywordtype">bool</span> ret = <a class="code" href="stun_8cc.html#af497f133b72e1dc4595d9d293d706351">stunParseHostName</a>( name, addr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, addr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>, 3478);
   <span class="keywordflow">if</span> ( ret != <span class="keyword">true</span> )
   {
       addr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>=0xFFFF;
   }
   <span class="keywordflow">return</span> ret;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a67e399c9420f09178de194bee0bde87a"></a><!-- doxytag: member="stun.cc::stunRand" ref="a67e399c9420f09178de194bee0bde87a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int stunRand </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00651">651</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01697">stunBuildReqSimple()</a>, <a class="el" href="stun_8cc_source.html#l00764">stunCreateUserName()</a>, and <a class="el" href="stun_8cc_source.html#l00708">stunRandomPort()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="comment">// return 32 bits of random stuff</span>
   assert( <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) == 4 );
   <span class="keyword">static</span> <span class="keywordtype">bool</span> init=<span class="keyword">false</span>;
   <span class="keywordflow">if</span> ( !init )
   {
      init = <span class="keyword">true</span>;

      <a class="code" href="stun_8h.html#aa1d7d331b6d522d6d9840fece27108d8">UInt64</a> tick;

<span class="preprocessor">#if defined(MSVC_WIN32)</span>
<span class="preprocessor"></span>      <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lowtick=0,hightick=0;
      __asm
         {
            rdtsc
               mov lowtick, eax
               mov hightick, edx
               }
      tick = hightick;
      tick &lt;&lt;= 32;
      tick |= lowtick;
<span class="preprocessor">#elif (defined(WIN32) || defined(__GNUC__)) &amp;&amp; ( defined(__i686__) || defined(__i386__) || defined(__x86_64__) )</span>
<span class="preprocessor"></span>      <span class="keyword">asm</span>(<span class="stringliteral">&quot;rdtsc&quot;</span> : <span class="stringliteral">&quot;=A&quot;</span> (tick));
<span class="preprocessor">#elif defined (__SUNPRO_CC) || defined( __sparc__ )</span>
<span class="preprocessor"></span>      tick = gethrtime();
<span class="preprocessor">#elif defined(__MACH__)</span>
<span class="preprocessor"></span>      <span class="keywordtype">int</span> fd=open(<span class="stringliteral">&quot;/dev/random&quot;</span>,O_RDONLY);
      read(fd,&amp;tick,<span class="keyword">sizeof</span>(tick));
      <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>(fd);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">#     error Need some way to seed the random number generator</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>      <span class="keywordtype">int</span> seed = int(tick);
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>      srand(seed);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      srandom(seed);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>   }

<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span>   assert( RAND_MAX == 0x7fff );
   <span class="keywordtype">int</span> r1 = rand();
   <span class="keywordtype">int</span> r2 = rand();

   <span class="keywordtype">int</span> ret = (r1&lt;&lt;16) + r2;

   <span class="keywordflow">return</span> ret;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>   <span class="keywordflow">return</span> random();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad4a19c401bea76c471959a32a19b777e"></a><!-- doxytag: member="stun.cc::stunRandomPort" ref="ad4a19c401bea76c471959a32a19b777e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int stunRandomPort </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>return a random number to use as a port </p>

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00708">708</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01876">stunNatType()</a>, <a class="el" href="stun_8cc_source.html#l02247">stunOpenSocket()</a>, <a class="el" href="stun_8cc_source.html#l02314">stunOpenSocketPair()</a>, and <a class="el" href="stun_8cc_source.html#l01813">stunTest()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordtype">int</span> min=0x4000;
   <span class="keywordtype">int</span> max=0x7FFF;

   <span class="keywordtype">int</span> ret = <a class="code" href="stun_8cc.html#a67e399c9420f09178de194bee0bde87a">stunRand</a>();
   ret = ret|min;
   ret = ret&amp;max;

   <span class="keywordflow">return</span> ret;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab17bbe96f9bef6d767fbee081ca123d7"></a><!-- doxytag: member="stun.cc::stunSendTest" ref="ab17bbe96f9bef6d767fbee081ca123d7" args="(Socket myFd, StunAddress4 &amp;dest, const StunAtrString &amp;username, const StunAtrString &amp;password, int testNum, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void stunSendTest </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a>&nbsp;</td>
          <td class="paramname"> <em>myFd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>dest</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>username</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structStunAtrString.html">StunAtrString</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>password</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>testNum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01734">1734</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01876">stunNatType()</a>, <a class="el" href="stun_8cc_source.html#l02247">stunOpenSocket()</a>, <a class="el" href="stun_8cc_source.html#l02314">stunOpenSocketPair()</a>, and <a class="el" href="stun_8cc_source.html#l01813">stunTest()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert( dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> != 0 );
   assert( dest.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 );

   <span class="keywordtype">bool</span> changePort=<span class="keyword">false</span>;
   <span class="keywordtype">bool</span> changeIP=<span class="keyword">false</span>;
   <span class="keywordtype">bool</span> discard=<span class="keyword">false</span>;

   <span class="keywordflow">switch</span> (testNum)
   {
      <span class="keywordflow">case</span> 1:
      <span class="keywordflow">case</span> 10:
      <span class="keywordflow">case</span> 11:
         <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> 2:
         <span class="comment">//changePort=true;</span>
         changeIP=<span class="keyword">true</span>;
         <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> 3:
         changePort=<span class="keyword">true</span>;
         <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> 4:
         changeIP=<span class="keyword">true</span>;
         <span class="keywordflow">break</span>;
      <span class="keywordflow">case</span> 5:
         discard=<span class="keyword">true</span>;
         <span class="keywordflow">break</span>;
      <span class="keywordflow">default</span>:
         cerr &lt;&lt; <span class="stringliteral">&quot;Test &quot;</span> &lt;&lt; testNum &lt;&lt;<span class="stringliteral">&quot; is unkown\n&quot;</span>;
         assert(0);
   }

   <a class="code" href="structStunMessage.html">StunMessage</a> req;
   memset(&amp;req, 0, <span class="keyword">sizeof</span>(<a class="code" href="structStunMessage.html">StunMessage</a>));

   <a class="code" href="stun_8cc.html#a07bb6d28e9a67cc882184b04c227e82b">stunBuildReqSimple</a>( &amp;req, username,
                       changePort , changeIP ,
                       testNum );

   <span class="keywordtype">char</span> buf[STUN_MAX_MESSAGE_SIZE];
   <span class="keywordtype">int</span> len = STUN_MAX_MESSAGE_SIZE;

   len = <a class="code" href="stun_8cc.html#a4f9e869279d41bbf1785d321b4360f61">stunEncodeMessage</a>( req, buf, len, password,verbose );

   <span class="keywordflow">if</span> ( verbose )
   {
      clog &lt;&lt; <span class="stringliteral">&quot;About to send msg of len &quot;</span> &lt;&lt; len &lt;&lt; <span class="stringliteral">&quot; to &quot;</span> &lt;&lt; dest &lt;&lt; endl;
   }

   <a class="code" href="stun__udp_8h.html#a784917c5dceb731fee666978078b8bc5" title="send a UDP message">sendMessage</a>( myFd, buf, len, dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, dest.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>, verbose );

   <span class="comment">// add some delay so the packets don&#39;t get sent too quickly</span>
<span class="preprocessor">#ifdef WIN32 // !cj! TODO - should fix this up in windows</span>
<span class="preprocessor"></span>                 clock_t now = clock();
                 assert( CLOCKS_PER_SEC == 1000 );
                 <span class="keywordflow">while</span> ( clock() &lt;= now+10 ) { };
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>                 usleep(10*1000);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9c0e750bd19cdfcf4b2b36f9ddefc497"></a><!-- doxytag: member="stun.cc::stunServerProcess" ref="a9c0e750bd19cdfcf4b2b36f9ddefc497" args="(StunServerInfo &amp;info, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool stunServerProcess </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structStunServerInfo.html">StunServerInfo</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>info</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>return true if all is OK </p>

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01351">1351</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordtype">char</span> msg[STUN_MAX_MESSAGE_SIZE];
   <span class="keywordtype">int</span> msgLen = <span class="keyword">sizeof</span>(msg);

   <span class="keywordtype">bool</span> ok = <span class="keyword">false</span>;
   <span class="keywordtype">bool</span> recvAltIp =<span class="keyword">false</span>;
   <span class="keywordtype">bool</span> recvAltPort = <span class="keyword">false</span>;

   fd_set fdSet;
   <a class="code" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> maxFd=0;

   FD_ZERO(&amp;fdSet);
   FD_SET(info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a>,&amp;fdSet);
   <span class="keywordflow">if</span> ( info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a> &gt;= maxFd ) maxFd=info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a>+1;
   FD_SET(info.<a class="code" href="structStunServerInfo.html#a2da8a94e9a9867e7c5d3b3e3c317120c">altPortFd</a>,&amp;fdSet);
   <span class="keywordflow">if</span> ( info.<a class="code" href="structStunServerInfo.html#a2da8a94e9a9867e7c5d3b3e3c317120c">altPortFd</a> &gt;= maxFd ) maxFd=info.<a class="code" href="structStunServerInfo.html#a2da8a94e9a9867e7c5d3b3e3c317120c">altPortFd</a>+1;

   <span class="keywordflow">if</span> ( info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a> != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> )
   {
      FD_SET(info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>,&amp;fdSet);
      <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>&gt;=maxFd) maxFd=info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>+1;
   }
   <span class="keywordflow">if</span> ( info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a> != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> )
   {
      FD_SET(info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>,&amp;fdSet);
      <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>&gt;=maxFd) maxFd=info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>+1;
   }

   <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#a5dcc784d754928455caab60d6a34f73e">relay</a>)
   {
      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;MAX_MEDIA_RELAYS; ++i)
      {
         <a class="code" href="structStunMediaRelay.html">StunMediaRelay</a>* relay = &amp;info.<a class="code" href="structStunServerInfo.html#aed8568086c549986f985f02a691da173">relays</a>[i];
         <span class="keywordflow">if</span> (relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a>)
         {
            FD_SET(relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a>, &amp;fdSet);
            <span class="keywordflow">if</span> (relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a> &gt;= maxFd)
                        {
                                maxFd=relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a>+1;
                        }
         }
      }
   }

   <span class="keywordflow">if</span> ( info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a> != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> )
   {
      FD_SET(info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>,&amp;fdSet);
      <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>&gt;=maxFd) maxFd=info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>+1;
   }
   <span class="keywordflow">if</span> ( info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a> != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> )
   {
      FD_SET(info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>,&amp;fdSet);
      <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>&gt;=maxFd) maxFd=info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>+1;
   }

   <span class="keyword">struct </span>timeval tv;
   tv.tv_sec = 0;
   tv.tv_usec = 1000;

   <span class="keywordtype">int</span> e = select( maxFd, &amp;fdSet, NULL,NULL, &amp;tv );
   <span class="keywordflow">if</span> (e &lt; 0)
   {
      <span class="keywordtype">int</span> err = <a class="code" href="stun__udp_8h.html#a604d53fe9d66ce3a47ab2354b20f8e62">getErrno</a>();
      clog &lt;&lt; <span class="stringliteral">&quot;Error on select: &quot;</span> &lt;&lt; strerror(err) &lt;&lt; endl;
   }
   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e &gt;= 0)
   {
      <a class="code" href="structStunAddress4.html">StunAddress4</a> from;

      <span class="comment">// do the media relaying</span>
      <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#a5dcc784d754928455caab60d6a34f73e">relay</a>)
      {
         time_t now = time(0);
         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;MAX_MEDIA_RELAYS; ++i)
         {
            <a class="code" href="structStunMediaRelay.html">StunMediaRelay</a>* relay = &amp;info.<a class="code" href="structStunServerInfo.html#aed8568086c549986f985f02a691da173">relays</a>[i];
            <span class="keywordflow">if</span> (relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a>)
            {
               <span class="keywordflow">if</span> (FD_ISSET(relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a>, &amp;fdSet))
               {
                  <span class="keywordtype">char</span> msg[MAX_RTP_MSG_SIZE];
                  <span class="keywordtype">int</span> msgLen = <span class="keyword">sizeof</span>(msg);

                  <a class="code" href="structStunAddress4.html">StunAddress4</a> rtpFrom;
                  ok = <a class="code" href="stun__udp_8h.html#a6eef3fdbadd5e5a9de73b7be46ce5aa2" title="recive a UDP message">getMessage</a>( relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a>, msg, &amp;msgLen, &amp;rtpFrom.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, &amp;rtpFrom.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> ,verbose);
                  <span class="keywordflow">if</span> (ok)
                  {
                     <a class="code" href="stun__udp_8h.html#a784917c5dceb731fee666978078b8bc5" title="send a UDP message">sendMessage</a>(info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a>, msg, msgLen, relay-&gt;<a class="code" href="structStunMediaRelay.html#a3adead8f4ff0c1b71bee2aecfa88f641">destination</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, relay-&gt;<a class="code" href="structStunMediaRelay.html#a3adead8f4ff0c1b71bee2aecfa88f641">destination</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>, verbose);
                     relay-&gt;<a class="code" href="structStunMediaRelay.html#a16873193e181c40809e3f3f91bfb78ff">expireTime</a> = now + MEDIA_RELAY_TIMEOUT;
                     <span class="keywordflow">if</span> ( verbose ) clog &lt;&lt; <span class="stringliteral">&quot;Relay packet on &quot;</span>
                                         &lt;&lt; relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a>
                                         &lt;&lt; <span class="stringliteral">&quot; from &quot;</span> &lt;&lt; rtpFrom
                                         &lt;&lt; <span class="stringliteral">&quot; -&gt; &quot;</span> &lt;&lt; relay-&gt;<a class="code" href="structStunMediaRelay.html#a3adead8f4ff0c1b71bee2aecfa88f641">destination</a>
                                         &lt;&lt; endl;
                  }
               }
               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (now &gt; relay-&gt;<a class="code" href="structStunMediaRelay.html#a16873193e181c40809e3f3f91bfb78ff">expireTime</a>)
               {
                  <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>(relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a>);
                  relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a> = 0;
               }
            }
         }
      }


      <span class="keywordflow">if</span> (FD_ISSET(info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a>,&amp;fdSet))
      {
         <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;received on A1:P1&quot;</span> &lt;&lt; endl;
         recvAltIp = <span class="keyword">false</span>;
         recvAltPort = <span class="keyword">false</span>;
         ok = <a class="code" href="stun__udp_8h.html#a6eef3fdbadd5e5a9de73b7be46ce5aa2" title="recive a UDP message">getMessage</a>( info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a>, msg, &amp;msgLen, &amp;from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, &amp;from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>,verbose );
      }
      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FD_ISSET(info.<a class="code" href="structStunServerInfo.html#a2da8a94e9a9867e7c5d3b3e3c317120c">altPortFd</a>, &amp;fdSet))
      {
         <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;received on A1:P2&quot;</span> &lt;&lt; endl;
         recvAltIp = <span class="keyword">false</span>;
         recvAltPort = <span class="keyword">true</span>;
         ok = <a class="code" href="stun__udp_8h.html#a6eef3fdbadd5e5a9de73b7be46ce5aa2" title="recive a UDP message">getMessage</a>( info.<a class="code" href="structStunServerInfo.html#a2da8a94e9a9867e7c5d3b3e3c317120c">altPortFd</a>, msg, &amp;msgLen, &amp;from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, &amp;from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>,verbose );
      }
      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>!=<a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>) &amp;&amp; FD_ISSET(info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>,&amp;fdSet))
      {
         <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;received on A2:P1&quot;</span> &lt;&lt; endl;
         recvAltIp = <span class="keyword">true</span>;
         recvAltPort = <span class="keyword">false</span>;
         ok = <a class="code" href="stun__udp_8h.html#a6eef3fdbadd5e5a9de73b7be46ce5aa2" title="recive a UDP message">getMessage</a>( info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>, msg, &amp;msgLen, &amp;from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, &amp;from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> ,verbose);
      }
      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>!=<a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a>) &amp;&amp; FD_ISSET(info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>, &amp;fdSet))
      {
         <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;received on A2:P2&quot;</span> &lt;&lt; endl;
         recvAltIp = <span class="keyword">true</span>;
         recvAltPort = <span class="keyword">true</span>;
         ok = <a class="code" href="stun__udp_8h.html#a6eef3fdbadd5e5a9de73b7be46ce5aa2" title="recive a UDP message">getMessage</a>( info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>, msg, &amp;msgLen, &amp;from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, &amp;from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>,verbose );
      }
      <span class="keywordflow">else</span>
      {
         <span class="keywordflow">return</span> <span class="keyword">true</span>;
      }

      <span class="keywordtype">int</span> relayPort = 0;
      <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#a5dcc784d754928455caab60d6a34f73e">relay</a>)
      {
         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;MAX_MEDIA_RELAYS; ++i)
         {
            <a class="code" href="structStunMediaRelay.html">StunMediaRelay</a>* relay = &amp;info.<a class="code" href="structStunServerInfo.html#aed8568086c549986f985f02a691da173">relays</a>[i];
            <span class="keywordflow">if</span> (relay-&gt;<a class="code" href="structStunMediaRelay.html#a3adead8f4ff0c1b71bee2aecfa88f641">destination</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> == from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> &amp;&amp;
                relay-&gt;<a class="code" href="structStunMediaRelay.html#a3adead8f4ff0c1b71bee2aecfa88f641">destination</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> == from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>)
            {
               relayPort = relay-&gt;<a class="code" href="structStunMediaRelay.html#a18c86cb9d0058de5ab6b5adf449a275b">relayPort</a>;
               relay-&gt;<a class="code" href="structStunMediaRelay.html#a16873193e181c40809e3f3f91bfb78ff">expireTime</a> = time(0) + MEDIA_RELAY_TIMEOUT;
               <span class="keywordflow">break</span>;
            }
         }

         <span class="keywordflow">if</span> (relayPort == 0)
         {
            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;MAX_MEDIA_RELAYS; ++i)
            {
               <a class="code" href="structStunMediaRelay.html">StunMediaRelay</a>* relay = &amp;info.<a class="code" href="structStunServerInfo.html#aed8568086c549986f985f02a691da173">relays</a>[i];
               <span class="keywordflow">if</span> (relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a> == 0)
               {
                  <span class="keywordflow">if</span> ( verbose ) clog &lt;&lt; <span class="stringliteral">&quot;Open relay port &quot;</span> &lt;&lt; relay-&gt;<a class="code" href="structStunMediaRelay.html#a18c86cb9d0058de5ab6b5adf449a275b">relayPort</a> &lt;&lt; endl;

                  relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a> = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>(relay-&gt;<a class="code" href="structStunMediaRelay.html#a18c86cb9d0058de5ab6b5adf449a275b">relayPort</a>, info.<a class="code" href="structStunServerInfo.html#a9abf6e6b89123dd6d7a71bba5a0b77d6">myAddr</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, verbose);
                  relay-&gt;<a class="code" href="structStunMediaRelay.html#a3adead8f4ff0c1b71bee2aecfa88f641">destination</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
                  relay-&gt;<a class="code" href="structStunMediaRelay.html#a3adead8f4ff0c1b71bee2aecfa88f641">destination</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;
                  relay-&gt;<a class="code" href="structStunMediaRelay.html#a16873193e181c40809e3f3f91bfb78ff">expireTime</a> = time(0) + MEDIA_RELAY_TIMEOUT;
                  relayPort = relay-&gt;<a class="code" href="structStunMediaRelay.html#a18c86cb9d0058de5ab6b5adf449a275b">relayPort</a>;
                  <span class="keywordflow">break</span>;
               }
            }
         }
      }

      <span class="keywordflow">if</span> ( !ok )
      {
         <span class="keywordflow">if</span> ( verbose ) clog &lt;&lt; <span class="stringliteral">&quot;Get message did not return a valid message&quot;</span> &lt;&lt;endl;
         <span class="keywordflow">return</span> <span class="keyword">true</span>;
      }

      <span class="keywordflow">if</span> ( verbose ) clog &lt;&lt; <span class="stringliteral">&quot;Got a request (len=&quot;</span> &lt;&lt; msgLen &lt;&lt; <span class="stringliteral">&quot;) from &quot;</span> &lt;&lt; from &lt;&lt; endl;

      <span class="keywordflow">if</span> ( msgLen &lt;= 0 )
      {
         <span class="keywordflow">return</span> <span class="keyword">true</span>;
      }

      <span class="keywordtype">bool</span> changePort = <span class="keyword">false</span>;
      <span class="keywordtype">bool</span> changeIp = <span class="keyword">false</span>;

      <a class="code" href="structStunMessage.html">StunMessage</a> resp;
      <a class="code" href="structStunAddress4.html">StunAddress4</a> dest;
      <a class="code" href="structStunAtrString.html">StunAtrString</a> hmacPassword;
      hmacPassword.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = 0;

      <a class="code" href="structStunAddress4.html">StunAddress4</a> secondary;
      secondary.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = 0;
      secondary.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = 0;

      <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#a5dcc784d754928455caab60d6a34f73e">relay</a> &amp;&amp; relayPort)
      {
         secondary = from;

         from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = info.<a class="code" href="structStunServerInfo.html#a9abf6e6b89123dd6d7a71bba5a0b77d6">myAddr</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
         from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = relayPort;
      }

      ok = <a class="code" href="stun_8cc.html#a811b0bd40524a040d7ec6676e9635c22">stunServerProcessMsg</a>( msg, msgLen, from, secondary,
                                 recvAltIp ? info.<a class="code" href="structStunServerInfo.html#ac6295f141e0926994747bbc198a19d55">altAddr</a> : info.<a class="code" href="structStunServerInfo.html#a9abf6e6b89123dd6d7a71bba5a0b77d6">myAddr</a>,
                                 recvAltIp ? info.<a class="code" href="structStunServerInfo.html#a9abf6e6b89123dd6d7a71bba5a0b77d6">myAddr</a> : info.<a class="code" href="structStunServerInfo.html#ac6295f141e0926994747bbc198a19d55">altAddr</a>,
                                 &amp;resp,
                                 &amp;dest,
                                 &amp;hmacPassword,
                                 &amp;changePort,
                                 &amp;changeIp,
                                 verbose );

      <span class="keywordflow">if</span> ( !ok )
      {
         <span class="keywordflow">if</span> ( verbose ) clog &lt;&lt; <span class="stringliteral">&quot;Failed to parse message&quot;</span> &lt;&lt; endl;
         <span class="keywordflow">return</span> <span class="keyword">true</span>;
      }

      <span class="keywordtype">char</span> buf[STUN_MAX_MESSAGE_SIZE];
      <span class="keywordtype">int</span> len = <span class="keyword">sizeof</span>(buf);

      len = <a class="code" href="stun_8cc.html#a4f9e869279d41bbf1785d321b4360f61">stunEncodeMessage</a>( resp, buf, len, hmacPassword,verbose );

      <span class="keywordflow">if</span> ( dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> == 0 )  ok=<span class="keyword">false</span>;
      <span class="keywordflow">if</span> ( dest.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> == 0 ) ok=<span class="keyword">false</span>;

      <span class="keywordflow">if</span> ( ok )
      {
         assert( dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> != 0 );
         assert( dest.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 );

         <a class="code" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> sendFd;

         <span class="keywordtype">bool</span> sendAltIp   = recvAltIp;   <span class="comment">// send on the received IP address</span>
         <span class="keywordtype">bool</span> sendAltPort = recvAltPort; <span class="comment">// send on the received port</span>

         <span class="keywordflow">if</span> ( changeIp )   sendAltIp   = !sendAltIp;   <span class="comment">// if need to change IP, then flip logic</span>
         <span class="keywordflow">if</span> ( changePort ) sendAltPort = !sendAltPort; <span class="comment">// if need to change port, then flip logic</span>

         <span class="keywordflow">if</span> ( !sendAltPort )
         {
            <span class="keywordflow">if</span> ( !sendAltIp )
            {
               sendFd = info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a>;
            }
            <span class="keywordflow">else</span>
            {
               sendFd = info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>;
            }
         }
         <span class="keywordflow">else</span>
         {
            <span class="keywordflow">if</span> ( !sendAltIp )
            {
               sendFd = info.<a class="code" href="structStunServerInfo.html#a2da8a94e9a9867e7c5d3b3e3c317120c">altPortFd</a>;
            }
            <span class="keywordflow">else</span>
            {
               sendFd = info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>;
            }
         }

         <span class="keywordflow">if</span> ( sendFd != <a class="code" href="stun__udp_8h.html#ab095a168e3ee3fb25930ad2f03d4242b">STUN_INVALID_SOCKET</a> )
         {
            <a class="code" href="stun__udp_8h.html#a784917c5dceb731fee666978078b8bc5" title="send a UDP message">sendMessage</a>( sendFd, buf, len, dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>, dest.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>, verbose );
         }
      }
   }

   <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a811b0bd40524a040d7ec6676e9635c22"></a><!-- doxytag: member="stun.cc::stunServerProcessMsg" ref="a811b0bd40524a040d7ec6676e9635c22" args="(char *buf, unsigned int bufLen, StunAddress4 &amp;from, StunAddress4 &amp;secondary, StunAddress4 &amp;myAddr, StunAddress4 &amp;altAddr, StunMessage *resp, StunAddress4 *destination, StunAtrString *hmacPassword, bool *changePort, bool *changeIp, bool verbose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool stunServerProcessMsg </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>bufLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>from</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>secondary</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>myAddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>altAddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunMessage.html">StunMessage</a> *&nbsp;</td>
          <td class="paramname"> <em>resp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> *&nbsp;</td>
          <td class="paramname"> <em>destination</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAtrString.html">StunAtrString</a> *&nbsp;</td>
          <td class="paramname"> <em>hmacPassword</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool *&nbsp;</td>
          <td class="paramname"> <em>changePort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool *&nbsp;</td>
          <td class="paramname"> <em>changeIp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01019">1019</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01351">stunServerProcess()</a>.</p>

<p><div class="fragment"><pre class="fragment">{

   <span class="comment">// set up information for default response</span>

   memset( resp, 0 , <span class="keyword">sizeof</span>(*resp) );

   *changeIp = <span class="keyword">false</span>;
   *changePort = <span class="keyword">false</span>;

   <a class="code" href="structStunMessage.html">StunMessage</a> req;
   <span class="keywordtype">bool</span> ok = <a class="code" href="stun_8cc.html#af81c30137f26a4cb158b48aa21f4f681">stunParseMessage</a>( buf,bufLen, req, verbose);

   <span class="keywordflow">if</span> (!ok)      <span class="comment">// Complete garbage, drop it on the floor</span>
   {
      <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Request did not parse&quot;</span> &lt;&lt; endl;
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }
   <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Request parsed ok&quot;</span> &lt;&lt; endl;

   <a class="code" href="structStunAddress4.html">StunAddress4</a> mapped = req.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>;
   <a class="code" href="structStunAddress4.html">StunAddress4</a> respondTo = req.<a class="code" href="structStunMessage.html#adb06537683f153438687995e8d1783c6">responseAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>;
   <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> flags = req.<a class="code" href="structStunMessage.html#a65e5de40376764ea12d96f5b5ebe2c29">changeRequest</a>.<a class="code" href="structStunAtrChangeRequest.html#adbb006a8e7cc0637d01959c8ba985c0c">value</a>;

   <span class="keywordflow">switch</span> (req.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a7cc96e6cbb87582e56f298eb891c43e2">msgType</a>)
   {
      <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a03609184bf06df206ab09c4102428a33">SharedSecretRequestMsg</a>:
         <span class="keywordflow">if</span>(verbose) clog &lt;&lt; <span class="stringliteral">&quot;Received SharedSecretRequestMsg on udp. send error 433.&quot;</span> &lt;&lt; endl;
         <span class="comment">// !cj! - should fix so you know if this came over TLS or UDP</span>
         <a class="code" href="stun_8cc.html#a1382231021dcb9f568718d9a75087f48">stunCreateSharedSecretResponse</a>(req, from, *resp);
         <span class="comment">//stunCreateSharedSecretErrorResponse(*resp, 4, 33, &quot;this request must be over TLS&quot;);</span>
         <span class="keywordflow">return</span> <span class="keyword">true</span>;

      <span class="keywordflow">case</span> <a class="code" href="stun_8h.html#a4dfa49ebae731be7b582f0fc7b57d429">BindRequestMsg</a>:
         <span class="keywordflow">if</span> (!req.<a class="code" href="structStunMessage.html#a2a47413181e29d0de7063d4bfa6609ff">hasMessageIntegrity</a>)
         {
            <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;BindRequest does not contain MessageIntegrity&quot;</span> &lt;&lt; endl;

            <span class="keywordflow">if</span> (0) <span class="comment">// !jf! mustAuthenticate</span>
            {
               <span class="keywordflow">if</span>(verbose) clog &lt;&lt; <span class="stringliteral">&quot;Received BindRequest with no MessageIntegrity. Sending 401.&quot;</span> &lt;&lt; endl;
               <a class="code" href="stun_8cc.html#a965ceef7c244ec6895b9670acdf57930">stunCreateErrorResponse</a>(*resp, 4, 1, <span class="stringliteral">&quot;Missing MessageIntegrity&quot;</span>);
               <span class="keywordflow">return</span> <span class="keyword">true</span>;
            }
         }
         <span class="keywordflow">else</span>
         {
            <span class="keywordflow">if</span> (!req.<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a>)
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;No UserName. Send 432.&quot;</span> &lt;&lt; endl;
               <a class="code" href="stun_8cc.html#a965ceef7c244ec6895b9670acdf57930">stunCreateErrorResponse</a>(*resp, 4, 32, <span class="stringliteral">&quot;No UserName and contains MessageIntegrity&quot;</span>);
               <span class="keywordflow">return</span> <span class="keyword">true</span>;
            }
            <span class="keywordflow">else</span>
            {
               <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Validating username: &quot;</span> &lt;&lt; req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a> &lt;&lt; endl;
               <span class="comment">// !jf! could retrieve associated password from provisioning here</span>
               <span class="keywordflow">if</span> (strcmp(req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>, <span class="stringliteral">&quot;test&quot;</span>) == 0)
               {
                  <span class="keywordflow">if</span> (0)
                  {
                     <span class="comment">// !jf! if the credentials are stale</span>
                     <a class="code" href="stun_8cc.html#a965ceef7c244ec6895b9670acdf57930">stunCreateErrorResponse</a>(*resp, 4, 30, <span class="stringliteral">&quot;Stale credentials on BindRequest&quot;</span>);
                     <span class="keywordflow">return</span> <span class="keyword">true</span>;
                  }
                  <span class="keywordflow">else</span>
                  {
                     <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Validating MessageIntegrity&quot;</span> &lt;&lt; endl;
                     <span class="comment">// need access to shared secret</span>

                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> hmac[20];
<span class="preprocessor">#ifndef NOSSL</span>
<span class="preprocessor"></span>                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hmacSize=20;

                     HMAC(EVP_sha1(),
                          <span class="stringliteral">&quot;1234&quot;</span>, 4,
                          reinterpret_cast&lt;const unsigned char*&gt;(buf), bufLen-20-4,
                          hmac, &amp;hmacSize);
                     assert(hmacSize == 20);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
                     <span class="keywordflow">if</span> (memcmp(buf, hmac, 20) != 0)
                     {
                        <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;MessageIntegrity is bad. Sending &quot;</span> &lt;&lt; endl;
                        <a class="code" href="stun_8cc.html#a965ceef7c244ec6895b9670acdf57930">stunCreateErrorResponse</a>(*resp, 4, 3, <span class="stringliteral">&quot;Unknown username. Try test with password 1234&quot;</span>);
                        <span class="keywordflow">return</span> <span class="keyword">true</span>;
                     }

                     <span class="comment">// need to compute this later after message is filled in</span>
                     resp-&gt;<a class="code" href="structStunMessage.html#a2a47413181e29d0de7063d4bfa6609ff">hasMessageIntegrity</a> = <span class="keyword">true</span>;
                     assert(req.<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a>);
                     resp-&gt;<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a> = <span class="keyword">true</span>;
                     resp-&gt;<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a> = req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>; <span class="comment">// copy username in</span>
                  }
               }
               <span class="keywordflow">else</span>
               {
                  <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Invalid username: &quot;</span> &lt;&lt; req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a> &lt;&lt; <span class="stringliteral">&quot;Send 430.&quot;</span> &lt;&lt; endl;
               }
            }
         }

         <span class="comment">// TODO !jf! should check for unknown attributes here and send 420 listing the</span>
         <span class="comment">// unknown attributes.</span>

         <span class="keywordflow">if</span> ( respondTo.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> == 0 ) respondTo = from;
         <span class="keywordflow">if</span> ( mapped.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> == 0 ) mapped = from;

         *changeIp   = ( flags &amp; <a class="code" href="stun_8h.html#ad0235d173b2af6e92be9843aaa585eef">ChangeIpFlag</a> )?<span class="keyword">true</span>:<span class="keyword">false</span>;
         *changePort = ( flags &amp; <a class="code" href="stun_8h.html#a2f247c137dd06ef8971319b9a6078ef4">ChangePortFlag</a> )?<span class="keyword">true</span>:<span class="keyword">false</span>;

         <span class="keywordflow">if</span> (verbose)
         {
            clog &lt;&lt; <span class="stringliteral">&quot;Request is valid:&quot;</span> &lt;&lt; endl;
            clog &lt;&lt; <span class="stringliteral">&quot;\t flags=&quot;</span> &lt;&lt; flags &lt;&lt; endl;
            clog &lt;&lt; <span class="stringliteral">&quot;\t changeIp=&quot;</span> &lt;&lt; *changeIp &lt;&lt; endl;
            clog &lt;&lt; <span class="stringliteral">&quot;\t changePort=&quot;</span> &lt;&lt; *changePort &lt;&lt; endl;
            clog &lt;&lt; <span class="stringliteral">&quot;\t from = &quot;</span> &lt;&lt; from &lt;&lt; endl;
            clog &lt;&lt; <span class="stringliteral">&quot;\t respond to = &quot;</span> &lt;&lt; respondTo &lt;&lt; endl;
            clog &lt;&lt; <span class="stringliteral">&quot;\t mapped = &quot;</span> &lt;&lt; mapped &lt;&lt; endl;
         }

         <span class="comment">// form the outgoing message</span>
         resp-&gt;<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a7cc96e6cbb87582e56f298eb891c43e2">msgType</a> = <a class="code" href="stun_8h.html#af0396ed8e86ae295115e3c2d42a7f1ad">BindResponseMsg</a>;
         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;16; i++ )
         {
            resp-&gt;<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[i] = req.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[i];
         }

         <span class="keywordflow">if</span> ( req.<a class="code" href="structStunMessage.html#ad2d3b64955956272841f656fe354aa18">xorOnly</a> == <span class="keyword">false</span> )
         {
            resp-&gt;<a class="code" href="structStunMessage.html#a605889708c9696c60f1284b3c486ca18">hasMappedAddress</a> = <span class="keyword">true</span>;
            resp-&gt;<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = mapped.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;
            resp-&gt;<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = mapped.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
         }

         <span class="keywordflow">if</span> (1) <span class="comment">// do xorMapped address or not</span>
         {
            resp-&gt;<a class="code" href="structStunMessage.html#a8e149870681eebee0a55b0f630c89471">hasXorMappedAddress</a> = <span class="keyword">true</span>;
            <a class="code" href="stun_8h.html#accc14a7c843716dfed734f3a03e8d2b6">UInt16</a> id16 = req.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[0]&lt;&lt;8
               | req.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[1];
            <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> id32 = req.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[0]&lt;&lt;24
               | req.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[1]&lt;&lt;16
               | req.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[2]&lt;&lt;8
               | req.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a>.<a class="code" href="structUInt128.html#ad6062a8c4f066ea23ad6f42608eee6ea">octet</a>[3];
            resp-&gt;<a class="code" href="structStunMessage.html#a2ef5db0ff5bd395800262b8b9d49b6bb">xorMappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = mapped.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>^id16;
            resp-&gt;<a class="code" href="structStunMessage.html#a2ef5db0ff5bd395800262b8b9d49b6bb">xorMappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = mapped.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>^id32;
         }

         resp-&gt;<a class="code" href="structStunMessage.html#a5feb7431931118218d78642c4a7c83db">hasSourceAddress</a> = <span class="keyword">true</span>;
         resp-&gt;<a class="code" href="structStunMessage.html#ab7203fc2e5a8b1248c9e14ce6e6ec313">sourceAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = (*changePort) ? altAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> : myAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;
         resp-&gt;<a class="code" href="structStunMessage.html#ab7203fc2e5a8b1248c9e14ce6e6ec313">sourceAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = (*changeIp)   ? altAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> : myAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;

         resp-&gt;<a class="code" href="structStunMessage.html#a4d3036e012cce04e6be670898f4e24eb">hasChangedAddress</a> = <span class="keyword">true</span>;
         resp-&gt;<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = altAddr.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;
         resp-&gt;<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = altAddr.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;

         <span class="keywordflow">if</span> ( secondary.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 )
         {
            resp-&gt;<a class="code" href="structStunMessage.html#ace894f36510487ec8151609513974eba">hasSecondaryAddress</a> = <span class="keyword">true</span>;
            resp-&gt;<a class="code" href="structStunMessage.html#a8fc16bd394228aa6fa6e1f5f98c356c1">secondaryAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = secondary.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;
            resp-&gt;<a class="code" href="structStunMessage.html#a8fc16bd394228aa6fa6e1f5f98c356c1">secondaryAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = secondary.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
         }

         <span class="keywordflow">if</span> ( req.<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a> &amp;&amp; req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> &gt; 0 )
         {
            <span class="comment">// copy username in</span>
            resp-&gt;<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a> = <span class="keyword">true</span>;
            assert( req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> % 4 == 0 );
            assert( req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> &lt; <a class="code" href="stun_8h.html#ac4d86797b42c1696b7acbd715481c0b1">STUN_MAX_STRING</a> );
            memcpy( resp-&gt;<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>, req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>, req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> );
            resp-&gt;<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a>;
         }

         <span class="keywordflow">if</span> (1) <span class="comment">// add ServerName</span>
         {
            resp-&gt;<a class="code" href="structStunMessage.html#afcf544b5b0663edad215525b8bcd67df">hasServerName</a> = <span class="keyword">true</span>;
            <span class="keyword">const</span> <span class="keywordtype">char</span> serverName[] = <span class="stringliteral">&quot;Vovida.org &quot;</span> STUN_VERSION; <span class="comment">// must pad to mult of 4</span>

            assert( <span class="keyword">sizeof</span>(serverName) &lt; <a class="code" href="stun_8h.html#ac4d86797b42c1696b7acbd715481c0b1">STUN_MAX_STRING</a> );
            <span class="comment">//cerr &lt;&lt; &quot;sizeof serverName is &quot;  &lt;&lt; sizeof(serverName) &lt;&lt; endl;</span>
            assert( <span class="keyword">sizeof</span>(serverName)%4 == 0 );
            memcpy( resp-&gt;<a class="code" href="structStunMessage.html#a1998c160a79020e146957c14ae1add11">serverName</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>, serverName, <span class="keyword">sizeof</span>(serverName));
            resp-&gt;<a class="code" href="structStunMessage.html#a1998c160a79020e146957c14ae1add11">serverName</a>.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = <span class="keyword">sizeof</span>(serverName);
         }

         <span class="keywordflow">if</span> ( req.<a class="code" href="structStunMessage.html#a2a47413181e29d0de7063d4bfa6609ff">hasMessageIntegrity</a> &amp; req.<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a> )
         {
            <span class="comment">// this creates the password that will be used in the HMAC when then</span>
            <span class="comment">// messages is sent</span>
            <a class="code" href="stun_8cc.html#aa8926aedab40d08f5cff31d759415962">stunCreatePassword</a>( req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>, hmacPassword );
         }

         <span class="keywordflow">if</span> (req.<a class="code" href="structStunMessage.html#a2a22a4f1560b25fcf5247647885bab3c">hasUsername</a> &amp;&amp; (req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> &gt; 64 ) )
         {
            <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> source;
            assert( <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) == <span class="keyword">sizeof</span>(<a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a>) );

            sscanf(req.<a class="code" href="structStunMessage.html#ab5c364c8f9339a6d4f314ce3819ed1fd">username</a>.<a class="code" href="structStunAtrString.html#a609965b0f07f831423bda6aaa1b852dc">value</a>, <span class="stringliteral">&quot;%x&quot;</span>, &amp;source);
            resp-&gt;<a class="code" href="structStunMessage.html#ab88124a21ca8562a44a696ed4b39fa4f">hasReflectedFrom</a> = <span class="keyword">true</span>;
            resp-&gt;<a class="code" href="structStunMessage.html#ab80a59189b1b938698339f788417f32b">reflectedFrom</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = 0;
            resp-&gt;<a class="code" href="structStunMessage.html#ab80a59189b1b938698339f788417f32b">reflectedFrom</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = source;
         }

         destination-&gt;<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = respondTo.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;
         destination-&gt;<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = respondTo.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;

         <span class="keywordflow">return</span> <span class="keyword">true</span>;

      <span class="keywordflow">default</span>:
         <span class="keywordflow">if</span> (verbose) clog &lt;&lt; <span class="stringliteral">&quot;Unknown or unsupported request &quot;</span> &lt;&lt; endl;
         <span class="keywordflow">return</span> <span class="keyword">false</span>;
   }

   assert(0);
   <span class="keywordflow">return</span> <span class="keyword">false</span>;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9ed82a9b4b17f3f4d9bf1fd4d5b8bfd2"></a><!-- doxytag: member="stun.cc::stunStopServer" ref="a9ed82a9b4b17f3f4d9bf1fd4d5b8bfd2" args="(StunServerInfo &amp;info)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void stunStopServer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structStunServerInfo.html">StunServerInfo</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>info</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01328">1328</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l01249">stunInitServer()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a> &gt; 0) <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>(info.<a class="code" href="structStunServerInfo.html#afa85d638d48bf0598161a7e9158aba3f">myFd</a>);
   <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#a2da8a94e9a9867e7c5d3b3e3c317120c">altPortFd</a> &gt; 0) <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>(info.<a class="code" href="structStunServerInfo.html#a2da8a94e9a9867e7c5d3b3e3c317120c">altPortFd</a>);
   <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a> &gt; 0) <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>(info.<a class="code" href="structStunServerInfo.html#ac9e3ea9e1322857b20f4d21211d8ca99">altIpFd</a>);
   <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a> &gt; 0) <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>(info.<a class="code" href="structStunServerInfo.html#af14364029dec110da68c7ca855d91b2d">altIpPortFd</a>);

   <span class="keywordflow">if</span> (info.<a class="code" href="structStunServerInfo.html#a5dcc784d754928455caab60d6a34f73e">relay</a>)
   {
      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;MAX_MEDIA_RELAYS; ++i)
      {
         <a class="code" href="structStunMediaRelay.html">StunMediaRelay</a>* relay = &amp;info.<a class="code" href="structStunServerInfo.html#aed8568086c549986f985f02a691da173">relays</a>[i];
         <span class="keywordflow">if</span> (relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a>)
         {
            <a class="code" href="stun__udp_8h.html#a79746e37503e1405951088e144510b79">stunclosesocket</a>(relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a>);
            relay-&gt;<a class="code" href="structStunMediaRelay.html#aebc07662e0b3728286c6da02d29806e8">fd</a> = 0;
         }
      }
   }
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3e28deadbde134f7d00a0f35e70267c6"></a><!-- doxytag: member="stun.cc::stunTest" ref="a3e28deadbde134f7d00a0f35e70267c6" args="(StunAddress4 &amp;dest, int testNum, bool verbose, StunAddress4 *sAddr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void stunTest </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> &amp;&nbsp;</td>
          <td class="paramname"> <em>dest</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>testNum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>verbose</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structStunAddress4.html">StunAddress4</a> *&nbsp;</td>
          <td class="paramname"> <em>sAddr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l01813">1813</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   assert( dest.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> != 0 );
   assert( dest.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 );

   <span class="keywordtype">int</span> port = <a class="code" href="stun_8cc.html#ad4a19c401bea76c471959a32a19b777e" title="return a random number to use as a port">stunRandomPort</a>();
   <a class="code" href="stun_8h.html#a4cd0dc7d33ac7a69204e8429ecea0f86">UInt32</a> interfaceIp=0;
   <span class="keywordflow">if</span> (sAddr)
   {
      interfaceIp = sAddr-&gt;<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
      <span class="keywordflow">if</span> ( sAddr-&gt;<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> != 0 )
      {
        port = sAddr-&gt;<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;
      }
   }
   <a class="code" href="stun_8h.html#af9381320a2640ea84038579d8f143c01">Socket</a> myFd = <a class="code" href="stun__udp_8h.html#a44f511e14438aa519a0f367a84de4000" title="Open a UDP socket to receive on the given port - if port is 0, pick a a port, if interfaceIp!=0 then ...">openPort</a>(port,interfaceIp,verbose);

   <a class="code" href="structStunAtrString.html">StunAtrString</a> username;
   <a class="code" href="structStunAtrString.html">StunAtrString</a> password;

   username.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = 0;
   password.<a class="code" href="structStunAtrString.html#aa1e288247a4ae07b170ecf956bdd48c9">sizeValue</a> = 0;

<span class="preprocessor">#ifdef USE_TLS</span>
<span class="preprocessor"></span>   <a class="code" href="stun_8cc.html#ae9317a5a127d1281953d961bcfbd2496">stunGetUserNameAndPassword</a>( dest, username, password );
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
   <a class="code" href="stun_8cc.html#ab17bbe96f9bef6d767fbee081ca123d7">stunSendTest</a>( myFd, dest, username, password, testNum, verbose );

   <span class="keywordtype">char</span> msg[STUN_MAX_MESSAGE_SIZE];
   <span class="keywordtype">int</span> msgLen = STUN_MAX_MESSAGE_SIZE;

   <a class="code" href="structStunAddress4.html">StunAddress4</a> from;
   <a class="code" href="stun__udp_8h.html#a6eef3fdbadd5e5a9de73b7be46ce5aa2" title="recive a UDP message">getMessage</a>( myFd,
               msg,
               &amp;msgLen,
               &amp;from.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>,
               &amp;from.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>,verbose );

   <a class="code" href="structStunMessage.html">StunMessage</a> resp;
   memset(&amp;resp, 0, <span class="keyword">sizeof</span>(<a class="code" href="structStunMessage.html">StunMessage</a>));

   <span class="keywordflow">if</span> ( verbose ) clog &lt;&lt; <span class="stringliteral">&quot;Got a response&quot;</span> &lt;&lt; endl;
   <span class="keywordtype">bool</span> ok = <a class="code" href="stun_8cc.html#af81c30137f26a4cb158b48aa21f4f681">stunParseMessage</a>( msg,msgLen, resp,verbose );

   <span class="keywordflow">if</span> ( verbose )
   {
      clog &lt;&lt; <span class="stringliteral">&quot;\t ok=&quot;</span> &lt;&lt; ok &lt;&lt; endl;
      clog &lt;&lt; <span class="stringliteral">&quot;\t id=&quot;</span> &lt;&lt; resp.<a class="code" href="structStunMessage.html#a4928bac8dd595927e7ebab4610f316f6">msgHdr</a>.<a class="code" href="structStunMsgHdr.html#a97a1d0da450500ddc5a6fad924e50c87">id</a> &lt;&lt; endl;
      clog &lt;&lt; <span class="stringliteral">&quot;\t mappedAddr=&quot;</span> &lt;&lt; resp.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
      clog &lt;&lt; <span class="stringliteral">&quot;\t changedAddr=&quot;</span> &lt;&lt; resp.<a class="code" href="structStunMessage.html#ac240bd9424c010b74411679f1813a705">changedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a> &lt;&lt; endl;
      clog &lt;&lt; endl;
   }

   <span class="keywordflow">if</span> (sAddr)
   {
      sAddr-&gt;<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a> = resp.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a182b25091f39b6f1d9904a02bcbeb43b">port</a>;
      sAddr-&gt;<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a> = resp.<a class="code" href="structStunMessage.html#a7c354e1ca2aae9d180c98e6b12ba879c">mappedAddress</a>.<a class="code" href="structStunAtrAddress4.html#a80b81fdc81e96531c1fecd5b9b5125c4">ipv4</a>.<a class="code" href="structStunAddress4.html#a870846bf1b2de80c031948f0795e24c6">addr</a>;
   }
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2c6016ed098c5abccd8fd044c02fb6dc"></a><!-- doxytag: member="stun.cc::toHex" ref="a2c6016ed098c5abccd8fd044c02fb6dc" args="(const char *buffer, int bufferSize, char *output)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void toHex </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>bufferSize</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>output</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="stun_8cc_source.html#l00744">744</a> of file <a class="el" href="stun_8cc_source.html">stun.cc</a>.</p>

<p>Referenced by <a class="el" href="stun_8cc_source.html#l00802">stunCreatePassword()</a>, and <a class="el" href="stun_8cc_source.html#l00764">stunCreateUserName()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
   <span class="keyword">static</span> <span class="keywordtype">char</span> hexmap[] = <span class="stringliteral">&quot;0123456789abcdef&quot;</span>;

   <span class="keyword">const</span> <span class="keywordtype">char</span>* p = buffer;
   <span class="keywordtype">char</span>* r = output;
   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; bufferSize; i++)
   {
      <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> temp = *p++;

      <span class="keywordtype">int</span> hi = (temp &amp; 0xf0)&gt;&gt;4;
      <span class="keywordtype">int</span> low = (temp &amp; 0xf);

      *r++ = hexmap[hi];
      *r++ = hexmap[low];
   }
   *r = 0;
}
</pre></div></p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 3 2010 14:40:46 for OverSim by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
